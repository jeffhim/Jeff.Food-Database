<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ç‡Ÿé¤Šè³‡æ–™åº«</title>
<meta name="application-name" content="ç‡Ÿé¤Šè³‡æ–™åº«">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ç‡Ÿé¤Šè³‡æ–™åº«">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#166534">
<meta name="description" content="å€‹äººç‡Ÿé¤Šè³‡æ–™åº« - è¨˜éŒ„å’Œç®¡ç†é£Ÿç‰©ç‡Ÿé¤Šè³‡è¨Š">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
:root{--bg-primary:#f0f2f5;--bg-secondary:#ffffff;--bg-card:#ffffff;--text-primary:#1a1a2e;--text-secondary:#6b7280;--text-muted:#9ca3af;--accent:#22c55e;--accent-dark:#16a34a;--header-gradient:linear-gradient(135deg,#166534 0%,#15803d 50%,#22c55e 100%);--divider:rgba(0,0,0,0.06);--card-shadow:0 2px 8px rgba(0,0,0,0.06);--pill-bg:#e5e7eb;--pill-active:#22c55e;--search-bg:rgba(255,255,255,0.15);--cal-color:#a855f7;--protein-color:#eab308;--fat-color:#f97316;--carbs-color:#06b6d4;--sodium-color:#ec4899;--calcium-color:#22c55e;}
.dark{--bg-primary:#0f0f1a;--bg-secondary:#1a1a2e;--bg-card:#252542;--text-primary:#ffffff;--text-secondary:#9ca3af;--text-muted:#6b7280;--divider:rgba(255,255,255,0.08);--card-shadow:0 4px 12px rgba(0,0,0,0.3);--pill-bg:#374151;--search-bg:rgba(255,255,255,0.1);}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{min-height:100%;overflow-x:hidden;}
body{font-family:'Noto Sans HK',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100%;min-height:100dvh;padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);}
@media all and (display-mode:standalone){.header{padding-top:calc(16px + env(safe-area-inset-top));}
.fab{bottom:calc(30px + env(safe-area-inset-bottom));}
.modal{padding-bottom:env(safe-area-inset-bottom);}
}
.header{background:var(--header-gradient);padding:16px 20px 20px;position:sticky;top:0;z-index:100;}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.header-left{display:flex;align-items:center;gap:12px;}
.header-icon{width:44px;height:44px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;}
.header-icon i{font-size:22px;color:white;}
.header-title-group{display:flex;flex-direction:column;}
.header-title{font-size:20px;font-weight:700;color:white;}
.header-subtitle{font-size:12px;color:rgba(255,255,255,0.8);font-weight:400;}
.header-actions{display:flex;gap:8px;}
.header-btn{width:40px;height:40px;background:rgba(255,255,255,0.2);border:none;border-radius:10px;color:white;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s;}
.header-btn:hover{background:rgba(255,255,255,0.3);}
.search-bar{display:flex;align-items:center;background:var(--search-bg);border-radius:12px;padding:12px 16px;gap:10px;backdrop-filter:blur(10px);}
.search-bar i{color:rgba(255,255,255,0.7);font-size:16px;}
.search-bar input{flex:1;border:none;background:transparent;font-size:16px;color:white;outline:none;font-family:inherit;}
.search-bar input::placeholder{color:rgba(255,255,255,0.6);}
.main-content{padding:16px;padding-bottom:100px;}
.category-pills{display:flex;gap:10px;overflow-x:auto;padding:4px 0 20px 0;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.category-pills::-webkit-scrollbar{display:none;}
.category-pill{flex-shrink:0;padding:10px 18px;border-radius:25px;background:var(--pill-bg);color:var(--text-secondary);font-size:14px;font-weight:500;border:none;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px;}
.category-pill.active{background:var(--pill-active);color:white;}
.category-pill:hover{transform:scale(1.02);}
.category-pill .emoji{font-size:16px;}
.food-list{display:flex;flex-direction:column;gap:16px;}
.food-card{background:var(--bg-card);border-radius:20px;padding:20px;box-shadow:var(--card-shadow);animation:slideIn 0.3s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(10px);}
to{opacity:1;transform:translateY(0);}
}
.food-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;}
.food-name{font-size:20px;font-weight:700;color:var(--text-primary);margin-bottom:8px;}
.food-meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.food-category-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(234,179,8,0.15);color:#ca8a04;padding:6px 12px;border-radius:20px;font-size:13px;font-weight:500;}
.dark .food-category-tag{background:rgba(234,179,8,0.2);color:#fbbf24;}
.food-serving-tag{display:inline-flex;align-items:center;gap:5px;color:var(--text-secondary);font-size:13px;}
.food-serving-tag i{font-size:11px;}
.food-card-actions{display:flex;gap:8px;}
.action-icon-btn{width:36px;height:36px;border:none;background:transparent;color:var(--text-muted);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all 0.2s;}
.action-icon-btn:hover{background:var(--bg-primary);color:var(--text-secondary);}
.action-icon-btn.delete:hover{color:#ef4444;}
.nutrition-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px;cursor:pointer;transition:transform 0.15s ease;}
.nutrition-grid:active{transform:scale(0.98);}
.nutrition-mode-tag{display:inline-flex;align-items:center;gap:5px;color:var(--text-secondary);font-size:13px;background:rgba(34,197,94,0.15);padding:4px 10px;border-radius:12px;transition:all 0.2s;}
.dark .nutrition-mode-tag{background:rgba(34,197,94,0.2);}
.nutrition-mode-tag i{font-size:11px;color:var(--accent);}
.nutrition-mode-tag.per100g{background:rgba(168,85,247,0.15);}
.dark .nutrition-mode-tag.per100g{background:rgba(168,85,247,0.2);}
.nutrition-mode-tag.per100g i{color:var(--cal-color);}
.nutrition-mode-tag.perserving{background:rgba(59,130,246,0.15);}
.dark .nutrition-mode-tag.perserving{background:rgba(59,130,246,0.2);}
.nutrition-mode-tag.perserving i{color:#3b82f6;}
.nutrition-box{background:var(--bg-primary);border-radius:12px;padding:12px 16px;min-width:70px;text-align:center;}
.nutrition-value{font-size:18px;font-weight:700;margin-bottom:2px;}
.nutrition-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.3px;}
.nutrition-box.cal .nutrition-value{color:var(--cal-color);}
.nutrition-box.protein .nutrition-value{color:var(--protein-color);}
.nutrition-box.fat .nutrition-value{color:var(--fat-color);}
.nutrition-box.carbs .nutrition-value{color:var(--carbs-color);}
.nutrition-box.sodium .nutrition-value{color:var(--sodium-color);}
.nutrition-box.calcium .nutrition-value{color:var(--calcium-color);}
.food-footer{margin-top:16px;padding-top:12px;border-top:1px solid var(--divider);display:flex;align-items:center;gap:8px;color:var(--text-muted);font-size:12px;}
.food-footer i{font-size:14px;}
.fab{position:fixed;bottom:30px;right:20px;width:60px;height:60px;border-radius:50%;background:var(--accent);color:white;border:none;box-shadow:0 6px 20px rgba(34,197,94,0.4);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:26px;z-index:99;transition:all 0.2s ease;}
.fab:hover{transform:scale(1.08);box-shadow:0 8px 25px rgba(34,197,94,0.5);}
.fab:active{transform:scale(0.95);}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:200;animation:fadeIn 0.2s ease;}
.modal-overlay.active{display:flex;align-items:flex-end;justify-content:center;}
@keyframes fadeIn{from{opacity:0;}
to{opacity:1;}
}
.modal{background:var(--bg-secondary);border-radius:24px 24px 0 0;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;animation:slideUp 0.3s ease;}
@keyframes slideUp{from{transform:translateY(100%);}
to{transform:translateY(0);}
}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--divider);position:sticky;top:0;background:var(--bg-secondary);z-index:10;}
.modal-title{font-size:18px;font-weight:700;}
.modal-close{background:var(--bg-primary);border:none;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary);font-size:14px;}
.modal-body{padding:24px;}
.form-group{margin-bottom:18px;}
.form-label{display:block;font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:8px;}
.form-input{width:100%;padding:14px 16px;border:2px solid var(--divider);border-radius:14px;font-size:16px;background:var(--bg-primary);color:var(--text-primary);outline:none;font-family:inherit;transition:border-color 0.2s;}
.form-input:focus{border-color:var(--accent);}
.form-select{width:100%;padding:14px 16px;border:2px solid var(--divider);border-radius:14px;font-size:16px;background:var(--bg-primary);color:var(--text-primary);outline:none;font-family:inherit;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-section-title{font-size:14px;font-weight:700;color:var(--text-primary);margin:24px 0 14px 0;padding-bottom:10px;border-bottom:2px solid var(--divider);}
.input-mode-toggle{display:flex;gap:0;background:var(--bg-primary);border-radius:12px;padding:4px;margin-bottom:16px;}
.input-mode-btn{flex:1;padding:12px 16px;border:none;background:transparent;color:var(--text-secondary);font-size:14px;font-weight:600;cursor:pointer;border-radius:10px;transition:all 0.2s;font-family:inherit;}
.input-mode-btn.active{background:var(--accent);color:white;}
.input-mode-btn:not(.active):hover{background:var(--divider);}
.serving-weight-group{transition:opacity 0.2s,max-height 0.3s;overflow:hidden;}
.serving-weight-group.hidden{opacity:0.4;pointer-events:none;}
.scan-label-btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:14px 16px;background:linear-gradient(135deg,#8b5cf6 0%,#a855f7 100%);color:white;border:none;border-radius:14px;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:20px;transition:all 0.2s;font-family:inherit;}
.scan-label-btn:hover{transform:translateY(-1px);box-shadow:0 4px 15px rgba(139,92,246,0.4);}
.scan-label-btn:active{transform:scale(0.98);}
.scan-label-btn i{font-size:18px;}
.scan-label-btn.scanning{background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);pointer-events:none;}
.scan-label-btn.scanning i{animation:spin 1s linear infinite;}
@keyframes spin{from{transform:rotate(0deg);}
to{transform:rotate(360deg);}
}
.scan-preview{display:none;margin-bottom:16px;border-radius:12px;overflow:hidden;position:relative;}
.scan-preview.show{display:block;}
.scan-preview img{width:100%;max-height:200px;object-fit:cover;display:block;}
.scan-preview-remove{position:absolute;top:8px;right:8px;width:28px;height:28px;background:rgba(0,0,0,0.6);color:white;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;}
.scan-status{text-align:center;padding:12px;background:var(--bg-primary);border-radius:10px;margin-bottom:16px;font-size:14px;color:var(--text-secondary);display:none;}
.scan-status.show{display:block;}
.scan-status.success{background:rgba(34,197,94,0.15);color:var(--accent);}
.scan-status.error{background:rgba(239,68,68,0.15);color:#ef4444;}
.cloud-sync-section{background:var(--bg-card);border-radius:16px;padding:20px;margin-bottom:20px;}
.cloud-sync-title{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.cloud-sync-title i{color:var(--accent);}
.cloud-url-input{width:100%;padding:14px 16px;border:2px solid var(--divider);border-radius:12px;font-size:14px;background:var(--bg-primary);color:var(--text-primary);outline:none;font-family:inherit;margin-bottom:12px;}
.cloud-url-input:focus{border-color:var(--accent);}
.cloud-btn-row{display:flex;gap:10px;margin-bottom:12px;}
.cloud-btn{flex:1;padding:14px 16px;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;font-family:inherit;transition:all 0.2s;}
.cloud-btn.upload{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:white;}
.cloud-btn.download{background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%);color:white;}
.cloud-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.2);}
.cloud-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
.cloud-btn.loading i{animation:spin 1s linear infinite;}
.cloud-status{text-align:center;padding:10px;border-radius:10px;font-size:13px;margin-bottom:12px;display:none;}
.cloud-status.show{display:block;}
.cloud-status.success{background:rgba(34,197,94,0.15);color:var(--accent);}
.cloud-status.error{background:rgba(239,68,68,0.15);color:#ef4444;}
.cloud-status.info{background:rgba(59,130,246,0.15);color:#3b82f6;}
.cloud-help{font-size:12px;color:var(--text-muted);line-height:1.6;padding:12px;background:var(--bg-primary);border-radius:10px;}
.cloud-help a{color:var(--accent);text-decoration:none;}
.cloud-help code{background:var(--divider);padding:2px 6px;border-radius:4px;font-size:11px;}
.submit-btn{width:100%;padding:16px;background:var(--accent);color:white;border:none;border-radius:14px;font-size:17px;font-weight:700;cursor:pointer;transition:all 0.2s;font-family:inherit;margin-top:12px;}
.submit-btn:hover{background:var(--accent-dark);}
.empty-state{text-align:center;padding:60px 20px;}
.empty-state i{font-size:64px;color:var(--text-muted);margin-bottom:16px;}
.empty-state h3{font-size:20px;font-weight:600;margin-bottom:8px;}
.empty-state p{color:var(--text-secondary);font-size:15px;}
.confirm-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-card);border-radius:20px;padding:28px;width:90%;max-width:340px;text-align:center;z-index:300;box-shadow:0 20px 50px rgba(0,0,0,0.3);}
.confirm-modal h3{font-size:18px;font-weight:700;margin-bottom:10px;}
.confirm-modal p{font-size:14px;color:var(--text-secondary);margin-bottom:24px;line-height:1.5;}
.confirm-buttons{display:flex;gap:12px;}
.confirm-btn{flex:1;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit;}
.confirm-btn.cancel{background:var(--bg-primary);color:var(--text-primary);}
.confirm-btn.danger{background:#ef4444;color:white;}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--text-primary);color:var(--bg-primary);padding:14px 28px;border-radius:12px;font-size:14px;font-weight:600;z-index:400;transition:transform 0.3s ease;box-shadow:0 8px 30px rgba(0,0,0,0.3);}
.toast.show{transform:translateX(-50%) translateY(0);}
.page{display:none;}
.page.active{display:block;}
.settings-section{background:var(--bg-card);border-radius:16px;overflow:hidden;margin-bottom:20px;}
.settings-header{font-size:13px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;padding:16px 16px 8px 16px;}
.settings-item{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--divider);cursor:pointer;transition:background 0.2s;}
.settings-item:last-child{border-bottom:none;}
.settings-item:hover{background:var(--bg-primary);}
.settings-item-left{display:flex;align-items:center;gap:12px;}
.settings-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-size:14px;}
.settings-icon.blue{background:#3b82f6;}
.settings-icon.green{background:#22c55e;}
.settings-icon.orange{background:#f97316;}
.settings-icon.red{background:#ef4444;}
.settings-label{font-size:16px;}
.settings-arrow{color:var(--text-muted);}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;}
.stat-card{background:var(--bg-card);border-radius:16px;padding:20px;text-align:center;box-shadow:var(--card-shadow);}
.stat-value{font-size:32px;font-weight:700;color:var(--accent);}
.stat-label{font-size:13px;color:var(--text-secondary);margin-top:4px;}
.category-list{background:var(--bg-card);border-radius:16px;overflow:hidden;}
.category-item{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--divider);}
.category-item:last-child{border-bottom:none;}
.category-item-name{font-size:16px;}
.category-item-count{font-size:14px;color:var(--text-secondary);}
.category-delete-btn{background:none;border:none;color:#ef4444;cursor:pointer;padding:8px;font-size:16px;}
.category-edit-btn{background:none;border:none;color:var(--primary);cursor:pointer;padding:8px;font-size:16px;}
.category-actions{display:flex;gap:4px;}
.add-category-row{display:flex;gap:8px;padding:12px 16px;background:var(--bg-primary);border-radius:0 0 16px 16px;}
.add-category-input{flex:1;padding:12px 14px;border:2px solid var(--divider);border-radius:12px;font-size:16px;background:var(--bg-card);color:var(--text-primary);outline:none;font-family:inherit;}
.add-category-btn{padding:12px 20px;background:var(--accent);color:white;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;}
.hidden-input{display:none;}
.dropdown-menu{display:none;position:absolute;top:100%;right:0;background:var(--bg-card);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);min-width:180px;z-index:150;overflow:hidden;margin-top:8px;}
.dropdown-menu.show{display:block;}
.dropdown-item{display:flex;align-items:center;gap:12px;padding:14px 16px;color:var(--text-primary);font-size:15px;cursor:pointer;transition:background 0.2s;border:none;background:none;width:100%;text-align:left;font-family:inherit;}
.dropdown-item:hover{background:var(--bg-primary);}
.dropdown-item i{width:20px;color:var(--text-secondary);}
.dropdown-item.danger{color:#ef4444;}
.dropdown-item.danger i{color:#ef4444;}
.header-menu-container{position:relative;}
.doc-list{display:flex;flex-direction:column;gap:12px;}
.doc-card{background:var(--bg-card);border-radius:16px;padding:16px 18px;box-shadow:var(--card-shadow);cursor:pointer;transition:transform 0.15s ease;}
.doc-card:active{transform:scale(0.98);}
.doc-card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
.doc-card-title{font-size:17px;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:8px;}
.doc-card-title i{color:#3b82f6;font-size:15px;}
.doc-card-meta{font-size:12px;color:var(--text-muted);display:flex;align-items:center;gap:6px;margin-bottom:6px;}
.doc-card-tags{display:flex;flex-wrap:wrap;gap:6px;}
.doc-card-tag{font-size:11px;padding:3px 8px;border-radius:8px;background:var(--bg-primary);color:var(--text-secondary);}
.doc-card-tag.food{background:rgba(34,197,94,0.12);color:var(--accent);}
.doc-card-tag.nut{background:rgba(168,85,247,0.12);color:var(--cal-color);}
.doc-view-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:12px;overflow:hidden;font-size:13px;margin-top:12px;}
.doc-view-table thead th{background:var(--accent);color:white;padding:10px 8px;font-weight:600;text-align:center;white-space:nowrap;position:sticky;top:0;}
.doc-view-table thead th:first-child{text-align:left;padding-left:12px;}
.doc-view-table tbody td{padding:10px 8px;text-align:center;border-bottom:1px solid var(--divider);color:var(--text-primary);}
.doc-view-table tbody td:first-child{text-align:left;font-weight:600;padding-left:12px;white-space:nowrap;}
.doc-view-table tbody tr:last-child td{border-bottom:none;}
.doc-view-table tbody tr:nth-child(even){background:var(--bg-primary);}
.doc-view-table tbody tr.doc-total-row{background:rgba(34,197,94,0.1);font-weight:700;}
.doc-view-table tbody tr.doc-total-row td{border-top:2px solid var(--accent);}
.food-picker-list{max-height:260px;overflow-y:auto;border:2px solid var(--divider);border-radius:12px;margin-top:8px;}
.food-picker-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--divider);cursor:pointer;transition:background 0.15s;}
.food-picker-item:last-child{border-bottom:none;}
.food-picker-item:hover{background:var(--bg-primary);}
.food-picker-item.selected{background:rgba(34,197,94,0.1);}
.food-picker-item input[type=checkbox]{width:18px;height:18px;accent-color:var(--accent);}
.food-picker-item-name{flex:1;font-size:14px;}
.food-picker-item-cat{font-size:11px;color:var(--text-muted);}
.nut-picker{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.nut-picker label{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:10px;background:var(--bg-primary);cursor:pointer;font-size:13px;font-weight:500;transition:all 0.15s;border:2px solid transparent;}
.nut-picker label.checked{border-color:var(--accent);background:rgba(34,197,94,0.1);}
.nut-picker label input{display:none;}
.doc-selected-foods{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;min-height:30px;}
.doc-selected-chip{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:8px;background:rgba(34,197,94,0.12);color:var(--accent);font-size:12px;font-weight:500;}
.doc-selected-chip button{background:none;border:none;color:var(--accent);cursor:pointer;padding:0 2px;font-size:14px;line-height:1;}
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<header class="header">
<div class="header-top">
<div class="header-left">
<div class="header-icon">
<i class="fas fa-seedling"></i>
</div>
<div class="header-title-group">
<div class="header-title">ç‡Ÿé¤Šè³‡æ–™åº«</div>
<div class="header-subtitle">Nutrition Database</div>
</div>
</div>
<div class="header-actions">
<button class="header-btn" onclick="goToHomePage()" title="è¿”å›ä¸»é " id="homeBtn" style="display: none;">
<i class="fas fa-home"></i>
</button>
<button class="header-btn" onclick="exportData()" title="åŒ¯å‡ºè³‡æ–™">
<i class="fas fa-share-alt"></i>
</button>
<div class="header-menu-container">
<button class="header-btn" onclick="toggleMenu()" title="æ›´å¤šé¸é …">
<i class="fas fa-bars"></i>
</button>
<div class="dropdown-menu" id="dropdownMenu">
<button class="dropdown-item" onclick="showDocumentsPage()">
<i class="fas fa-folder-open"></i>
<span>æ¯”è¼ƒæ–‡ä»¶å¤¾</span>
</button>
<button class="dropdown-item" onclick="showAIImport()">
<i class="fas fa-robot"></i>
<span>AIæ‰¹é‡åŒ¯å…¥</span>
</button>
<button class="dropdown-item" onclick="showCategoryManager()">
<i class="fas fa-folder"></i>
<span>åˆ†é¡ç®¡ç†</span>
</button>
<button class="dropdown-item" onclick="showCloudSettings()">
<i class="fas fa-cloud"></i>
<span>é›²ç«¯åŒæ­¥è¨­å®š</span>
</button>
<button class="dropdown-item danger" onclick="confirmClearData()">
<i class="fas fa-trash"></i>
<span>æ¸…é™¤æ‰€æœ‰è³‡æ–™</span>
</button>
</div>
</div>
</div>
</div>
<div class="search-bar">
<i class="fas fa-search"></i>
<input type="text" id="searchInput" placeholder="æœå°‹é£Ÿç‰©æˆ–é£²å“...">
</div>
</header>
<main class="main-content">
<div class="page active" id="homePage">
<div class="category-pills" id="categoryPills"></div>
<div class="food-list" id="foodList"></div>
</div>
<div class="page" id="categoryPage">
<div class="stats-grid">
<div class="stat-card">
<div class="stat-value" id="totalItems">0</div>
<div class="stat-label">ç¸½é …ç›®æ•¸</div>
</div>
<div class="stat-card">
<div class="stat-value" id="totalCategories">0</div>
<div class="stat-label">åˆ†é¡æ•¸ç›®</div>
</div>
</div>
<p class="settings-header">åˆ†é¡ç®¡ç†</p>
<div class="category-list" id="categoryList"></div>
<div class="add-category-row">
<input type="text" class="add-category-input" id="newCategoryEmojiInput" placeholder="ğŸ±" style="width: 50px; text-align: center; flex: none;">
<input type="text" class="add-category-input" id="newCategoryInput" placeholder="æ–°å¢åˆ†é¡...">
<button class="add-category-btn" onclick="addCategory()">æ–°å¢</button>
</div>
<div style="margin-top: 20px;">
<button class="submit-btn" onclick="backToHome()">
<i class="fas fa-arrow-left"></i> è¿”å›ä¸»é 
</button>
</div>
</div>
<div class="page" id="cloudPage">
<div class="cloud-sync-section">
<div class="cloud-sync-title">
<i class="fas fa-cloud"></i>
Google é›²ç«¯åŒæ­¥
</div>
<div class="cloud-help" style="margin-bottom: 16px;">
<strong>ğŸ“– é›™å‘åŒæ­¥åŠŸèƒ½ï¼š</strong><br><br>
<i class="fas fa-check-circle" style="color: #22c55e;"></i> åœ¨ App æ–°å¢/ä¿®æ”¹è³‡æ–™ â†’ è‡ªå‹•ä¸Šå‚³<br>
<i class="fas fa-check-circle" style="color: #22c55e;"></i> é–‹å•Ÿ App â†’ è‡ªå‹•ä¸‹è¼‰æœ€æ–°è³‡æ–™<br>
<i class="fas fa-check-circle" style="color: #22c55e;"></i> å¤šè£ç½®åŒæ­¥
</div>
<div id="sheetSyncStatus" class="cloud-status" style="display: none;"></div>
<div id="lastSyncInfo" style="padding: 12px; background: var(--bg-primary); border-radius: 10px; margin-bottom: 16px;">
<div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 13px;">
<i class="fas fa-clock"></i>
<span>ä¸Šæ¬¡åŒæ­¥ï¼š<span id="lastSyncTime">å¾æœª</span></span>
</div>
<div id="syncModeIndicator" style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 13px; margin-top: 6px;">
<i class="fas fa-info-circle"></i>
<span>å°šæœªè¨­å®šé›²ç«¯åŒæ­¥</span>
</div>
</div>
<div style="display: flex; gap: 8px; margin-bottom: 16px;">
<button class="submit-btn" style="flex: 1;" onclick="syncFromCloud()" id="cloudDownloadBtn">
<i class="fas fa-cloud-download-alt"></i> ä¸‹è¼‰
</button>
<button class="submit-btn" style="flex: 1; background: #34a853;" onclick="syncToCloud()" id="cloudUploadBtn">
<i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³
</button>
</div>
<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--divider);">
<div class="form-section-title"><i class="fas fa-cog"></i> Google Apps Script è¨­å®š</div>
<div class="cloud-help" style="margin-bottom: 12px; font-size: 12px;">
<strong>ä¸€æ¬¡æ€§è¨­å®šæ­¥é©Ÿï¼š</strong><br>
1. <a href="#" onclick="showAppsScriptSetup(); return false;" style="color: var(--accent);">é»æ­¤æŸ¥çœ‹è©³ç´°æ•™å­¸</a><br>
2. è¤‡è£½ Apps Script ä»£ç¢¼åˆ° Google<br>
3. éƒ¨ç½²ç‚ºç¶²é æ‡‰ç”¨ç¨‹å¼<br>
4. å°‡ç¶²å€è²¼åˆ°ä¸‹æ–¹
</div>
<div class="form-group">
<label class="form-label">Google Apps Script ç¶²å€</label>
<input type="text" class="form-input" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/.../exec">
</div>
<button class="submit-btn" style="background: #34a853;" onclick="saveAppsScriptUrl()">
<i class="fas fa-save"></i> å„²å­˜ä¸¦æ¸¬è©¦é€£æ¥
</button>
<div style="margin-top: 12px;">
<label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); cursor: pointer;">
<input type="checkbox" id="autoSyncCheckbox" onchange="toggleAutoSync()" style="width: 18px; height: 18px;">
è‡ªå‹•åŒæ­¥ï¼ˆæ¯æ¬¡ä¿®æ”¹å¾Œè‡ªå‹•ä¸Šå‚³ï¼‰
</label>
</div>
</div>
<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--divider);">
<div class="form-section-title"><i class="fas fa-database"></i> æœ¬æ©Ÿè³‡æ–™ç®¡ç†</div>
<button class="submit-btn" style="background: #f59e0b; margin-bottom: 8px;" onclick="resetToDefault()">
<i class="fas fa-undo"></i> é‡ç½®ç‚ºé è¨­è³‡æ–™
</button>
<button class="submit-btn" style="background: #8b5cf6; margin-bottom: 8px;" onclick="exportLocalData()">
<i class="fas fa-download"></i> åŒ¯å‡ºæœ¬æ©Ÿè³‡æ–™ (JSON)
</button>
<button class="submit-btn" style="background: #06b6d4;" onclick="exportToCSV()">
<i class="fas fa-file-csv"></i> åŒ¯å‡ºç‚º CSV
</button>
</div>
</div>
<div style="margin-top: 20px;">
<button class="submit-btn" onclick="backToHome()">
<i class="fas fa-arrow-left"></i> è¿”å›ä¸»é 
</button>
</div>
</div>
<div class="page" id="docsPage">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
<h2 style="font-size:20px;font-weight:700;">ğŸ“‚ æ¯”è¼ƒæ–‡ä»¶å¤¾</h2>
<button class="add-category-btn" onclick="openCreateDocModal()" style="display:flex;align-items:center;gap:6px;">
<i class="fas fa-plus"></i> æ–°å»ºæ–‡ä»¶
</button>
</div>
<div class="doc-list" id="docList"></div>
<div style="margin-top:20px;">
<button class="submit-btn" onclick="goToHomePage()">
<i class="fas fa-arrow-left"></i> è¿”å›ä¸»é 
</button>
</div>
</div>
</main>
<button class="fab" id="fab" onclick="openAddModal()">
<i class="fas fa-plus"></i>
</button>
<div class="modal-overlay" id="addModal">
<div class="modal">
<div class="modal-header">
<span class="modal-title" id="modalTitle">æ–°å¢é£Ÿç‰©</span>
<button class="modal-close" onclick="closeModal()">
<i class="fas fa-times"></i>
</button>
</div>
<div class="modal-body">
<form id="foodForm">
<input type="hidden" id="editId">
<button type="button" class="scan-label-btn" id="scanLabelBtn" onclick="document.getElementById('labelImageInput').click()">
<i class="fas fa-camera"></i>
<span>æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤</span>
</button>
<input type="file" id="labelImageInput" accept="image/*" style="display:none" onchange="handleLabelImage(event)">
<div class="scan-preview" id="scanPreview">
<img id="scanPreviewImg" src="" alt="Preview">
<button type="button" class="scan-preview-remove" onclick="clearScanPreview()">
<i class="fas fa-times"></i>
</button>
</div>
<div class="scan-status" id="scanStatus"></div>
<div class="form-group">
<label class="form-label">ä¸­æ–‡åç¨±</label>
<input type="text" class="form-input" id="foodName" placeholder="ä¾‹å¦‚ï¼šè¦é¤ƒ" required>
</div>
<div class="form-group">
<label class="form-label">è‹±æ–‡åç¨± (é¸å¡«)</label>
<input type="text" class="form-input" id="foodNameEn" placeholder="e.g. Steamed prawn dumpling">
</div>
<div class="form-group">
<label class="form-label">å“ç‰Œ (é¸å¡«)</label>
<input type="text" class="form-input" id="foodBrand" placeholder="ä¾‹å¦‚ï¼šç¶­ä»–ã€å‡ºå‰ä¸€ä¸">
</div>
<div class="form-group">
<label class="form-label">åˆ†é¡</label>
<select class="form-select" id="foodCategory" required onchange="toggleNewCategoryInput()"></select>
</div>
<div class="form-group" id="newCategoryGroup" style="display: none;">
<label class="form-label">æ–°åˆ†é¡åç¨±</label>
<div style="display: flex; gap: 8px;">
<input type="text" class="form-input" id="newCategoryName" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±" style="flex: 1;">
<input type="text" class="form-input" id="newCategoryEmoji" placeholder="Emoji" style="width: 70px;">
</div>
</div>
<div class="form-group">
<label class="form-label">è³‡æ–™ä¾†æº (é¸å¡«)</label>
<select class="form-select" id="foodSource">
<option value="ç‡Ÿé¤Šæ¨™ç±¤" selected>ç‡Ÿé¤Šæ¨™ç±¤</option>
<option value="é£Ÿå®‰ä¸­å¿ƒ">é£Ÿå®‰ä¸­å¿ƒ</option>
<option value="ç‡Ÿé¤Šè³‡æ–™åº«">ç‡Ÿé¤Šè³‡æ–™åº«</option>
<option value="é¤å»³èœå–®">é¤å»³èœå–®</option>
<option value="è‡ªè¡Œä¼°è¨ˆ">è‡ªè¡Œä¼°è¨ˆ</option>
<option value="AIè­˜åˆ¥">AIè­˜åˆ¥</option>
<option value="å…¶ä»–">å…¶ä»–</option>
</select>
</div>
<div class="form-section-title">ç‡Ÿé¤Šè³‡æ–™è¼¸å…¥æ–¹å¼</div>
<div class="input-mode-toggle">
<button type="button" class="input-mode-btn active" id="inputModePer100g" onclick="setInputMode('per100g')">
æ¯ 100g
</button>
<button type="button" class="input-mode-btn" id="inputModePerServing" onclick="setInputMode('perServing')">
æ¯é£Ÿç”¨ä»½é‡
</button>
</div>
<div class="form-group" id="servingWeightGroup">
<label class="form-label" id="servingWeightLabel">æ¯ä»½é‡é‡ (g) <span style="color: var(--text-secondary);">- é¸å¡«</span></label>
<input type="number" step="0.1" class="form-input" id="servingWeight" placeholder="ä¾‹å¦‚ï¼š31ï¼ˆå¡«å¯«å¾Œå¯è‡ªå‹•è¨ˆç®—æ¯ä»½ç‡Ÿé¤Šï¼‰">
</div>
<div class="form-section-title" id="nutritionSectionTitle">ç‡Ÿé¤Šè³‡æ–™ (æ¯100g)</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">å¡è·¯é‡Œ (kcal) - é¸å¡«</label>
<input type="number" step="0.1" class="form-input" id="caloriesServing" placeholder="é¸å¡«">
</div>
<div class="form-group">
<label class="form-label">è›‹ç™½è³ª (g) - é¸å¡«</label>
<input type="number" step="0.1" class="form-input" id="proteinServing" placeholder="é¸å¡«">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">è„‚è‚ª (g) - é¸å¡«</label>
<input type="number" step="0.1" class="form-input" id="fatServing" placeholder="é¸å¡«">
</div>
<div class="form-group">
<label class="form-label">ç¢³æ°´åŒ–åˆç‰© (g) - é¸å¡«</label>
<input type="number" step="0.1" class="form-input" id="carbsServing" placeholder="é¸å¡«">
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">éˆ‰ (mg) - é¸å¡«</label>
<input type="number" step="0.1" class="form-input" id="sodiumServing" placeholder="é¸å¡«">
</div>
<div class="form-group">
<label class="form-label">éˆ£ (mg) - é¸å¡«</label>
<input type="number" step="0.1" class="form-input" id="calciumServing" placeholder="é¸å¡«">
</div>
</div>
<button type="submit" class="submit-btn" id="submitBtn">å„²å­˜</button>
</form>
</div>
</div>
</div>
<div class="modal-overlay" id="confirmModal">
<div class="confirm-modal">
<h3 id="confirmTitle">ç¢ºèªåˆªé™¤ï¼Ÿ</h3>
<p id="confirmMessage">æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
<div class="confirm-buttons">
<button class="confirm-btn cancel" onclick="closeConfirmModal()">å–æ¶ˆ</button>
<button class="confirm-btn danger" id="confirmAction">ç¢ºèª</button>
</div>
</div>
</div>
<div class="modal-overlay" id="editCategoryModal">
<div class="confirm-modal">
<h3>ç·¨è¼¯åˆ†é¡</h3>
<div style="margin: 16px 0;">
<label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">åˆ†é¡åç¨±</label>
<input type="text" id="editCategoryName" class="add-category-input" style="width: 100%; box-sizing: border-box;">
</div>
<div style="margin: 16px 0;">
<label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px;">Emoji (å¯é¸)</label>
<input type="text" id="editCategoryEmoji" class="add-category-input" style="width: 100%; box-sizing: border-box;" placeholder="ä¾‹å¦‚: ğŸ”">
</div>
<input type="hidden" id="editCategoryOriginal">
<div class="confirm-buttons">
<button class="confirm-btn cancel" onclick="closeEditCategoryModal()">å–æ¶ˆ</button>
<button class="confirm-btn" style="background: var(--primary);" onclick="saveEditCategory()">å„²å­˜</button>
</div>
</div>
</div>
<div class="modal-overlay" id="aiImportModal">
<div class="modal" style="max-width: 500px;">
<div class="modal-header">
<span class="modal-title"><i class="fas fa-robot"></i> AIæ‰¹é‡åŒ¯å…¥</span>
<button class="modal-close" onclick="closeAIImportModal()">
<i class="fas fa-times"></i>
</button>
</div>
<div class="modal-body">
<p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
ä¸Šå‚³ç‡Ÿé¤Šè¡¨æ ¼åœ–ç‰‡ï¼ŒAIæœƒè‡ªå‹•è­˜åˆ¥ä¸¦è¨ˆç®—å¹³å‡ç‡Ÿé¤Šå€¼ï¼Œç„¶å¾Œæ‰¹é‡åŠ å…¥åˆ°appä¸­ã€‚
</p>
<div class="form-group">
<label class="form-label">é¸æ“‡åˆ†é¡</label>
<select class="form-select" id="aiImportCategory"></select>
</div>
<div class="form-group">
<label class="form-label">æˆ–è¼¸å…¥æ–°åˆ†é¡åç¨±</label>
<div style="display: flex; gap: 8px;">
<input type="text" class="form-input" id="aiNewCategory" placeholder="ä¾‹å¦‚ï¼šæ—¥å¼æ–™ç†">
<input type="text" class="form-input" id="aiNewCategoryEmoji" placeholder="ğŸ±" style="width: 60px; text-align: center;">
</div>
</div>
<div class="form-group">
<label class="form-label">ç‡Ÿé¤Šè³‡æ–™æ ¼å¼</label>
<div class="input-mode-toggle">
<button type="button" class="input-mode-btn active" id="aiInputModePer100g" onclick="setAIInputMode('per100g')">
æ¯ 100g
</button>
<button type="button" class="input-mode-btn" id="aiInputModePerServing" onclick="setAIInputMode('perServing')">
æ¯é£Ÿç”¨ä»½é‡
</button>
</div>
</div>
<div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
<button type="button" class="scan-label-btn" onclick="document.getElementById('aiImportExcelInput').click()" style="flex: 1; min-width: 100px;">
<i class="fas fa-file-excel"></i>
<span>Excel/CSV</span>
</button>
<button type="button" class="scan-label-btn" onclick="document.getElementById('aiImportPdfInput').click()" style="flex: 1; min-width: 100px;">
<i class="fas fa-file-pdf"></i>
<span>PDF</span>
</button>
<button type="button" class="scan-label-btn" onclick="document.getElementById('aiImportImageInput').click()" style="flex: 1; min-width: 100px;">
<i class="fas fa-image"></i>
<span>åœ–ç‰‡</span>
</button>
<button type="button" class="scan-label-btn" onclick="toggleTextImport()" style="flex: 1; min-width: 100px;">
<i class="fas fa-paste"></i>
<span>è²¼ä¸Šæ–‡å­—</span>
</button>
</div>
<div id="textImportArea" style="display: none; margin-top: 12px;">
<textarea id="textImportInput" class="form-input" rows="8" placeholder="å°‡è¡¨æ ¼æ–‡å­—è²¼åˆ°é€™è£¡ï¼Œä¾‹å¦‚ï¼š&#10;æ˜†å¸ƒï¼ˆäºŒå…¥ï¼‰  136&#10;é«˜ç´šä¸‰æ–‡é­š  148&#10;ä¸‰æ–‡é­šä¸¼  575&#10;&#10;æˆ–è€…æ¯è¡Œæ ¼å¼ï¼š&#10;é£Ÿç‰©åç¨±  å¡è·¯é‡Œ  è›‹ç™½è³ª  è„‚è‚ª  ç¢³æ°´" style="font-size: 14px; line-height: 1.5; font-family: monospace;"></textarea>
<p style="font-size: 12px; color: var(--text-secondary); margin-top: 6px;">
ğŸ’¡ æç¤ºï¼šç”¨æ‰‹æ©Ÿç›¸æ©Ÿçš„ã€Œæ–‡å­—è¾¨è­˜ã€åŠŸèƒ½è¤‡è£½è¡¨æ ¼æ–‡å­—ï¼Œå†è²¼åˆ°é€™è£¡ï¼Œæ¯” OCR æº–ç¢ºå¾—å¤šï¼
</p>
</div>
<input type="file" id="aiImportExcelInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleExcelImport(event)">
<input type="file" id="aiImportPdfInput" accept=".pdf" style="display:none" onchange="handlePdfImport(event)">
<input type="file" id="aiImportImageInput" accept="image/*" style="display:none" onchange="handleAIImportImage(event)">
<div class="scan-preview" id="aiImportPreview" style="display: none;">
<img id="aiImportPreviewImg" src="" alt="Preview">
<button type="button" class="scan-preview-remove" onclick="clearAIImportPreview()">
<i class="fas fa-times"></i>
</button>
</div>
<div id="aiImportFileInfo" style="display: none; margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 10px;">
<div style="display: flex; align-items: center; gap: 10px;">
<i id="aiImportFileIcon" class="fas fa-file-excel" style="font-size: 24px; color: #22c55e;"></i>
<div style="flex: 1;">
<div id="aiImportFileName" style="font-weight: 600;"></div>
<div id="aiImportFileSize" style="font-size: 12px; color: var(--text-secondary);"></div>
</div>
<button type="button" onclick="clearFileImport()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px;">
<i class="fas fa-times"></i>
</button>
</div>
</div>
<div id="aiImportStatus" style="margin-top: 16px; padding: 12px; border-radius: 12px; display: none;"></div>
<div id="aiImportResults" style="margin-top: 16px; max-height: 300px; overflow-y: auto; display: none;">
<div class="form-section-title">è­˜åˆ¥çµæœé è¦½</div>
<div id="aiImportResultsList"></div>
</div>
<div style="display: flex; gap: 12px; margin-top: 20px;">
<button type="button" class="submit-btn" id="aiAnalyzeBtn" onclick="startAnalysis()" style="flex: 1; background: var(--accent);" disabled>
<i class="fas fa-wand-magic-sparkles"></i> é–‹å§‹è­˜åˆ¥
</button>
<button type="button" class="submit-btn" id="aiConfirmBtn" onclick="confirmAIImport()" style="flex: 1; display: none;">
<i class="fas fa-check"></i> ç¢ºèªåŒ¯å…¥
</button>
</div>
</div>
</div>
</div>
<input type="file" class="hidden-input" id="importInput" accept=".json" onchange="importData(event)">
<div class="modal-overlay" id="createDocModal">
<div class="modal">
<div class="modal-header">
<span class="modal-title"><i class="fas fa-file-medical"></i> æ–°å»ºæ¯”è¼ƒæ–‡ä»¶</span>
<button class="modal-close" onclick="closeCreateDocModal()"><i class="fas fa-times"></i></button>
</div>
<div class="modal-body">
<div class="form-group">
<label class="form-label">æ–‡ä»¶åç¨±</label>
<input type="text" class="form-input" id="docNameInput" placeholder="ä¾‹å¦‚ï¼šæ—©é¤é¸æ“‡æ¯”è¼ƒ">
</div>
<div class="form-group">
<label class="form-label">é¡¯ç¤ºæ¨¡å¼</label>
<div class="input-mode-toggle">
<button type="button" class="input-mode-btn active" id="docModePer100g" onclick="setDocMode('per100g')">æ¯ 100g</button>
<button type="button" class="input-mode-btn" id="docModePerServing" onclick="setDocMode('perServing')">æ¯é£Ÿç”¨ä»½é‡</button>
</div>
</div>
<div class="form-group">
<label class="form-label">é¸æ“‡ç‡Ÿé¤Šç´ </label>
<div class="nut-picker" id="nutPicker">
<label class="checked"><input type="checkbox" value="calories" checked onchange="toggleNutPick(this)">å¡è·¯é‡Œ</label>
<label class="checked"><input type="checkbox" value="protein" checked onchange="toggleNutPick(this)">è›‹ç™½è³ª</label>
<label class="checked"><input type="checkbox" value="fat" checked onchange="toggleNutPick(this)">è„‚è‚ª</label>
<label class="checked"><input type="checkbox" value="carbs" checked onchange="toggleNutPick(this)">ç¢³æ°´</label>
<label><input type="checkbox" value="sodium" onchange="toggleNutPick(this)">éˆ‰</label>
<label><input type="checkbox" value="calcium" onchange="toggleNutPick(this)">éˆ£</label>
</div>
</div>
<div class="form-group">
<label class="form-label">é¸æ“‡é£Ÿç‰©</label>
<div style="position:relative;">
<input type="text" class="form-input" id="docFoodSearch" placeholder="æœå°‹é£Ÿç‰©..." oninput="filterDocFoodList()">
</div>
<div class="doc-selected-foods" id="docSelectedFoods"></div>
<div class="food-picker-list" id="docFoodPicker"></div>
</div>
<div class="form-group">
<label class="form-label">å‚™è¨» (é¸å¡«)</label>
<input type="text" class="form-input" id="docNotesInput" placeholder="ä¾‹å¦‚ï¼šæ¸›è‚¥æœŸé–“åƒè€ƒ">
</div>
<button type="button" class="submit-btn" onclick="saveDocument()"><i class="fas fa-save"></i> å„²å­˜æ–‡ä»¶</button>
</div>
</div>
</div>
<div class="modal-overlay" id="viewDocModal">
<div class="modal">
<div class="modal-header">
<span class="modal-title" id="viewDocTitle">æ–‡ä»¶</span>
<button class="modal-close" onclick="closeViewDocModal()"><i class="fas fa-times"></i></button>
</div>
<div class="modal-body">
<div id="viewDocMeta" style="margin-bottom:12px;"></div>
<div id="viewDocTableWrap" style="overflow-x:auto;-webkit-overflow-scrolling:touch;"></div>
<div style="display:flex;gap:10px;margin-top:20px;">
<button type="button" class="submit-btn" onclick="editCurrentDoc()" style="flex:1;background:#3b82f6;"><i class="fas fa-edit"></i> ç·¨è¼¯</button>
<button type="button" class="submit-btn" onclick="deleteCurrentDoc()" style="flex:1;background:#ef4444;"><i class="fas fa-trash"></i> åˆªé™¤</button>
</div>
</div>
</div>
</div>
<script>
  const DB_NAME = 'NutritionDB';
  const DB_VERSION = 1;
  let db = null;
  let isIndexedDBAvailable = false;
  let memorySettings = {};
    function _P(req){return new Promise(function(ok,no){req.onsuccess=function(){ok(req.result)};req.onerror=no});}
function _PC(req){return new Promise(function(ok,no){req.onsuccess=ok;req.onerror=no});}
function openDatabase() {
   return new Promise((resolve, reject) => {
    if (!window.indexedDB) {
          isIndexedDBAvailable = false;
     resolve(null);
     return;
    }
    try {
     const request = indexedDB.open(DB_NAME, DB_VERSION);
     request.onerror = (e) => {
      console.log('IndexedDB open error:', e.target.error);
      isIndexedDBAvailable = false;
      resolve(null); // Don't reject, just resolve with null
     };
     request.onsuccess = () => {
      db = request.result;
      isIndexedDBAvailable = true;
      resolve(db);
     };
     request.onupgradeneeded = (event) => {
      const database = event.target.result;
      if (!database.objectStoreNames.contains('foods')) {
       database.createObjectStore('foods', { keyPath: 'id' });
      }
      if (!database.objectStoreNames.contains('categories')) {
       database.createObjectStore('categories', { keyPath: 'name' });
      }
      if (!database.objectStoreNames.contains('settings')) {
       database.createObjectStore('settings', { keyPath: 'key' });
      }
     };
    } catch (e) {
          isIndexedDBAvailable = false;
     resolve(null);
    }
   });
  }
  async function saveToIndexedDB() {
   if (!db) return;
   try {
    const tx = db.transaction(['foods', 'categories', 'settings'], 'readwrite');
    const foodStore = tx.objectStore('foods');
    const catStore = tx.objectStore('categories');
    const settingsStore = tx.objectStore('settings');
    await _PC(foodStore.clear());
    for (const food of foods) {
     foodStore.put(food);
    }
    await _PC(catStore.clear());
    for (const cat of categories) {
     catStore.put({ name: cat });
    }
    settingsStore.put({ key: 'categoryEmojis', value: JSON.parse(JSON.stringify(categoryEmojis)) });
    await new Promise(function(ok,no){tx.oncomplete=ok;tx.onerror=no});
   } catch (err) {
       }
  }
  async function loadFromIndexedDB() {
   if (!db) return false;
   try {
    const tx = db.transaction(['foods', 'categories', 'settings'], 'readonly');
    const foodStore = tx.objectStore('foods');
    const catStore = tx.objectStore('categories');
    const settingsStore = tx.objectStore('settings');
    const loadedFoods = await _P(foodStore.getAll());
    const loadedCats = await _P(catStore.getAll());
    const loadedEmojis = await _P(settingsStore.get('categoryEmojis')).catch(()=>null);
    if (loadedFoods && loadedFoods.length >= foods.length) {
     foods = loadedFoods;
    }
    if (loadedCats && loadedCats.length > 0) {
     categories = loadedCats.map(c => c.name);
    }
    if (loadedEmojis && loadedEmojis.value) {
     Object.keys(categoryEmojis).forEach(k => delete categoryEmojis[k]);
     Object.assign(categoryEmojis, loadedEmojis.value);
    }
    return true;
   } catch (err) {
        return false;
   }
  }
  if ('serviceWorker' in navigator) {
   const swCode = `
    const CACHE_NAME = 'nutrition-db-v1';
    const urlsToCache = [
     './',
     './index.html'
    ];
    self.addEventListener('install', event => {
     event.waitUntil(
      caches.open(CACHE_NAME)
       .then(cache => cache.addAll(urlsToCache))
       .then(() => self.skipWaiting())
     );
    });
    self.addEventListener('activate', event => {
     event.waitUntil(
      caches.keys().then(cacheNames => {
       return Promise.all(
        cacheNames.filter(name => name !== CACHE_NAME)
         .map(name => caches.delete(name))
       );
      }).then(() => self.clients.claim())
     );
    });
    self.addEventListener('fetch', event => {
     event.respondWith(
      caches.match(event.request)
       .then(response => {
        if (response) return response;
        return fetch(event.request).then(response => {
         if (!response || response.status !== 200) return response;
         const responseToCache = response.clone();
         caches.open(CACHE_NAME).then(cache => {
          cache.put(event.request, responseToCache);
         });
         return response;
        });
       })
     );
    });
   `;
   const blob = new Blob([swCode], { type: 'application/javascript' });
   const swUrl = URL.createObjectURL(blob);
   navigator.serviceWorker.register(swUrl, { scope: './' })
    .then(reg => console.log('SW registered'))
    .catch(err => console.log('SW registration failed:', err));
  }
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
   document.documentElement.classList.add('dark');
  }
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
   if (event.matches) {
    document.documentElement.classList.add('dark');
   } else {
    document.documentElement.classList.remove('dark');
   }
  });
  const categoryEmojis = {
   'å…¨éƒ¨': '',
   'é»å¿ƒ': 'ğŸ¥Ÿ',
   'åŒ…é»': 'ğŸ¥Ÿ',
   'å’¸è’¸é»': 'ğŸ¥¢',
   'è’¸è…¸ç²‰': 'ğŸœ',
   'ç…ç‚¸é»å¿ƒ': 'ğŸ¤',
   'ç¼èœ': 'ğŸ¥¬',
   'é£¯éºµé¡': 'ğŸš',
   'ç”œå“': 'ğŸ®',
   'å…¶ä»–': 'ğŸ“¦',
   'æ°´æœ': 'ğŸ',
   'è”¬èœ': 'ğŸ¥¬',
   'è‚‰é¡': 'ğŸ–',
   'æµ·é®®': 'ğŸ¦',
   'å°é£Ÿ': 'ğŸª',
   'éº¥ç•¶å‹': 'ğŸ”',
   'ç²¥ç²‰éºªé£¯': 'ğŸœ',
   'é£²å“': 'ğŸ§‹',
   'æ¸¯å¼å°èœ': 'ğŸ³',
   'ä¸­å¼ç´ èœ': 'ğŸ¥¬'
  };
  let categories = ['é»å¿ƒ', 'æ°´æœ', 'è”¬èœ', 'éº¥ç•¶å‹', 'ç²¥ç²‰éºªé£¯', 'é£²å“', 'æ¸¯å¼å°èœ', 'ä¸­å¼ç´ èœ', 'å…¶ä»–'];
  let currentFilter = 'å…¨éƒ¨';
  let showPer100gSet = new Set();
  let formInputMode = 'per100g';
  let aiImportInputMode = 'per100g';
  let cloudSyncUrl = '';
  const N=null;
const _F=function(d){return d.map(function(r){
var f={id:r[0],name:r[1],nameEn:r[2],category:r[3]};
var p=r[4];if(p)f.per100g={calories:p[0],protein:p[1],fat:p[2],carbs:p[3],sodium:p[4],calcium:p[5]};
var s=r[5];if(s)f.perServing={weight:s[0],calories:s[1],protein:s[2],fat:s[3],carbs:s[4],sodium:s[5],calcium:s[6]};
return f;});};
let foods = _F([
['1','å¥¶çš‡åŒ…','Steamed egg custard bun','é»å¿ƒ',[260,4.3,6.4,46,100,51],[46,120,2,3,22,47,24]],
['2','å‰ç‡’åŒ…','Steamed barbecued pork bun','é»å¿ƒ',[270,7.3,7.3,43,290,18],[56,150,4.1,4.1,24,160,9.9]],
['3','è›‹é»ƒè“®è“‰åŒ…','Steamed lotus seed paste and egg yolk bun','é»å¿ƒ',[310,5.2,8.1,55,65,33],[55,170,2.9,4.5,30,36,18]],
['4','é›åŒ…ä»”','Steamed chicken bun','é»å¿ƒ',[230,7.5,5.9,37,300,27],[52,120,3.9,3.1,19,160,14]],
['5','ç³¯ç±³å·','Steamed glutinous rice roll','é»å¿ƒ',[270,5.1,6.5,48,370,26],[96,260,4.9,6.3,47,360,25]],
['6','é¦¬æ‹‰ç³•','Mai-lai cake','é»å¿ƒ',[290,6.8,8.1,47,220,48],[128,370,8.6,10,59,280,60]],
['7','èœè‚‰åŒ…','Steamed vegetable and meat bun','é»å¿ƒ',[240,5.9,7.9,37,280,22],[79,190,4.7,6.2,29,220,17]],
['8','å¤§åŒ…','Steamed bun with assorted stuffing','é»å¿ƒ',[230,7.9,8.2,32,300,29],[235,540,18,19,75,700,68]],
['9','æ½®å·ç²‰æœ','Steamed dumpling, Chiu Chow-style','é»å¿ƒ',[150,3.1,5.7,22,360,30],[61,92,1.9,3.5,13,220,18]],
['10','è±‰æ±è’¸æ’éª¨','Steamed pork ribs with black bean sauce','é»å¿ƒ',[220,14,15,6.3,570,41],[118,260,16,17,7.3,660,48]],
['11','è±‰æ±è’¸é³³çˆª','Steamed chicken feet with black bean sauce','é»å¿ƒ',[200,15,13,5.7,620,66],[100,200,15,13,5.7,620,66]],
['12','è±‰æ±è’¸é­šé›²','Steamed fish head with black bean sauce','é»å¿ƒ',[170,10,12,4.2,580,180],[112,190,11,13,4.7,640,200]],
['13','å°ç± åŒ…','Steamed pork dumpling, Shanghai-style','é»å¿ƒ',[230,9,14,17,390,13],[37,85,3.3,5.2,6.3,140,4.8]],
['14','çŒæ¹¯é¤ƒ','Soup dumpling','é»å¿ƒ',[61,5.2,2,5.7,410,16],[230,140,12,4.6,13,940,37]],
['15','èŸ¹ç²‰å°ç± åŒ…','Steamed pork dumpling with crab meat','é»å¿ƒ',[230,8.7,14,17,380,20],[36,83,3.1,5,6.1,140,7.2]],
['16','ä¸Šç´ è’¸ç²‰æœ','Steamed vegetarian dumpling','é»å¿ƒ',[120,1.4,3.4,21,360,11],[43,52,0.6,1.5,9,150,4.7]],
['17','è–‘è”¥ç‰›æŸè‘‰','Steamed beef omasum with ginger and spring onion','é»å¿ƒ',[99,12,4.2,3.5,540,36],[162,160,20,6.9,5.8,890,59]],
['18','æŸ±ä¾¯é‡‘éŒ¢è‚š','Braised ox tripe with zhuhou sauce','é»å¿ƒ',[140,14,6.5,7.4,600,22],[157,220,22,10,11,920,34]],
['19','è’œèŒ¸è’¸é­·é­š','Steamed squid with garlic','é»å¿ƒ',[120,14,4.6,4.4,600,23],[142,170,19,6.4,6.1,830,32]],
['20','é›çµ²ç²‰å·','Steamed rice flour roll with shredded chicken','é»å¿ƒ',[160,5.8,8.5,14,390,15],[69,110,3.9,5.8,9.5,270,10]],
['21','é®®ç«¹å·','Steamed beancurd sheet roll','é»å¿ƒ',[260,11,22,5.3,440,38],[58,150,6.2,12,3,250,21]],
['22','é´¨è…³æ‰','Steamed beancurd sheet roll with duck feet','é»å¿ƒ',[220,10,15,12,420,38],[73,160,7.4,11,8.8,310,28]],
['23','é›æ‰','Steamed beancurd sheet roll with chicken','é»å¿ƒ',[180,12,12,4.9,450,20],[83,150,10,10,4.2,390,17]],
['24','è¦é¤ƒ','Steamed fresh prawn dumpling (Ha-gau)','é»å¿ƒ',[160,6.7,6.7,18,400,27],[31,50,2.1,2.1,5.6,120,8.4]],
['25','ç‡’è³£','Steamed stuffed dumpling with shrimp (Siu mai)','é»å¿ƒ',[210,11,13,11,560,26],[29,61,3.2,3.8,3.2,160,7.5]],
['26','å±±ç«¹ç‰›è‚‰','Steamed minced beef ball','é»å¿ƒ',[190,8.5,14,9.1,520,11],[49,93,4.2,6.9,4.5,250,5.4]],
['27','æ£‰èŠ±é›','Steamed chicken with fish maw','é»å¿ƒ',[140,12,9.3,3.5,640,16],[150,210,18,14,5.3,970,24]],
['28','å’–å“©è’¸é­·é­š','Steamed curry squid','é»å¿ƒ',[98,11,4.3,4.5,640,29],[194,190,22,8.5,8.9,1300,57]],
['29','è’¸è˜¿è””ç³•','Turnip cake (steamed)','é»å¿ƒ',[95,2.3,3.6,13,430,21],[179,170,4,6.3,23,750,37]],
['30','çç é›','Mini-sized sticky rice wrapped in lotus leaf','é»å¿ƒ',[220,6.4,7.3,32,440,26],[95,210,6.1,7,31,420,25]],
['31','ç³¯ç±³é›','Sticky rice wrapped in lotus leaf','é»å¿ƒ',[210,7.6,6.7,31,420,11],[338,710,26,23,110,1400,37]],
['32','å‰ç‡’è…¸ç²‰','Steamed rice-roll with barbecued pork','é»å¿ƒ',[140,5.1,5.7,18,410,7.8],[79,110,3.8,4.3,14,310,5.9]],
['33','ç‰›è‚‰è…¸ç²‰','Steamed rice-roll with beef','é»å¿ƒ',[110,2.8,3.5,16,150,6.3],[80,88,2.2,2.8,13,120,5]],
['34','é®®è¦è…¸ç²‰','Steamed rice-roll with shrimp','é»å¿ƒ',[110,3.9,2.2,17,150,17],[74,81,2.9,1.6,13,110,13]],
['35','è’¸å¸¶å­è…¸ç²‰','Steamed rice-roll with scallops','é»å¿ƒ',[100,4.3,2.3,16,160,9.2],[70,70,3,1.6,11,110,6.4]],
['36','è’¸ç¾…æ¼¢é½‹è…¸ç²‰','Steamed rice-roll with vegetarian stuffing','é»å¿ƒ',[100,2.1,2.8,17,190,9],[76,76,1.6,2.1,13,140,6.8]],
['37','èŠ‹è§’','Deep-fried taro dumpling','é»å¿ƒ',[370,6,26,27,440,25],[46,170,2.8,12,13,210,12]],
['38','æ˜¥å·','Spring roll','é»å¿ƒ',[350,9.1,24,24,480,23],[43,150,4,11,11,210,10]],
['39','é¹¹æ°´è§’','Deep-fried meat dumpling','é»å¿ƒ',[340,4.9,16,43,180,25],[50,170,2.4,7.8,21,88,12]],
['40','ç‚¸é¥…é ­','Deep-fried plain bun','é»å¿ƒ',[430,4.9,23,50,67,27],[65,280,3.2,15,33,44,18]],
['41','ç‚¸é›²å','Deep fried wonton','é»å¿ƒ',[430,9.7,29,32,440,30],[23,99,2.2,6.7,7.4,100,6.9]],
['42','ç…è…¸ç²‰','Pan-fried rice-roll','é»å¿ƒ',[140,2,4.4,24,190,22],[321,450,6.4,14,77,610,71]],
['43','ç…è…çš®å·','Pan-fried beancurd sheet roll','é»å¿ƒ',[320,14,26,5.9,520,63],[41,130,5.7,11,2.4,210,26]],
['44','ç…è˜¿è””ç³•','Turnip cake (pan-fried)','é»å¿ƒ',[140,3.2,5.7,18,540,25],[86,120,2.7,4.8,15,450,21]],
['45','ç…é¦¬è¹„ç³•','Sweetened water chestnut cake (pan-fried)','é»å¿ƒ',[140,0,1.7,32,12,3.1],[79,110,0,1.3,25,9.4,2.4]],
['46','ç…èŠ‹é ­ç³•','Taro cake (pan-fried)','é»å¿ƒ',[180,3.2,7.4,24,460,30],[78,140,2.5,5.7,18,350,23]],
['47','ç”Ÿç…èœè‚‰åŒ…','Pan-fried vegetable and meat bun','é»å¿ƒ',[280,6.4,13,34,320,32],[57,160,3.7,7.5,20,190,19]],
['48','ç™½ç¼ç”Ÿèœ','Boiled headed lettuce (without sauce)','é»å¿ƒ',[31,0.87,2,2.5,23,24],[281,87,2.4,5.6,7,65,67]],
['49','ç™½ç¼èœå¿ƒ','Boiled Chinese flowering cabbage (without sauce)','é»å¿ƒ',[28,1.8,0.91,3.2,33,91],[257,72,4.6,2.3,8.3,85,230]],
['50','ç™½ç¼é€šèœ','Boiled water spinach (without sauce)','é»å¿ƒ',[24,1.7,0.7,2.7,47,46],[296,71,5,2.1,8,140,140]],
['51','å†¬è°è’¸é›é£¯','Steamed rice with chicken and winter mushroom','é»å¿ƒ',[160,6.1,4.4,25,280,9.7],[413,660,25,18,100,1100,40]],
['52','è±‰æ±é³³çˆªæ’éª¨é£¯','Steamed rice with pork rib and chicken leg','é»å¿ƒ',[180,5.3,5.4,28,260,12],[456,820,24,25,130,1200,55]],
['53','é­šç‰‡æ¹¯ç±³ç²‰ (é€£æ¹¯)','Rice vermicelli-in-soup with sliced freshwater fish','é»å¿ƒ',[67,3.8,1.1,10,230,11],[672,450,25,7.3,67,1500,73]],
['54','å†¬ç“œè‚‰ç²’æ¹¯é£¯','Rice-in-soup with winter melon and diced pork','é»å¿ƒ',[81,3.9,0.71,15,210,5.7],[728,590,28,5.1,110,1500,41]],
['55','ç´…è±†æ²™','Red bean dessert/sweet soup','é»å¿ƒ',[110,3.6,0.36,22,0,18],[236,260,8.6,0.86,53,0,43]],
['56','ç¶ è±†æ²™','Mung bean dessert/sweet soup','é»å¿ƒ',[80,2.5,0.32,17,0,12],[350,280,8.7,1.1,59,0,42]],
['57','è•ƒè–¯ç³–æ°´','Sweet potato dessert/sweet soup','é»å¿ƒ',[70,0.39,0,17,16,12],[314,220,1.2,0,53,50,38]],
['58','å–³å’‹','Mixed bean dessert/sweet soup (Ja-ja dessert)','é»å¿ƒ',[110,3.6,1.7,20,7.6,23],[327,360,12,5.6,66,25,76]],
['59','è±†è…èŠ±','Soybean curd dessert','é»å¿ƒ',[55,2.2,1.3,8.6,0,86],[309,170,6.6,3.9,26,0,260]],
['60','èŠ’æœå¸ƒç”¸','Mango pudding','é»å¿ƒ',[97,2.2,2.2,17,29,40],[186,180,4,4,31,53,73]],
['61','å°è›‹æ’»','Egg tart (small)','é»å¿ƒ',[330,5.2,18,36,68,32],[26,86,1.4,4.7,9.4,18,8.3]],
['62','èŠéº»ç³Š','Sesame dessert/sweet soup','é»å¿ƒ',[100,1.6,4.2,15,0,74],[290,290,4.6,12,43,0,210]],
['63','æ¥Šæç”˜éœ²','Mango sago dessert with pomelo','é»å¿ƒ',[83,0.4,2.1,15,11,13],[253,210,1,5.4,39,28,34]],
['64','æ¤°æ±é¦¬è±†ç³•','Coconut milk yellow bean pudding','é»å¿ƒ',[140,3.9,4.8,19,16,19],[86,120,3.3,4.1,16,14,16]],
['65','è±†æ²™æ°´æ™¶åŒ…','Steamed sago dumpling with red bean paste','é»å¿ƒ',[220,1.8,4.7,43,0,15],[39,86,0.7,1.8,17,0,5.9]],
['66','è“®è“‰æ°´æ™¶åŒ…','Steamed sago dumpling with lotus seed paste','é»å¿ƒ',[240,2.1,8,41,7,15],[37,89,0.78,3,15,2.6,5.6]],
['67','é¹¹è‚‰ç²½','Salted meat rice dumpling','é»å¿ƒ',[190,5.7,6.7,27,260,12],[253,480,14,17,68,660,30]],
['68','é¹¼æ°´ç²½','Gan-shui rice dumpling','é»å¿ƒ',[160,2.6,1.4,34,23,3.7],[244,390,6.3,3.4,83,56,9]],
['69','éº»é¦™æ‹Œæµ·èœ‡','Marinated jelly fish','é»å¿ƒ',[84,4.5,6.4,2.2,780,3.1],[286,240,13,18,6.3,2200,8.9]],
['70','å‰ç‡’é…¥','Baked barbecued pork puff','é»å¿ƒ',[450,8.9,31,32,250,15],[44,200,3.9,14,14,110,6.6]],
['71','è˜¿è””çµ²é…¥é¤…','Puff pastries filled with shredded turnip','é»å¿ƒ',[290,3.2,19,26,320,20],[72,210,2.3,13,18,230,14]],
['72','ç‰›æ²¹æœ','Avocado','æ°´æœ',[160,2,14.66,8.53,7,12],[101,161,2.01,14.74,8.58,7,12]],
['73','é¦™è•‰','Banana','æ°´æœ',[89,1.09,0.33,22.84,1,5],[68,61,0.74,0.22,15.53,1,3]],
['74','é»‘åŠ ä¾–å­','Black currant','æ°´æœ',[63,1.4,0.41,15.38,2,55],[61,36,0.79,0.23,8.62,1,31]],
['75','ç½é ­æ¡ƒ','Canned peach','æ°´æœ',[77,0.54,0.14,19.79,6,3],[111,85,0.6,0.16,21.97,7,3]],
['76','ç½é ­è è˜¿','Canned pineapple','æ°´æœ',[60,0.51,0.11,15.56,1,16],[91,54,0.46,0.1,14.08,1,14]],
['77','ç«é¾æœ','Dragon fruit','æ°´æœ',[61,1.1,1.4,11,0,5.8],[175,107,1.9,2.5,19,0,10.2]],
['78','æ¦´æ§¤','Durian','æ°´æœ',[147,1.47,5.33,27.09,2,6],[122,179,1.79,6.48,32.91,2,7]],
['79','é¦™æ¢¨','Fragrant pear','æ°´æœ',[58,0.3,0.3,14,0,7.9],[122,71,0.4,0.4,17,0,9.6]],
['80','å¯Œå£«è˜‹æœ','Fuji apple','æ°´æœ',[58,0,0.4,14,0,4.9],[138,80,0,0.6,19,0,6.8]],
['81','æå­','Grape','æ°´æœ',[68,0.6,0.6,15,0,8.2],[75,51,0.5,0.5,11,0,6.2]],
['82','è¥¿æŸš','Grapefruit','æ°´æœ',[32,0.63,0.1,8.08,0,12],[128,41,0.81,0.13,10.34,0,15]],
['83','é’è˜‹æœ','Green apple','æ°´æœ',[59,0.3,0.3,14,0,6.2],[138,81,0.4,0.4,19,0,8.6]],
['84','ç•ªçŸ³æ¦´','Guava','æ°´æœ',[68,2.55,0.95,14.32,2,18],[55,37,1.4,0.52,8.92,1,10]],
['85','èœœæ¢¨','Honey pear','æ°´æœ',[49,0.4,0,12,0,4],[122,60,0.5,0,15,0,4.9]],
['86','å¥‡ç•°æœ','Kiwi fruit','æ°´æœ',[61,1.14,0.52,14.66,3,34],[76,46,0.87,0.4,11.14,2,26]],
['87','æª¸æª¬','Lemon','æ°´æœ',[29,1.1,0.3,9.32,2,26],[84,24,0.92,0.25,7.83,2,22]],
['88','é¾çœ¼','Longan','æ°´æœ',[60,1.31,0.1,15.14,0,1],[48,29,0.63,0.05,7.27,0,0]],
['89','è”æ','Lychee','æ°´æœ',[66,0.83,0.44,16.53,1,5],[95,63,0.79,0.42,15.7,1,5]],
['90','èŠ’æœ','Mango','æ°´æœ',[65,0.51,0.27,17,2,10],[104,67,0.53,0.28,17.59,2,10]],
['91','æ©™','Orange','æ°´æœ',[47,0.94,0.12,11.75,0,40],[131,62,1.23,0.16,15.39,0,52]],
['92','æœ¨ç“œ','Papaya','æ°´æœ',[39,0.61,0.14,9.81,3,24],[70,27,0.43,0.1,6.87,2,17]],
['93','æ¡ƒ','Peach','æ°´æœ',[39,0.91,0.25,9.54,0,6],[150,58,1.36,0.38,14.31,0,9]],
['94','è è˜¿','Pineapple','æ°´æœ',[48,0.54,0.12,12.63,1,13],[78,37,0.42,0.09,9.79,1,10]],
['95','æŸšå­','Pomelo','æ°´æœ',[46,0.7,0.4,9.8,0,14],[122,56,0.9,0.5,12,0,17.1]],
['96','è›‡æœ','Red delicious apple','æ°´æœ',[61,0,0.4,14,0,6.3],[138,84,0,0.6,19,0,8.7]],
['97','æ¥Šæ¡ƒ','Starfruit','æ°´æœ',[31,1.04,0.33,6.73,2,3],[62,19,0.64,0.2,4.17,1,2]],
['98','å£«å¤šå•¤æ¢¨','Strawberry','æ°´æœ',[32,0.67,0.3,7.68,1,16],[72,23,0.48,0.22,5.53,1,12]],
['99','æŸ‘','Mandarin orange','æ°´æœ',[53,0.81,0.31,13.34,2,37],[88,47,0.71,0.27,11.74,2,33]],
['100','è¥¿ç“œ','Watermelon','æ°´æœ',[30,0.61,0.15,7.55,1,7],[76,23,0.46,0.11,5.74,1,5]],
['101','è“®éœ§','Wax jumbo','æ°´æœ',[37,0.6,0,8.6,0,2.3],[120,44,0.7,0,10,0,2.8]],
['102','å•¤æ¢¨','Western pear','æ°´æœ',[60,0,0,15,0,6.5],[178,107,0,0,27,0,11.6]],
['103','çµ²ç“œ','Angled loofah','è”¬èœ',[20,1.1,0,4,0,13],0],
['104','è˜†ç­','Asparagus','è”¬èœ',[25,2.2,0.12,3.88,2,24],0],
['105','è‹¦ç“œ','Bitter cucumber','è”¬èœ',[16,0.7,0,3.2,0,14],0],
['106','éŸ®é»ƒ','Blanched Chinese chive','è”¬èœ',[19,1.5,0.3,2.6,0,29],0],
['107','è¥¿è˜­èŠ±','Broccoli','è”¬èœ',[33,3.1,0.5,4.1,21,32],0],
['108','æ¤°èœ','Cabbage','è”¬èœ',[22,1.3,0,4.3,19,46],0],
['109','ç”˜ç­','Carrot','è”¬èœ',[41,0.93,0.24,9.58,69,33],0],
['110','æ¤°èœèŠ±','Cauliflower','è”¬èœ',[25,1.98,0.1,5.3,30,22],0],
['111','è¥¿èŠ¹','Celery','è”¬èœ',[16,0.69,0.17,2.97,80,40],0],
['112','ä½›æ‰‹ç“œ','Chayote','è”¬èœ',[17,0.82,0.13,3.9,2,17],0],
['113','é»ƒèŠ½ç™½','Chinese cabbage','è”¬èœ',[16,1.2,0.2,3.23,9,77],0],
['114','éŸ®èœèŠ±','Chinese chive (Flower Stalks)','è”¬èœ',[40,2.3,0.4,6.8,0,26],0],
['115','éŸ®èœ','Chinese chive','è”¬èœ',[30,2.2,0.4,4.3,0,110],0],
['116','èœå¿ƒ','Chinese flowering cabbage','è”¬èœ',[18,2.1,0.3,1.6,30,100],0],
['117','èŠ¥è˜­','Chinese kale','è”¬èœ',[34,3,0.6,4.1,18,140],0],
['118','å”ç”Ÿèœ','Chinese lettuce','è”¬èœ',[8.4,1,0,1.1,8,28],0],
['119','è§èœ','Chinese Spinach','è”¬èœ',[21,1.9,0.4,2.5,15,140],0],
['120','é’ç“œ','Cucumber','è”¬èœ',[10,0.7,0,1.8,0,20],0],
['121','èŒ„å­','Eggplant','è”¬èœ',[26,1,0,5.6,0,14],0],
['122','å››å­£è±†','French bean','è”¬èœ',[34,1.9,0.3,6,0,49],0],
['123','ç¢—è±†','Garden peas','è”¬èœ',[42,2.8,0.2,7.55,4,43],0],
['124','èŒ¼è’¿','Garland Chrysanthemum','è”¬èœ',[24,3.36,0.56,3.02,118,117],0],
['125','é’é€šèœ','Green water spinach','è”¬èœ',[23,2,0.4,2.9,32,59],0],
['126','ç¯€ç“œ','Hairy gourd','è”¬èœ',[20,0.8,0,4.1,0,15],0],
['127','èœœç³–è±†','Honey peas','è”¬èœ',[48,3.3,0,8.6,0,44],0],
['128','éº¥èœ','Indian lettuce','è”¬èœ',[23,1.2,0.4,3.6,13,44],0],
['129','è¥¿ç”Ÿèœ','Lettuce','è”¬èœ',[11,0.9,0,1.9,51,57],0],
['130','è“®è—•','Lotus root','è”¬èœ',[74,2.6,0.1,17.23,40,45],0],
['131','èŠ¥èœ','Mustard leaf','è”¬èœ',[27,2.1,0.5,3.4,9,110],0],
['132','æ´‹è‘±','Onions','è”¬èœ',[40,1.1,0.1,9.34,4,23],0],
['133','è±†è‹—','Pea shoots','è”¬èœ',[38,4.2,0.7,3.8,0,49],0],
['134','å—ç“œ','Pumpkin','è”¬èœ',[26,1,0.1,6.5,1,21],0],
['135','è˜¿è””','Radish','è”¬èœ',[18,0.8,0,3.7,24,21],0],
['136','å°å”èœ','Shanghai white cabbage','è”¬èœ',[18,2.3,0.3,1.6,35,97],0],
['137','å°ç™½èœ','Small Chinese white cabbage','è”¬èœ',[20,2.7,0.4,1.5,18,140],0],
['138','è èœ','Spinach','è”¬èœ',[21,2.3,0.4,2,5,18],0],
['139','è¥¿æ¤’','Sweet pepper','è”¬èœ',[21,0.8,0,4.5,0,11],0],
['140','è•ƒèŒ„','Tomato','è”¬èœ',[18,0.7,0,3.9,0,9.7],0],
['141','æ°´èŠ¹','Water celery','è”¬èœ',[16,1.4,0,2.6,73,120],0],
['142','é¦¬è¹„','Water chestnut','è”¬èœ',[56,1,0,13,0,4.5],0],
['143','è¥¿æ´‹èœ','Watercress','è”¬èœ',[19,1.6,0.3,2.4,66,81],0],
['144','å†¬ç“œ','Wax gourd / Winter melon','è”¬èœ',[13,0.4,0,2.9,0,8.3],0],
['145','ç™½èœ','White cabbage','è”¬èœ',[15,1.9,0,1.9,50,140],0],
['146','ç™½é€šèœ','White water spinach','è”¬èœ',[16,1.5,0,2.4,47,60],0],
['147','ç‹èœ(å¨ƒå¨ƒèœ)','Wong Choi cabbage','è”¬èœ',[16,1.5,0,2.5,20,47],0],
['148','é’è±†è§’','Yardlong bean','è”¬èœ',[47,2.8,0.4,8.35,4,50],0],
['149','å‡±æ’’æ²™å¾‹','Caesar Salad','éº¥ç•¶å‹',[102,5.9,5.3,8,291,N],[N,127,7.4,6.7,9.9,364,N]],
['150','çƒ¤é›å‡±æ’’æ²™å¾‹','Grilled Chicken Caesar Salad','éº¥ç•¶å‹',[121,11.8,5.6,6,457,N],[N,248,24.2,11.4,12.4,936,N]],
['151','ç²¾é¸æ—©æ™¨å¥—é¤','Deluxe Breakfast','éº¥ç•¶å‹',[238,9.3,15.3,15.2,424,N],[N,597,23.3,38.5,38.2,1063,N]],
['152','ç†±é¦™é¤… (3ä»¶)','Hotcakes (3 pcs)','éº¥ç•¶å‹',[173,4.8,3,31.6,547,N],[N,273,7.6,4.7,49.9,864,N]],
['153','ç†±é¦™é¤… (2ä»¶)','Hotcakes (2 pcs)','éº¥ç•¶å‹',[171,4.8,3,31.5,544,N],[N,182,5.1,3.1,33.3,576,N]],
['154','æ¿ç‡’é›è…¿æ‰­æ‰­ç²‰ (é›æ¹¯åŸå‘³)','Grilled Chicken Twisty Pasta (Chicken flavor)','éº¥ç•¶å‹',[56,4.4,1.1,7.2,339,N],[N,332,26,6.4,42.9,2010,N]],
['155','Minié›œèœè›‹æ‰­æ‰­ç²‰','Mixed Veggies Egg Mini Twisty Pasta','éº¥ç•¶å‹',[68,4.2,2.1,8.1,261,N],[N,163,10,5.1,19.2,621,N]],
['156','éº¥èŠè›‹é£½','Egg & Cheese Burger','éº¥ç•¶å‹',[227,10.6,10.2,22.6,545,N],[N,302,14.1,13.6,30.1,725,N]],
['157','ç…™è‚‰è›‹æ¼¢å ¡','Egg McMuffin','éº¥ç•¶å‹',[207,13.9,7.9,19.4,598,N],[N,266,17.9,10.2,25,771,N]],
['158','ç«è…¿æ‰’èŠå£«æ¼¢å ¡','','éº¥ç•¶å‹',[326,12.2,19.2,25.5,661,N],[N,346,12.9,20.4,27,701,N]],
['159','å·¨ç„¡éœ¸','Big Mac','éº¥ç•¶å‹',[232,11.9,11.5,19.9,438,N],[N,496,25.6,24.6,42.7,938,N]],
['160','èŠå£«æ¼¢å ¡é£½','Cheeseburger','éº¥ç•¶å‹',[258,13.6,10.9,26.2,602,N],[N,294,15.5,12.4,29.8,686,N]],
['161','é›™å±¤èŠå£«å­–å ¡','Double Cheeseburger','éº¥ç•¶å‹',[264,15.6,13.9,18.8,621,N],[N,434,25.6,22.9,30.8,1019,N]],
['162','é­šæŸ³é£½','Filet-O-Fish','éº¥ç•¶å‹',[240,10.7,10.3,26.2,427,N],[N,337,15,14.4,36.7,598,N]],
['163','æ¼¢å ¡é£½','Hamburger','éº¥ç•¶å‹',[245,12.6,8.5,29.4,499,N],[N,245,12.6,8.5,29.4,499,N]],
['164','éº¥é¦™é›','McChicken','éº¥ç•¶å‹',[227,8.7,10.8,23.8,465,N],[N,382,14.6,18.1,40,780,N]],
['165','è„†è¾£é›è…¿é£½','McSpicy Chicken Filet','éº¥ç•¶å‹',[241,9.7,12.7,21.9,573,N],[N,461,18.5,24.3,41.7,1094,N]],
['166','æ¿ç‡’é›è…¿é£½','GCB','éº¥ç•¶å‹',[205,13.1,8.3,19.1,572,N],[N,358,23,14.6,33.4,1001,N]],
['167','è±¬æŸ³æ¼¢å ¡','Sausage McMuffin','éº¥ç•¶å‹',[328,13.6,20.4,22.4,684,N],[N,361,14.9,22.4,24.6,753,N]],
['168','è±¬æŸ³è›‹æ¼¢å ¡','Sausage McMuffin with Egg','éº¥ç•¶å‹',[272,13.2,17.1,15.9,567,N],[N,427,20.7,26.8,24.9,890,N]],
['169','è˜‘è‡å®‰æ ¼æ–¯','Cheesy Champignon Angus Burger','éº¥ç•¶å‹',[247,13.9,14.8,14.3,400,N],[N,644,36.2,38.7,37.3,1045,N]],
['170','èŠå£«å®‰æ ¼æ–¯','Angus Original','éº¥ç•¶å‹',[271,16.3,15,17.7,462,N],[N,580,34.8,32.2,37.8,988,N]],
['171','ç²’ç²’ç²Ÿç±³æ¯','Fresh Corn Cup','éº¥ç•¶å‹',[64,2.5,1.6,9.9,4,N],[N,81,3.2,2,12.6,5,N]],
['172','ç²’ç²’ç²Ÿç±³æ¯ (ç´°)','Fresh Corn Cup (S)','éº¥ç•¶å‹',[64,2.5,1.6,9.9,4,N],[N,54,2.1,1.3,8.4,3,N]],
['173','è„†è–¯é¤…','Hash Browns','éº¥ç•¶å‹',[246,2.4,16.3,22.2,632,N],[N,138,1.3,9.1,12.4,354,N]],
['174','éº¥æ¨‚é› (6ä»¶)','Chicken McNuggets (6 pcs)','éº¥ç•¶å‹',[264,15.3,18,10.1,466,N],[N,316,18.3,21.5,12.1,557,N]],
['175','è–¯æ¢ (ä¸­)','Fries (M)','éº¥ç•¶å‹',[285,4.3,15.2,32.6,180,N],[N,313,4.7,16.7,35.8,198,N]],
['176','è–¯æ¢ (ç´°)','Fries (S)','éº¥ç•¶å‹',[285,4.3,15.2,32.6,181,N],[N,225,3.4,12,25.8,143,N]],
['177','è„†é¦™é›ç¿¼ (2ä»¶)','McWings (2 pcs)','éº¥ç•¶å‹',[279,16.9,19.3,9.4,652,N],[N,242,14.6,16.7,8.1,564,N]],
['178','è˜‹æœæ‰¹','Apple Pie','éº¥ç•¶å‹',[272,2.7,15.8,29.7,222,N],[N,228,2.3,13.3,24.9,187,N]],
['179','æ–°åœ°ç­’','Twist Cone','éº¥ç•¶å‹',[153,3.5,4.9,23.7,97,N],[N,137,3.2,4.4,21.3,88,N]],
['180','æœ±å¤åŠ›æ–°åœ°','Hot Fudge Sundae','éº¥ç•¶å‹',[193,3.7,7.3,27.9,99,N],[N,343,6.5,13.1,49.7,177,N]],
['181','è—è“é«˜éˆ£ä½è„‚ä¹³é…ª','Hi-Calcium Low Fat Blueberry Yoghurt','éº¥ç•¶å‹',[75,3.3,1,13.2,42,N],[N,75,3.3,1,13.2,42,N]],
['182','å¯å£å¯æ¨‚æ±½æ°´ (ä¸­)','Coca-Cola (M)','éº¥ç•¶å‹',[34,0,0,8.5,2,N],[N,148,0,0,36.5,7,N]],
['183','ç¾ç²’æœæ©™æ± (ç´°)','Minute Maid Orange Juice (S)','éº¥ç•¶å‹',[48,0.7,0,10.3,1,N],[N,94,1.4,0,20.1,2,N]],
['184','ç†±æ–°é®®æª¸æª¬èŒ¶','Hot Fresh Lemon Tea','éº¥ç•¶å‹',[5,0.2,0.2,0.9,2,N],[N,12,0.4,0.4,2.2,5,N]],
['185','ç†±æ–°é®®æª¸æª¬æ°´','Hot Fresh Lemon Water','éº¥ç•¶å‹',[4,0,0,0.7,0,N],[N,9,0,0,1.7,0,N]],
['186','å‡æ–°é®®æª¸æª¬èŒ¶','Iced Fresh Lemon Tea','éº¥ç•¶å‹',[3,0.1,0.1,0.6,1,N],[N,10,0.4,0.4,2.2,5,N]],
['187','å¥¶èŒ¶','Hot Tea','éº¥ç•¶å‹',[1,0,0,0.3,0,N],[N,2,0,0,0.7,0,N]],
['188','ç†±æ¸¯å¼å¥¶èŒ¶ (ç´°)','Hot Local Milk Tea (S)','éº¥ç•¶å‹',[33,1.3,1.9,2.7,25,N],[N,70,2.7,4,5.7,54,N]],
['189','å„ªè³ªæ¿ƒé¦™å’–å•¡ (ç´°)','Premium Roast Coffee (S)','éº¥ç•¶å‹',[1,0,0,0,2,N],[N,3,0,0,0,5,N]],
['190','å„ªå“è±†æ¼¿','Soy Milk','éº¥ç•¶å‹',[75,2.7,1.3,12.9,23,N],[N,169,6.1,2.9,29,52,N]],
['191','é«˜éˆ£ä½è„‚ç‰›å¥¶é£²å“','Hi-Calcium Low Fat Milk Drink','éº¥ç•¶å‹',[59,4.4,1.5,7.1,58,N],[N,139,10.4,3.5,16.8,137,N]],
['192','Qooè³å¥¶é£²å“','Qoo Soya Milk','éº¥ç•¶å‹',[36,0.7,1.2,5.7,44,N],[N,72,1.4,2.4,11.4,88,N]],
['193','ç†±æœ±å¤åŠ›','Hot Chocolate','éº¥ç•¶å‹',[25,0.3,0.7,4.4,28,N],[N,56,0.6,1.6,9.9,64,N]],
['194','æ¿ƒé»‘å’–å•¡ (ä¸­)','Long Black (M)','éº¥ç•¶å‹',[7,0.5,0,1.3,0,N],[N,24,1.6,0.5,4.2,0,N]],
['195','é®®å¥¶å’–å•¡ (ä¸­)','Latte (M)','éº¥ç•¶å‹',[51,2.6,2.7,4.1,34,N],[N,132,6.7,7,10.6,88,N]],
['196','æ„å¤§åˆ©æ³¡æ²«å’–å•¡ (ä¸­)','Cappuccino (M)','éº¥ç•¶å‹',[50,2.5,2.4,4.6,30,N],[N,141,7.1,6.7,13.1,85,N]],
['197','ç™½ç²¥','Plain Congee','ç²¥ç²‰éºªé£¯',[32,0.71,0.69,5.8,29,5.5],[450,140,3.2,3.1,26,130,25]],
['198','çš®è›‹ç˜¦è‚‰ç²¥','Congee with Preserved Egg and Lean Pork','ç²¥ç²‰éºªé£¯',[56,3.4,2.5,4.8,280,9.8],[470,260,16,12,22,1300,46]],
['199','æŸ´é­šèŠ±ç”Ÿç²¥','Congee with Dried Fish and Peanut','ç²¥ç²‰éºªé£¯',[64,3.2,3.3,5.5,240,18],[470,300,15,15,26,1100,84]],
['200','è‰‡ä»”ç²¥','Sampan Congee','ç²¥ç²‰éºªé£¯',[66,2.9,3.1,6.8,280,7.6],[450,300,13,14,31,1300,34]],
['201','åŠç¬¬ç²¥','Congee with Pork Offal','ç²¥ç²‰éºªé£¯',[63,4.5,2.5,5.8,310,7.6],[500,310,22,12,29,1500,38]],
['202','æ°´é¤ƒæ¹¯ç²—éºªæ¢','Dumpling Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[66,4.8,1.6,8.1,440,15],[580,380,28,9.3,47,2500,87]],
['203','é›²åæ¹¯ç²—éºªæ¢','Wonton Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[67,5.3,1.8,7.5,460,16],[630,420,33,11,47,2900,100]],
['204','é›²åæ¹¯å¹¼éºªæ¢','Wonton Noodle Soup (Thin Noodles)','ç²¥ç²‰éºªé£¯',[71,5.2,2.2,7.5,460,17],[630,450,33,14,47,2900,110]],
['205','é›²åæ¹¯ç±³ç²‰','Wonton Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[72,3.3,1.6,11,290,16],[720,520,24,11,79,2100,110]],
['206','é›²åæ¹¯æ²³ç²‰','Wonton Flat Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[79,2.8,1.8,13,260,14],[720,570,20,13,94,1900,100]],
['207','é­šçš®é¤ƒæ¹¯æ²³ç²‰','Fish Skin Dumpling Flat Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[83,2.4,2.3,13,260,14],[670,550,16,15,87,1700,94]],
['208','é­šçš®é¤ƒæ¹¯å¹¼éºªæ¢','Fish Skin Dumpling Noodle Soup (Thin Noodles)','ç²¥ç²‰éºªé£¯',[70,4.4,2.3,7.8,410,14],[590,410,26,14,46,2400,82]],
['209','é­šçš®é¤ƒæ¹¯ç±³ç²‰','Fish Skin Dumpling Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[85,3.3,2.6,12,320,15],[660,560,22,17,79,2100,99]],
['210','é­šçš®é¤ƒæ¹¯ç²—éºªæ¢','Fish Skin Dumpling Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[86,5,3.5,8.7,460,21],[590,500,29,20,51,2700,120]],
['211','ç‰›è…©æ¹¯ç²—éºªæ¢','Beef Brisket Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[84,7.5,2.5,7.9,480,12],[620,520,46,15,49,3000,74]],
['212','ç‰›è…©æ¹¯å¹¼éºªæ¢','Beef Brisket Noodle Soup (Thin Noodles)','ç²¥ç²‰éºªé£¯',[86,7.9,2.7,7.6,490,11],[640,550,50,17,48,3100,70]],
['213','ç‰›è…©æ¹¯ç±³ç²‰','Beef Brisket Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[87,7,2.1,10,270,13],[700,610,49,15,70,1900,91]],
['214','ç‰›è…©æ¹¯æ²³ç²‰','Beef Brisket Flat Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[93,5.6,2.6,12,270,12],[720,670,40,19,86,1900,86]],
['215','ç‰›ç­‹æ¹¯æ²³ç²‰','Beef Tendon Flat Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[83,6.7,1.3,11,310,10],[680,560,45,8.8,75,2100,68]],
['216','ç‰›ç­‹æ¹¯å¹¼éºªæ¢','Beef Tendon Noodle Soup (Thin Noodles)','ç²¥ç²‰éºªé£¯',[77,9,1.5,6.9,510,12],[620,480,56,9.3,43,3200,75]],
['217','ç‰›ç­‹æ¹¯ç±³ç²‰','Beef Tendon Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[80,7.8,1.3,9.1,360,11],[680,540,53,8.8,62,2400,74]],
['218','ç‰›ç­‹æ¹¯ç²—éºªæ¢','Beef Tendon Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[77,8.8,1.6,6.8,500,13],[590,460,52,9.5,40,3000,77]],
['219','ç‰›è‚š(èƒƒ)æ¹¯ç²—éºªæ¢','Beef Tripe Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[61,6,1,7,480,17],[590,360,35,5.9,41,2800,100]],
['220','ç‰›ä»€(å…§è‡Ÿ)æ¹¯ç²—éºªæ¢','Beef Offal Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[73,6.4,2.2,6.8,500,15],[630,460,40,14,43,3100,94]],
['221','ç‰›ä¸¸æ¹¯æ²³ç²‰','Beef Ball Flat Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[65,2.9,0.99,11,270,10],[700,450,20,6.9,77,1900,70]],
['222','ç‰›ä¸¸æ¹¯å¹¼éºªæ¢','Beef Ball Noodle Soup (Thin Noodles)','ç²¥ç²‰éºªé£¯',[63,5.3,1.3,7.4,440,14],[600,380,32,7.8,45,2600,84]],
['223','ç‰›ä¸¸æ¹¯ç±³ç²‰','Beef Ball Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[67,3.6,0.99,11,340,14],[670,450,24,6.6,74,2300,94]],
['224','ç‰›ä¸¸æ¹¯ç²—éºªæ¢','Beef Ball Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[63,5.2,1.4,7.3,460,15],[620,390,32,8.7,45,2900,93]],
['225','é­šè›‹æ¹¯ç±³ç²‰','Fish Ball Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[58,3.5,0.69,9.5,260,29],[700,400,24,4.8,66,1800,200]],
['226','é­šè›‹æ¹¯æ²³ç²‰','Fish Ball Flat Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[63,2.8,0.67,11,280,28],[720,450,20,4.8,79,2000,200]],
['227','é­šè›‹æ¹¯ç²—éºªæ¢','Fish Ball Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[55,4.8,0.78,7.3,410,28],[620,340,30,4.8,45,2500,170]],
['228','é­šè›‹æ¹¯å¹¼éºªæ¢','Fish Ball Noodle Soup (Thin Noodles)','ç²¥ç²‰éºªé£¯',[55,4.8,0.81,7.2,410,31],[640,350,30,5.1,46,2600,200]],
['229','é­šç‰‡æ¹¯æ²³ç²‰','Fish Slice Flat Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[62,2.5,0.72,11,330,17],[640,390,16,4.6,70,2100,110]],
['230','é­šç‰‡æ¹¯å¹¼éºªæ¢','Fish Slice Noodle Soup (Thin Noodles)','ç²¥ç²‰éºªé£¯',[56,4.8,0.93,7.1,520,20],[580,320,28,5.4,41,3000,120]],
['231','é­šç‰‡æ¹¯ç±³ç²‰','Fish Slice Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[61,3.1,0.78,10,350,18],[650,390,20,5,65,2300,120]],
['232','é­šç‰‡æ¹¯ç²—éºªæ¢','Fish Slice Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[55,4.6,0.88,7.2,500,20],[570,310,26,5,41,2900,110]],
['233','å¢¨é­šä¸¸æ¹¯ç±³ç²‰','Cuttlefish Ball Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[64,3.1,1.1,10,300,9.5],[700,450,22,7.7,70,2100,67]],
['234','å¢¨é­šä¸¸æ¹¯æ²³ç²‰','Cuttlefish Ball Flat Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[67,2.3,1.3,11,290,9.1],[690,460,16,8.9,75,2000,62]],
['235','å¢¨é­šä¸¸æ¹¯ç²—éºªæ¢','Cuttlefish Ball Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[58,4.5,1.3,7,470,12],[640,370,29,8.4,45,3000,77]],
['236','å¢¨é­šä¸¸æ¹¯å¹¼éºªæ¢','Cuttlefish Ball Noodle Soup (Thin Noodles)','ç²¥ç²‰éºªé£¯',[59,4.6,1.3,7.2,480,12],[620,370,29,8.1,45,3000,75]],
['237','è²¢ä¸¸æ¹¯æ²³ç²‰','Pork Ball Flat Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[81,2.8,2.2,12,310,9.1],[680,550,19,15,82,2100,62]],
['238','è²¢ä¸¸æ¹¯å¹¼éºªæ¢','Pork Ball Noodle Soup (Thin Noodles)','ç²¥ç²‰éºªé£¯',[73,4.5,2.5,8.2,440,15],[660,480,30,16,54,2900,99]],
['239','è²¢ä¸¸æ¹¯ç²—éºªæ¢','Pork Ball Noodle Soup (Thick Noodles)','ç²¥ç²‰éºªé£¯',[68,4.6,2,7.9,420,14],[660,450,30,13,52,2800,93]],
['240','è²¢ä¸¸æ¹¯ç±³ç²‰','Pork Ball Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[72,3.3,1.6,11,330,12],[730,520,24,12,80,2400,87]],
['241','é®®é­šç‰‡æ¹¯ç±³ç²‰','Fresh Fish Slice Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[67,3.8,1.1,10,230,11],[670,450,25,7.3,67,1500,73]],
['242','é›ªèœè‚‰çµ²æ¹¯ç±³ç²‰','Snow Vegetable and Shredded Pork Rice Noodle Soup','ç²¥ç²‰éºªé£¯',[84,3,1.7,14,360,12],[420,350,12,7.1,58,1500,50]],
['243','é¤è‚‰è›‹å³é£Ÿéºª','Instant Noodle with Luncheon Meat and Egg','ç²¥ç²‰éºªé£¯',[150,4.9,8.4,13,400,14],[450,680,22,38,59,1800,64]],
['244','äº”é¦™è‚‰ä¸å³é£Ÿéºª','Instant Noodle with Spiced Pork','ç²¥ç²‰éºªé£¯',[160,6.6,8.2,14,460,11],[450,710,29,37,62,2100,49]],
['245','æ²™çˆ¹ç‰›è‚‰å³é£Ÿéºª','Instant Noodle with Satay Beef','ç²¥ç²‰éºªé£¯',[130,5.8,5.5,13,440,11],[500,640,29,27,64,2200,54]],
['246','ä»€éŒ¦æµ·é®®æ¹¯çƒå†¬','Assorted Seafood Udon Soup','ç²¥ç²‰éºªé£¯',[58,4.4,0.9,8.1,290,12],[710,410,31,6.4,58,2100,85]],
['247','è±‰æ²¹çš‡ç‚’éºª','Fried Noodle with Soy Sauce','ç²¥ç²‰éºªé£¯',[170,5.8,5.2,25,510,17],[400,680,23,21,100,2100,68]],
['248','ç‚’ç±³ç²‰','Fried Rice Vermicelli','ç²¥ç²‰éºªé£¯',[160,3.7,4.7,27,390,17],[410,660,15,19,110,1600,70]],
['249','æ˜Ÿå·ç‚’ç±³ç²‰','Singapore Fried Rice Vermicelli','ç²¥ç²‰éºªé£¯',[180,6.3,8.4,19,350,21],[610,1100,39,51,120,2100,130]],
['250','å»ˆé–€ç‚’ç±³ç²‰','Xiamen Fried Rice Vermicelli','ç²¥ç²‰éºªé£¯',[170,5.7,6.4,22,340,21],[670,1100,38,43,150,2300,140]],
['251','é›ªèœç‡’é´¨çµ²ç‚†ç±³ç²‰','Rice Vermicelli with Roast Duck and Snow Vegetable','ç²¥ç²‰éºªé£¯',[140,4.8,5.3,18,400,14],[720,1000,34,38,130,2900,100]],
['252','é›ªèœè±¬è‚‰çµ²ç‚†ç±³ç²‰','Rice Vermicelli with Pork and Snow Vegetable','ç²¥ç²‰éºªé£¯',[120,4.2,4,17,390,16],[720,860,30,29,120,2800,120]],
['253','ç‚’è²´åˆ','Fried Kwai Teow','ç²¥ç²‰éºªé£¯',[160,4.2,6,23,350,14],[770,1200,32,46,180,2700,110]],
['254','ä¹¾ç‚’ç‰›è‚‰æ²³ç²‰','Stir-fried Flat Rice Noodle with Beef','ç²¥ç²‰éºªé£¯',[150,4,5.1,22,350,10],[650,970,26,33,140,2300,65]],
['255','æ™‚èœç‰›è‚‰ç‚’æ²³ç²‰','Fried Flat Rice Noodle with Beef and Vegetables','ç²¥ç²‰éºªé£¯',[130,3.5,4.6,19,250,15],[780,1000,27,36,150,2000,120]],
['256','æ™‚èœç‰›è‚‰ç‚’éºª','Fried Noodle with Beef and Vegetables','ç²¥ç²‰éºªé£¯',[170,7.2,8.3,17,410,18],[580,990,42,48,99,2400,100]],
['257','æ™‚èœè±¬è‚‰ç‰‡ç‚’éºª','Fried Noodle with Pork and Vegetables','ç²¥ç²‰éºªé£¯',[170,6.9,8,17,350,18],[610,1000,42,49,100,2100,110]],
['258','æ™‚èœæ’éª¨ç‚’éºª','Fried Noodle with Spare Ribs and Vegetables','ç²¥ç²‰éºªé£¯',[200,8.1,11,17,370,29],[650,1200,50,68,100,2300,180]],
['259','å‘³èœè±¬è‚‰ç‰‡ç‚’éºª','Fried Noodle with Pork and Preserved Vegetable','ç²¥ç²‰éºªé£¯',[170,5.8,8.6,17,380,12],[710,1200,41,61,120,2700,85]],
['260','å‘³èœæ’éª¨ç‚’éºª','Fried Noodle with Spare Ribs and Preserved Vegetable','ç²¥ç²‰éºªé£¯',[190,6.7,10,17,460,17],[760,1400,49,72,120,3300,120]],
['261','å‘³èœé­·é­šç‚’éºª','Fried Noodle with Squid and Preserved Vegetable','ç²¥ç²‰éºªé£¯',[150,5.5,7.4,16,380,14],[750,1100,41,56,120,2900,110]],
['262','è±‰æ¤’ç‰›è‚‰ç‚’éºª','Fried Noodle with Beef in Black Bean Sauce','ç²¥ç²‰éºªé£¯',[180,6.6,8.7,18,420,14],[630,1100,41,55,110,2600,88]],
['263','è±‰æ¤’è±¬è‚‰ç‰‡ç‚’éºª','Fried Noodle with Pork in Black Bean Sauce','ç²¥ç²‰éºªé£¯',[170,6.7,8.7,17,420,13],[630,1100,42,55,110,2700,82]],
['264','è±‰æ¤’æ’éª¨ç‚’éºª','Fried Noodle with Spare Ribs in Black Bean Sauce','ç²¥ç²‰éºªé£¯',[220,7.6,13,18,410,17],[740,1500,53,91,130,2900,120]],
['265','è±‰æ¤’é­·é­šç‚’éºª','Fried Noodle with Squid in Black Bean Sauce','ç²¥ç²‰éºªé£¯',[170,6.7,7.7,17,390,16],[650,1100,43,50,110,2500,100]],
['266','æ¶¼ç“œç‰›è‚‰ç‚’éºª','Fried Noodle with Beef and Bitter Melon','ç²¥ç²‰éºªé£¯',[180,6.4,9.7,17,450,12],[680,1200,44,66,120,3100,82]],
['267','æ¶¼ç“œè±¬è‚‰ç‰‡ç‚’éºª','Fried Noodle with Pork and Bitter Melon','ç²¥ç²‰éºªé£¯',[180,6.5,9.3,18,410,12],[650,1200,42,60,120,2700,78]],
['268','è±¬æ‰’ç‚’å³é£Ÿéºª','Fried Instant Noodle with Pork Chop','ç²¥ç²‰éºªé£¯',[230,8.9,13,19,480,17],[550,1200,47,68,99,2500,89]],
['269','å¹²ç‡’ä¼Šéºª','Dry-fried E-Fu Noodle','ç²¥ç²‰éºªé£¯',[200,5,11,20,420,13],[650,1300,33,72,130,2700,85]],
['270','æµ·é®®ç‚’çƒå†¬','Fried Udon with Seafood','ç²¥ç²‰éºªé£¯',[120,5.9,2.9,17,370,17],[740,890,44,22,130,2700,130]],
['271','å†¬ç“œè‚‰ç²’æ¹¯é£¯','Rice Soup with Winter Melon and Pork','ç²¥ç²‰éºªé£¯',[81,3.9,0.71,15,210,5.7],[720,590,28,5.1,110,1500,41]],
['272','æ–¹é­šè‚‰ç¢æ¹¯é£¯','Rice Soup with Dried Fish and Minced Pork','ç²¥ç²‰éºªé£¯',[73,3.8,2,10,270,19],[660,480,25,13,66,1800,120]],
['273','æšå·ç‚’é£¯','Yangzhou Fried Rice','ç²¥ç²‰éºªé£¯',[200,7,7.9,25,310,17],[620,1200,43,49,150,1900,100]],
['274','ç¦å»ºç‚’é£¯','Fujian Fried Rice','ç²¥ç²‰éºªé£¯',[150,6,4.7,21,320,12],[960,1400,57,45,200,3100,110]],
['275','é´›é´¦ç‚’é£¯','Mandarin Duck Fried Rice','ç²¥ç²‰éºªé£¯',[140,4.7,4.5,19,280,13],[1100,1500,51,49,210,3000,140]],
['276','è¥¿ç‚’é£¯','Western Style Fried Rice','ç²¥ç²‰éºªé£¯',[190,5.9,7.4,25,300,17],[680,1300,40,50,170,2000,120]],
['277','é¹¹é­šé›ç²’ç‚’é£¯','Fried Rice with Salted Fish and Chicken','ç²¥ç²‰éºªé£¯',[200,7,6.7,27,330,14],[690,1400,48,46,190,2300,96]],
['278','é±†é­šé›ç²’ç‚’é£¯','Fried Rice with Dried Octopus and Chicken','ç²¥ç²‰éºªé£¯',[200,8.3,7.6,24,290,16],[740,1500,61,56,180,2100,120]],
['279','æ³¢è˜¿é›ç²’ç‚’é£¯','Fried Rice with Pineapple and Chicken','ç²¥ç²‰éºªé£¯',[200,6.2,7.8,25,290,13],[730,1500,45,57,180,2100,95]],
['280','ç‘¤æŸ±è›‹ç™½ç‚’é£¯','Fried Rice with Dried Scallop and Egg White','ç²¥ç²‰éºªé£¯',[180,6.2,4.6,29,300,8.5],[690,1200,43,32,200,2100,59]],
['281','ç”Ÿç‚’ç‰›è‚‰é£¯','Fried Rice with Beef','ç²¥ç²‰éºªé£¯',[200,6.7,7.6,25,330,14],[610,1200,41,46,150,2000,85]],
['282','ç”Ÿç‚’é›çµ²é£¯','Fried Rice with Chicken','ç²¥ç²‰éºªé£¯',[200,7.1,8.2,26,280,14],[600,1200,43,49,160,1700,84]],
['283','é®®èŒ„ç‰›è‚‰é…ç‚’é£¯','Tomato Beef with Fried Rice','ç²¥ç²‰éºªé£¯',[150,5.2,4.9,22,300,11],[780,1200,41,38,170,2300,86]],
['284','å’–å“©ç‰›è…©é£¯','Rice with Curry Beef Brisket','ç²¥ç²‰éºªé£¯',[160,7.7,6.3,18,290,17],[800,1300,62,50,140,2300,140]],
['285','ç‡œè˜¿è””ç‰›è…©é£¯','Rice with Braised Beef Brisket and Radish','ç²¥ç²‰éºªé£¯',[130,7.5,2.7,19,260,10],[750,980,56,20,140,2000,75]],
['286','æ²™çˆ¹ç‰›è‚‰é£¯','Rice with Satay Beef','ç²¥ç²‰éºªé£¯',[120,4.7,2.5,20,320,11],[700,840,33,17,140,2200,77]],
['287','æ™‚èœç‰›è‚‰é£¯','Rice with Beef and Vegetables','ç²¥ç²‰éºªé£¯',[110,4.9,1.6,19,260,12],[700,770,34,11,130,1800,84]],
['288','æ™‚èœè±¬è‚‰ç‰‡é£¯','Rice with Pork and Vegetables','ç²¥ç²‰éºªé£¯',[120,4.6,2.3,20,200,11],[660,800,30,15,130,1300,73]],
['289','ç²Ÿç±³è‚‰ç²’é£¯','Rice with Corn and Diced Pork','ç²¥ç²‰éºªé£¯',[130,5.2,2.3,22,210,7.3],[760,990,40,18,170,1600,56]],
['290','ç„—è±¬æ‰’é£¯','Baked Pork Chop with Rice','ç²¥ç²‰éºªé£¯',[190,7.4,8.8,21,320,18],[710,1300,50,60,140,2200,120]],
['291','æç«¹ç«è…©(ç‡’è‚‰)é£¯','Rice with Roast Pork and Beancurd Sticks','ç²¥ç²‰éºªé£¯',[180,7.5,8.1,19,260,13],[770,1400,57,62,140,2000,99]],
['292','é®®èŒ„ç‰›è‚‰é£¯','Rice with Tomato and Beef','ç²¥ç²‰éºªé£¯',[120,4.6,1.8,21,200,6.6],[780,940,36,14,160,1600,51]],
['293','æ»‘è›‹è¦ä»é£¯','Rice with Scrambled Egg and Shrimp','ç²¥ç²‰éºªé£¯',[130,4.3,2.2,22,180,13],[580,750,25,13,130,1000,75]],
['294','é­šé¦™èŒ„å­é£¯','Rice with Eggplant in Fish-fragrant Sauce','ç²¥ç²‰éºªé£¯',[150,3.5,5.9,19,250,7.7],[720,1100,25,43,140,1800,56]],
['295','å†¬è°è’¸é›é£¯','Rice with Steamed Chicken and Mushroom','ç²¥ç²‰éºªé£¯',[160,6.1,4.4,25,280,9.7],[430,660,25,18,100,1100,40]],
['296','è±‰æ±é³³çˆªæ’éª¨é£¯','Rice with Chicken Feet and Spare Ribs in Black Bean Sauce','ç²¥ç²‰éºªé£¯',[180,5.3,5.4,28,260,12],[490,820,24,25,130,1200,55]],
['297','åœŸé­·(é­·é­š)è’¸è‚‰é¤…é£¯','Rice with Steamed Pork Patty and Dried Squid','ç²¥ç²‰éºªé£¯',[210,7.7,9.6,22,240,8.4],[570,1200,44,54,120,1400,48]],
['298','è’¸é¯‡é­šé£¯','Rice with Steamed Grass Carp','ç²¥ç²‰éºªé£¯',[140,8.4,4.1,18,250,25],[710,930,56,27,120,1700,170]],
['299','å‰ç‡’é£¯','Rice with BBQ Pork','ç²¥ç²‰éºªé£¯',[200,7.3,7.1,26,250,8.7],[520,1000,38,37,130,1300,45]],
['300','ç‡’è‚‰é£¯','Rice with Roast Pork','ç²¥ç²‰éºªé£¯',[200,7.8,8.6,23,260,8.3],[470,930,36,40,110,1200,39]],
['301','ç™½åˆ‡é›é£¯','Rice with Poached Chicken','ç²¥ç²‰éºªé£¯',[180,6.4,5.5,25,270,11],[550,940,33,29,130,1400,57]],
['302','è±‰æ²¹é›é£¯','Rice with Soy Sauce Chicken','ç²¥ç²‰éºªé£¯',[180,6.4,5.7,25,250,16],[460,770,27,24,110,1100,69]],
['303','ç‡’éµé£¯','Rice with Roast Goose','ç²¥ç²‰éºªé£¯',[190,6.7,6.8,26,170,11],[530,970,34,35,130,870,56]],
['304','ç‡’å‘³æ±','Roast Meat Sauce','ç²¥ç²‰éºªé£¯',[63,1.7,0.3,13,1900,7.3],[15,9.5,0.26,0.045,2,290,1.1]],
['305','è–‘è“‰','Ginger Paste','ç²¥ç²‰éºªé£¯',[480,1.7,50,6.4,2000,24],[18,86,0.31,9,1.2,360,4.3]],
['306','é…¸æ¢…é†¬','Plum Sauce','ç²¥ç²‰éºªé£¯',[230,0,0.7,56,1600,19],[20,46,0,0.14,11,320,3.8]],
['307','çå¤šå†° (å°‘ç”œ)','Cendol Icy Drink (Less Sweet)','é£²å“',[72,0,3.8,9.4,13,6.8],0],
['308','çå¤šå†° (æ™®é€š)','Cendol Icy Drink (Regular)','é£²å“',[80,0,3.9,11,12,7],0],
['309','å‡é´›é´¦ (å°‘ç”œ)','Iced Yuan-yang (Less Sweet)','é£²å“',[40,1.3,1.1,6.1,14,34],0],
['310','å‡é´›é´¦ (æ™®é€š)','Iced Yuan-yang (Regular)','é£²å“',[52,1.5,1.3,8.7,16,37],0],
['311','å‡æä»éœœ (å°‘ç”œ)','Iced Almond Drink (Less Sweet)','é£²å“',[43,1.1,1.3,6.8,16,32],0],
['312','å‡æä»éœœ (æ™®é€š)','Iced Almond Drink (Regular)','é£²å“',[51,1.1,1.3,8.9,17,33],0],
['313','å‡æœ±å¤åŠ›å’–å•¡ (å°‘ç”œ)','Iced Caffe Mocha (Less Sweet)','é£²å“',[55,1.4,2.3,7.3,26,40],0],
['314','å‡æœ±å¤åŠ›å’–å•¡ (æ™®é€š)','Iced Caffe Mocha (Regular)','é£²å“',[61,1.5,2.2,8.7,26,43],0],
['315','å‡æ³¡æ²«å’–å•¡ (å°‘ç”œ)','Iced Cappuccino (Less Sweet)','é£²å“',[41,1.1,1.7,5.4,17,36],0],
['316','å‡æ³¡æ²«å’–å•¡ (æ™®é€š)','Iced Cappuccino (Regular)','é£²å“',[50,1.2,1.7,7.6,17,39],0],
['317','å‡æœ±å¤åŠ›é£²å“ (å°‘ç”œ)','Iced Chocolate Drink (Less Sweet)','é£²å“',[46,1.2,1.4,7.2,25,30],0],
['318','å‡æœ±å¤åŠ›é£²å“ (æ™®é€š)','Iced Chocolate Drink (Regular)','é£²å“',[55,1.1,1.5,9.2,27,29],0],
['319','å‡å”‚å’• (å°‘ç”œ)','Iced Cocoa Drink (Less Sweet)','é£²å“',[41,1.7,1.7,4.6,19,40],0],
['320','å‡å”‚å’• (æ™®é€š)','Iced Cocoa Drink (Regular)','é£²å“',[47,1.7,1.8,6.1,19,39],0],
['321','å‡å’–å•¡ (å°‘ç”œ)','Iced Coffee (Less Sweet)','é£²å“',[39,1,1.2,6,16,29],0],
['322','å‡å’–å•¡ (æ™®é€š)','Iced Coffee (Regular)','é£²å“',[48,1,1.3,8.2,16,30],0],
['323','å‡çç ç¶ èŒ¶ (å°‘ç”œ)','Iced Green Tea with Pearl Tapioca (Less Sweet)','é£²å“',[30,0,0,7.3,0,1.5],0],
['324','å‡çç ç¶ èŒ¶ (æ™®é€š)','Iced Green Tea with Pearl Tapioca (Regular)','é£²å“',[41,0,0,10,0,1.6],0],
['325','å‡æª¸æª¬é‡‘æ¡”èœœ (å°‘ç”œ)','Iced Lemon Kumquat Honey (Less Sweet)','é£²å“',[40,0.3,0,9.2,110,4.6],0],
['326','å‡æª¸æª¬é‡‘æ¡”èœœ (æ™®é€š)','Iced Lemon Kumquat Honey (Regular)','é£²å“',[47,0,0,11,110,4.9],0],
['327','å‡æª¸æª¬å’–å•¡ (å°‘ç”œ)','Iced Lemon Coffee (Less Sweet)','é£²å“',[29,0.3,0,6.9,0,6.3],0],
['328','å‡æª¸æª¬å’–å•¡ (æ™®é€š)','Iced Lemon Coffee (Regular)','é£²å“',[38,0.3,0,8.9,0,5.5],0],
['329','å‡æª¸æ¨‚','Iced Lemon Cola','é£²å“',[33,0,0,8,0,3.4],0],
['330','å‡æª¸èœœ (å°‘ç”œ)','Iced Lemon Honey (Less Sweet)','é£²å“',[24,0,0,5.4,0,6.4],0],
['331','å‡æª¸èœœ (æ™®é€š)','Iced Lemon Honey (Regular)','é£²å“',[32,0,0,7.5,0,6.9],0],
['332','å‡æª¸æª¬æ¢³æ‰“','Iced Lemon Soda','é£²å“',[23,0,0,5.5,8.8,3.4],0],
['333','å‡æª¸æª¬èŒ¶ (å°‘ç”œ)','Iced Lemon Tea (Less Sweet)','é£²å“',[29,0,0,6.7,0,4.6],0],
['334','å‡æª¸æª¬èŒ¶ (æ™®é€š)','Iced Lemon Tea (Regular)','é£²å“',[48,0,0.3,11,0,4.5],0],
['335','å‡å¥¶èŒ¶ (å°‘ç”œ)','Iced Milk Tea (Less Sweet)','é£²å“',[34,0.9,0.9,5.5,16,30],0],
['336','å‡çç å¥¶èŒ¶ (å°‘ç”œ)','Iced Milk Tea with Pearl Tapioca (Less Sweet)','é£²å“',[57,0,2.3,9,20,1.6],0],
['337','å‡çç å¥¶èŒ¶ (æ™®é€š)','Iced Milk Tea with Pearl Tapioca (Regular)','é£²å“',[68,0,2.2,12,20,1.6],0],
['338','å‡å¥¶èŒ¶ (æ™®é€š)','Iced Milk Tea (Regular)','é£²å“',[44,1,0.7,8.5,16,31],0],
['339','å‡é¹¹æª¸æª¬æ¢³æ‰“','Iced Salted Lemon Soda','é£²å“',[24,0,0,5.9,240,3.8],0],
['340','å‡è¥¿æ´‹èœèœœ (å°‘ç”œ)','Iced Watercress Honey (Less Sweet)','é£²å“',[26,0,0,6.2,10,3.1],0],
['341','å‡è¥¿æ´‹èœèœœ (æ™®é€š)','Iced Watercress Honey (Regular)','é£²å“',[32,0.3,0,7.6,12,3.6],0],
['342','é¾çœ¼å†° (æ™®é€š)','Longan Icy Drink (Regular)','é£²å“',[54,0,0.8,11,5,5.3],0],
['343','é¾çœ¼å†° (å°‘ç”œ)','Longan Icy Drink (Less Sweet)','é£²å“',[48,0,0.9,9.8,0,6.3],0],
['344','ä»€æœå†° (å°‘ç”œ)','Mixed Fruit Icy Drink (Less Sweet)','é£²å“',[53,0,0.8,11,0,6.4],0],
['345','ä»€æœå†° (æ™®é€š)','Mixed Fruit Icy Drink (Regular)','é£²å“',[56,0,0.8,12,0,6.1],0],
['346','ä»€æœè³“æ²» (å°‘ç”œ)','Mixed Fruit Punch (Less Sweet)','é£²å“',[46,0,0.3,11,0,5.3],0],
['347','ä»€æœè³“æ²» (æ™®é€š)','Mixed Fruit Punch (Regular)','é£²å“',[49,0,0.3,12,0,5.5],0],
['348','è è˜¿å†° (å°‘ç”œ)','Pineapple Icy Drink (Less Sweet)','é£²å“',[41,0,0.4,9.2,0,3.4],0],
['349','è è˜¿å†° (æ™®é€š)','Pineapple Icy Drink (Regular)','é£²å“',[53,0,0.4,12,0,3.6],0],
['350','è è˜¿è³“æ²» (å°‘ç”œ)','Pineapple Punch (Less Sweet)','é£²å“',[38,0,0.4,8.4,0,4.2],0],
['351','è è˜¿è³“æ²» (æ™®é€š)','Pineapple Punch (Regular)','é£²å“',[46,0,0.5,10,0,4.4],0],
['352','ç´…è±†å†° (å°‘ç”œ)','Red Bean Icy Drink (Less Sweet)','é£²å“',[79,2.5,1.1,15,10,31],0],
['353','ç´…è±†å†° (æ™®é€š)','Red Bean Icy Drink (Regular)','é£²å“',[87,2.6,1.2,16,11,34],0],
['354','ç”œè±†æ¼¿ (å‡é£²)','Sweetened Soybean Milk (Cold)','é£²å“',[55,2.1,1.5,8.4,0,9],0],
['355','ä¸‰è‰²å†° (å°‘ç”œ)','Tri-colour Icy Drink (Less Sweet)','é£²å“',[78,1,2.9,12,7,5.9],0],
['356','ä¸‰è‰²å†° (æ™®é€š)','Tri-colour Icy Drink (Regular)','é£²å“',[83,1,2.3,13,8,6],0],
['357','æä»éœœ (ä¸åŠ ç³–)','Almond Drink (No Sugar Added)','é£²å“',[46,1.4,1.7,6.3,24,46],0],
['358','æœ±å¤åŠ›å’–å•¡ (ä¸åŠ ç³–)','Caffe Mocha (No Sugar Added)','é£²å“',[71,2.2,2.8,9.1,43,66],0],
['359','æ³¡æ²«å’–å•¡ (ä¸åŠ ç³–)','Cappuccino (No Sugar Added)','é£²å“',[40,2.1,2.2,3,27,68],0],
['360','æŸšå­èŒ¶','Citron Tea','é£²å“',[47,0,0,11,20,5.2],0],
['361','å”‚å’• (ä¸åŠ ç³–)','Cocoa Drink (No Sugar Added)','é£²å“',[43,2.1,2.2,3.7,26,55],0],
['362','å’–å•¡ (ä¸åŠ ç³–)','Coffee (No Sugar Added)','é£²å“',[43,2,2.4,3.3,33,62],0],
['363','èŒ…æ ¹ç«¹è”—æ°´','Cogon Grass and Sugar Cane Drink','é£²å“',[25,0,0,6.1,0,3.8],0],
['364','ç‰¹æ¿ƒå’–å•¡ (ä¸åŠ ç³–)','Espresso (No Sugar Added)','é£²å“',[12,0.8,0,1.7,0,4.7],0],
['365','äº”èŠ±èŒ¶','Five Flower Tea','é£²å“',[30,0,0,7,0,4.6],0],
['366','èŠ±æ——åƒèœœ','Ginseng Honey','é£²å“',[37,0,0,8.6,0,2.7],0],
['367','çç ç¶ èŒ¶ (ä¸åŠ ç³–)','Green Tea with Pearl Tapioca (No Sugar Added)','é£²å“',[37,0,0,9.2,0,2.5],0],
['368','æœ±å¤åŠ›é£²å“ (ä¸åŠ ç³–)','Hot Chocolate Drink (No Sugar Added)','é£²å“',[57,1.7,2,8.1,38,47],0],
['369','æª¸æª¬é‡‘æ¡”èœœ','Lemon and Kumquat Honey','é£²å“',[54,0,0,13,140,7.7],0],
['370','æª¸æª¬å’–å•¡ (ä¸åŠ ç³–)','Lemon Coffee (No Sugar Added)','é£²å“',[18,0.4,0,3.8,0,9.8],0],
['371','æª¸æ¨‚ (ç†±)','Lemon Cola (Hot)','é£²å“',[42,0,0,10,0,7.8],0],
['372','æª¸èœœ','Lemon Honey','é£²å“',[40,0,0.4,9.1,0,9.8],0],
['373','æª¸æª¬èŒ¶ (ä¸åŠ ç³–)','Lemon Tea (No Sugar Added)','é£²å“',[15,0,0,3.1,0,8.9],0],
['374','å¥¶èŒ¶ (ä¸åŠ ç³–)','Milk Tea (No Sugar Added)','é£²å“',[46,2.3,2.7,3.2,40,77],0],
['375','çç å¥¶èŒ¶ (ä¸åŠ ç³–)','Milk Tea with Pearl Tapioca (No Sugar Added)','é£²å“',[75,0.3,2.8,12,25,2.6],0],
['376','é…¸æ¢…æ¹¯','Sour Plum Drink','é£²å“',[51,0,0,12,0,6],0],
['377','è±†æ¼¿ (ä¸åŠ ç³–)','Soybean Milk (No Sugar Added)','é£²å“',[28,2.4,1.6,0.9,0,9.7],0],
['378','è¥¿æ´‹èœèœœ','Watercress Honey','é£²å“',[36,0,0,8.6,13,4.5],0],
['379','é´›é´¦ (ä¸åŠ ç³–)','Yuan-yang (No Sugar Added)','é£²å“',[53,2.5,2.4,5.3,31,70],0],
['380','ä¹¾ç‚’ç‰›æ²³','Stir-fried Beef Ho Fun','æ¸¯å¼å°èœ',[186,N,7.4,N,494,N],[442,822,N,33,N,2200,N]],
['381','æšå·ç‚’é£¯','Yangzhou Fried Rice','æ¸¯å¼å°èœ',[185,N,7,N,414,N],[379,701,N,26,N,1560,N]],
['382','æ˜Ÿæ´²ç‚’ç±³','Singapore Fried Vermicelli','æ¸¯å¼å°èœ',[159,N,5.5,N,576,N],[392,624,N,22,N,2240,N]],
['383','è‚‰çµ²ç‚’éºµ','Stir-fried Noodles with Shredded Pork','æ¸¯å¼å°èœ',[190,N,7.6,N,607,N],[402,763,N,31,N,2410,N]],
['384','é®®èŒ„ç‰›è‚‰é£¯','Beef with Fresh Tomato on Rice','æ¸¯å¼å°èœ',[125,N,3.5,N,350,N],[447,559,N,16,N,1560,N]],
['385','å’•åš•è‚‰é£¯','Sweet and Sour Pork on Rice','æ¸¯å¼å°èœ',[153,N,5.2,N,278,N],[446,682,N,23,N,1240,N]],
['386','è¥¿èŠ¹é›æŸ³é£¯','Chicken with Celery on Rice','æ¸¯å¼å°èœ',[125,N,3.1,N,359,N],[439,549,N,13,N,1560,N]],
['387','è±‰æ¤’æ’éª¨é£¯','Spare Ribs with Black Bean Sauce on Rice','æ¸¯å¼å°èœ',[155,N,5.8,N,394,N],[455,705,N,26,N,1800,N]],
['388','ç‘å£«é›ç¿¼é£¯','Swiss Chicken Wings on Rice','æ¸¯å¼å°èœ',[150,N,4.9,N,381,N],[445,668,N,22,N,1690,N]],
['389','ç«è…¿è›‹ç‚’é£¯','Ham and Egg Fried Rice','æ¸¯å¼å°èœ',[180,N,6.9,N,536,N],[386,694,N,26,N,2050,N]],
['390','é¹¹è›‹è’¸è‚‰é¤…','Steamed Minced Pork with Salted Egg','æ¸¯å¼å°èœ',[271,N,6,N,480,N],[278,753,N,18,N,1668,N]],
['391','èœç±³é­šæ»‘','Minced Fish with Vegetables on Rice','æ¸¯å¼å°èœ',[154,N,1.6,N,450,N],[423,651,N,6,N,1930,N]],
['392','æ¢…èœè‚‰ç²’å››å­£è±†','Preserved Vegetables with Minced Pork and French Beans','æ¸¯å¼å°èœ',[128,N,1.8,N,286,N],[246,315,N,5,N,1082,N]],
['393','è¦ä»ç‚’è›‹','Scrambled Eggs with Shrimp','æ¸¯å¼å°èœ',[205,N,2.8,N,398,N],[348,714,N,14,N,1852,N]],
['394','é­šé¦™èŒ„å­ç…²','Fish-flavoured Eggplant Hot Pot','æ¸¯å¼å°èœ',[131,N,0.4,N,483,N],[464,609,N,6,N,1968,N]],
['395','ç²Ÿç±³ç´ é­šå¡Š','Vegetarian Corn Fish Fillet','ä¸­å¼ç´ èœ',[102,N,5.6,N,376,N],[383,373,N,23,N,1490,N]],
['396','é½‹é¹µå‘³æ‹¼ç›¤','Vegetarian Braised Platter','ä¸­å¼ç´ èœ',[174,N,7.4,N,355,N],[585,906,N,37,N,2030,N]],
['397','ç´ é­šé¦™èŒ„å­','Vegetarian Fish-flavoured Eggplant','ä¸­å¼ç´ èœ',[68,N,7.8,N,350,N],[477,289,N,22,N,1476,N]],
['398','ç¾…æ¼¢é½‹','Lo Han Jai (Buddha\'s Delight)','ä¸­å¼ç´ èœ',[67,N,5.5,N,330,N],[519,336,N,20,N,1830,N]],
['399','ç´ ç¦å»ºç‚’é£¯','Vegetarian Fujian Fried Rice','ä¸­å¼ç´ èœ',[120,N,3.9,N,290,N],[835,899,N,27,N,2440,N]],
['400','ç´…ç‡’è±†è…','Braised Tofu','ä¸­å¼ç´ èœ',[92,N,5.5,N,313,N],[387,234,N,13,N,809,N]],
['401','è è˜¿ç´ å’•åš•è‚‰','Vegetarian Sweet and Sour Pork with Pineapple','ä¸­å¼ç´ èœ',[116,N,6.5,N,317,N],[428,510,N,17,N,653,N]],
['402','æ»‹å‘³é½‹','Assorted Vegetarian Delicacies','ä¸­å¼ç´ èœ',[127,N,7.7,N,410,N],[400,480,N,34,N,872,N]],
['403','èŠ‹é ­é­š','Vegetarian Taro Fish','ä¸­å¼ç´ èœ',[92,N,2,N,204,N],[255,669,N,18,N,588,N]]
]);
const BUILT_IN_FOOD_COUNT = foods.length;
document.addEventListener('DOMContentLoaded', async () => {
   try {
    await openDatabase();
    await loadFromIndexedDB();
    await loadDocs();
    const savedAutoSync = await loadAutoSyncSetting();
    autoSyncEnabled = savedAutoSync;
    setTimeout(autoSyncOnLoad, 1000);
   } catch (err) {}
   if (!foods || foods.length === 0) {
    foods = _F([]);
    console.log('Safety net: foods was empty, this should not happen');
   }
   renderCategories();
   renderCategoryPills();
   renderFoodList();
   updateStats();
   setupEventListeners();
  });
  function setupEventListeners() {
   document.getElementById('searchInput').addEventListener('input', (e) => {
    renderFoodList(e.target.value);
   });
   document.getElementById('foodForm').addEventListener('submit', handleFormSubmit);
   document.addEventListener('click', (e) => {
    if (!e.target.closest('.header-menu-container')) {
     document.getElementById('dropdownMenu').classList.remove('show');
    }
   });
  }
  function toggleMenu() {
   event.stopPropagation();
   document.getElementById('dropdownMenu').classList.toggle('show');
  }
  function showCategoryManager() {
   document.getElementById('dropdownMenu').classList.remove('show');
   document.getElementById('homePage').classList.remove('active');
   document.getElementById('categoryPage').classList.add('active');
   document.getElementById('fab').style.display = 'none';
   document.getElementById('homeBtn').style.display = 'flex';
  }
  function backToHome() {
   document.getElementById('categoryPage').classList.remove('active');
   document.getElementById('homePage').classList.add('active');
   document.getElementById('fab').style.display = 'flex';
   document.getElementById('homeBtn').style.display = 'none';
  }
  function goToHomePage() {
   document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
   document.getElementById('homePage').classList.add('active');
   document.getElementById('fab').style.display = 'flex';
   document.getElementById('homeBtn').style.display = 'none';
  }
  function renderCategoryPills() {
   const container = document.getElementById('categoryPills');
   const allCategories = ['å…¨éƒ¨', ...categories];
   container.innerHTML = allCategories.map(cat => {
    const emoji = categoryEmojis[cat] || '';
    return `
     <button class="category-pill ${cat === currentFilter ? 'active' : ''}"
         onclick="filterByCategory('${cat}')">
      ${cat !== 'å…¨éƒ¨' && emoji ? `<span class="emoji">${emoji}</span>` : ''}
      ${cat}
     </button>
    `;
   }).join('');
  }
  function filterByCategory(category) {
   currentFilter = category;
   renderCategoryPills();
   renderFoodList(document.getElementById('searchInput').value);
  }
  function toggleDisplayMode(event, foodId) {
   event.stopPropagation();
   if (showPer100gSet.has(foodId)) {
    showPer100gSet.delete(foodId);
    showToast('å·²åˆ‡æ›è‡³æ¯ä»½é¡¯ç¤º');
   } else {
    showPer100gSet.add(foodId);
    showToast('å·²åˆ‡æ›è‡³æ¯100gé¡¯ç¤º');
   }
   renderFoodList(document.getElementById('searchInput').value);
  }
  function renderFoodList(searchTerm = '') {
   const container = document.getElementById('foodList');
   let filteredFoods = foods;
   if (currentFilter !== 'å…¨éƒ¨') {
    filteredFoods = filteredFoods.filter(f => f.category === currentFilter);
   }
   if (searchTerm) {
    const term = searchTerm.toLowerCase();
    filteredFoods = filteredFoods.filter(f =>
     f.name.toLowerCase().includes(term) ||
     (f.nameEn && f.nameEn.toLowerCase().includes(term)) ||
     f.category.toLowerCase().includes(term)
    );
   }
   if (filteredFoods.length === 0) {
    container.innerHTML = `
     <div class="empty-state">
      <i class="fas fa-bowl-food"></i>
      <h3>æš«ç„¡è³‡æ–™</h3>
      <p>é»æ“Šå³ä¸‹è§’ã€Œ+ã€æŒ‰éˆ•é–‹å§‹å»ºç«‹ä½ å˜…ç‡Ÿé¤Šè³‡æ–™åº«</p>
     </div>
    `;
    return;
   }
   container.innerHTML = filteredFoods.map(food => {
    const ps = food.perServing;
    const p100 = food.per100g;
    const emoji = categoryEmojis[food.category] || '';
    let filledPs = ps;
    if (ps && ps.weight && p100) {
     const w = ps.weight;
     const calcFromP100 = (p100Val, decimals) => {
      if (p100Val === null || p100Val === undefined) return null;
      const result = p100Val * w / 100;
      return decimals === 0 ? Math.round(result) : Math.round(result * Math.pow(10, decimals)) / Math.pow(10, decimals);
     };
     filledPs = {
      weight: w,
      calories: calcFromP100(p100.calories, 0),
      protein: calcFromP100(p100.protein, 1),
      fat: calcFromP100(p100.fat, 1),
      carbs: calcFromP100(p100.carbs, 1),
      sodium: calcFromP100(p100.sodium, 0),
      calcium: calcFromP100(p100.calcium, 0)
     };
    }
    const showPer100g = showPer100gSet.has(food.id);
    const hasPerServing = filledPs && filledPs.weight && (filledPs.calories !== null && filledPs.calories !== undefined);
    const hasPer100g = p100 && (p100.calories !== null && p100.calories !== undefined);
    let data, modeText, modeClass;
    if (hasPerServing && hasPer100g) {
     data = showPer100g ? p100 : filledPs;
     modeText = showPer100g ? 'æ¯100g' : (filledPs.weight ? `æ¯ä»½ ${filledPs.weight}g` : 'æ¯ä»½');
     modeClass = showPer100g ? 'per100g' : 'perserving';
    } else if (hasPerServing) {
     data = filledPs;
     modeText = filledPs.weight ? `æ¯ä»½ ${filledPs.weight}g` : 'æ¯ä»½';
     modeClass = 'perserving';
    } else {
     data = p100;
     modeText = 'æ¯100g';
     modeClass = 'per100g';
    }
    return `
    <div class="food-card">
     <div class="food-card-header">
      <div>
       <div class="food-name">${food.name}</div>
       <div class="food-meta">
        <span class="food-category-tag">
         ${emoji ? `<span>${emoji}</span>` : ''}
         ${food.category}
        </span>
        ${food.brand ? `<span class="food-serving-tag"><i class="fas fa-tag"></i> ${food.brand}</span>` : ''}
        <span class="nutrition-mode-tag ${modeClass}" onclick="toggleDisplayMode(event, '${food.id}')" title="é»æ“Šåˆ‡æ›é¡¯ç¤ºæ¨¡å¼">
         ${modeText} <i class="fas fa-sync-alt"></i>
        </span>
       </div>
      </div>
      <div class="food-card-actions">
       <button class="action-icon-btn" onclick="editFood('${food.id}')" title="ç·¨è¼¯">
        <i class="fas fa-pen"></i>
       </button>
       <button class="action-icon-btn delete" onclick="confirmDeleteFood('${food.id}')" title="åˆªé™¤">
        <i class="fas fa-trash"></i>
       </button>
      </div>
     </div>
     <div class="nutrition-grid" onclick="toggleDisplayMode(event, '${food.id}')" title="é»æ“Šåˆ‡æ›é¡¯ç¤ºæ¨¡å¼">
      <div class="nutrition-box cal">
       <div class="nutrition-value">${data.calories !== null && data.calories !== undefined ? data.calories : '--'}</div>
       <div class="nutrition-label">KCAL</div>
      </div>
      <div class="nutrition-box protein">
       <div class="nutrition-value">${data.protein !== null && data.protein !== undefined ? data.protein + 'g' : '--'}</div>
       <div class="nutrition-label">è›‹ç™½è³ª</div>
      </div>
      <div class="nutrition-box fat">
       <div class="nutrition-value">${data.fat !== null && data.fat !== undefined ? data.fat + 'g' : '--'}</div>
       <div class="nutrition-label">è„‚è‚ª</div>
      </div>
      <div class="nutrition-box carbs">
       <div class="nutrition-value">${data.carbs !== null && data.carbs !== undefined ? data.carbs + 'g' : '--'}</div>
       <div class="nutrition-label">ç¢³æ°´</div>
      </div>
      ${data.sodium !== null && data.sodium !== undefined ? `
      <div class="nutrition-box sodium">
       <div class="nutrition-value">${data.sodium}</div>
       <div class="nutrition-label">éˆ‰ MG</div>
      </div>
      ` : ''}
      ${data.calcium !== null && data.calcium !== undefined ? `
      <div class="nutrition-box calcium">
       <div class="nutrition-value">${data.calcium}</div>
       <div class="nutrition-label">éˆ£ MG</div>
      </div>
      ` : ''}
     </div>
     <div class="food-footer">
      <i class="fas fa-info-circle"></i>
      <span>${food.brand ? food.brand + ' Â· ' : ''}${food.nameEn || food.name} | ${food.source || (food.category === 'éº¥ç•¶å‹' ? 'éº¥ç•¶å‹é¦™æ¸¯' : 'é£Ÿå®‰ä¸­å¿ƒ')}</span>
     </div>
    </div>
   `}).join('');
  }
  function renderCategories() {
   const select = document.getElementById('foodCategory');
   select.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('') +
    '<option value="__new__">â• æ–°å¢åˆ†é¡...</option>';
   const list = document.getElementById('categoryList');
   list.innerHTML = categories.map(cat => {
    const count = foods.filter(f => f.category === cat).length;
    const emoji = categoryEmojis[cat] || '';
    return `
     <div class="category-item">
      <div>
       <span class="category-item-name">${emoji} ${cat}</span>
       <span class="category-item-count"> Â· ${count} é …</span>
      </div>
      <div class="category-actions">
       <button class="category-edit-btn" onclick="showEditCategoryModal('${cat}')" title="ç·¨è¼¯åˆ†é¡">
        <i class="fas fa-pen"></i>
       </button>
       <button class="category-delete-btn" onclick="confirmDeleteCategory('${cat}')" title="åˆªé™¤åˆ†é¡">
        <i class="fas fa-minus-circle"></i>
       </button>
      </div>
     </div>
    `;
   }).join('');
  }
  function addCategory() {
   const input = document.getElementById('newCategoryInput');
   const emojiInput = document.getElementById('newCategoryEmojiInput');
   const name = input.value.trim();
   const emoji = emojiInput ? emojiInput.value.trim() : '';
   if (name && !categories.includes(name)) {
    categories.push(name);
    if (emoji) {
     categoryEmojis[name] = emoji;
    }
    input.value = '';
    if (emojiInput) emojiInput.value = '';
    renderCategories();
    renderCategoryPills();
    updateStats();
    saveToIndexedDB(); // Auto-save to IndexedDB
    doAutoSync(); // Auto-sync to cloud
    showToast('å·²æ–°å¢åˆ†é¡');
   }
  }
  function confirmDeleteCategory(name) {
   const count = foods.filter(f => f.category === name).length;
   showConfirmModal(
    'ç¢ºèªåˆªé™¤åˆ†é¡ï¼Ÿ',
    count > 0 ? `æ­¤åˆ†é¡ä¸‹æœ‰ ${count} å€‹é …ç›®ï¼Œåˆªé™¤å¾Œé …ç›®æœƒè¢«ç§»è‡³ã€Œå…¶ä»–ã€åˆ†é¡ã€‚` : 'ç¢ºå®šè¦åˆªé™¤æ­¤åˆ†é¡å—ï¼Ÿ',
    () => deleteCategory(name)
   );
  }
  function deleteCategory(name) {
   foods.forEach(f => {
    if (f.category === name) f.category = 'å…¶ä»–';
   });
   categories = categories.filter(c => c !== name);
   if (!categories.includes('å…¶ä»–')) categories.push('å…¶ä»–');
   renderCategories();
   renderCategoryPills();
   renderFoodList();
   updateStats();
   saveToIndexedDB(); // Auto-save to IndexedDB
   doAutoSync(); // Auto-sync to cloud
   closeConfirmModal();
   showToast('å·²åˆªé™¤åˆ†é¡');
  }
  function showEditCategoryModal(name) {
   document.getElementById('editCategoryOriginal').value = name;
   document.getElementById('editCategoryName').value = name;
   document.getElementById('editCategoryEmoji').value = categoryEmojis[name] || '';
   document.getElementById('editCategoryModal').classList.add('active');
  }
  function closeEditCategoryModal() {
   document.getElementById('editCategoryModal').classList.remove('active');
  }
  function saveEditCategory() {
   const originalName = document.getElementById('editCategoryOriginal').value;
   const newName = document.getElementById('editCategoryName').value.trim();
   const newEmoji = document.getElementById('editCategoryEmoji').value.trim();
   if (!newName) {
    showToast('è«‹è¼¸å…¥åˆ†é¡åç¨±');
    return;
   }
   if (newName !== originalName && categories.includes(newName)) {
    showToast('æ­¤åˆ†é¡åç¨±å·²å­˜åœ¨');
    return;
   }
   const index = categories.indexOf(originalName);
   if (index !== -1) {
    categories[index] = newName;
   }
   foods.forEach(f => {
    if (f.category === originalName) {
     f.category = newName;
    }
   });
   if (originalName !== newName) {
    delete categoryEmojis[originalName];
   }
   if (newEmoji) {
    categoryEmojis[newName] = newEmoji;
   } else {
    delete categoryEmojis[newName];
   }
   renderCategories();
   renderCategoryPills();
   renderFoodList();
   updateStats();
   saveToIndexedDB();
   doAutoSync();
   closeEditCategoryModal();
   showToast('å·²æ›´æ–°åˆ†é¡');
  }
  function setInputMode(mode) {
   formInputMode = mode;
   const per100gBtn = document.getElementById('inputModePer100g');
   const perServingBtn = document.getElementById('inputModePerServing');
   const servingWeightLabel = document.getElementById('servingWeightLabel');
   const servingWeightInput = document.getElementById('servingWeight');
   const nutritionTitle = document.getElementById('nutritionSectionTitle');
   if (mode === 'per100g') {
    per100gBtn.classList.add('active');
    perServingBtn.classList.remove('active');
    servingWeightLabel.innerHTML = 'æ¯ä»½é‡é‡ (g) <span style="color: var(--text-secondary);">- é¸å¡«</span>';
    servingWeightInput.placeholder = 'é¸å¡«ï¼ˆå¡«å¯«å¾Œå¯è‡ªå‹•è¨ˆç®—æ¯ä»½ç‡Ÿé¤Šï¼‰';
    nutritionTitle.textContent = 'ç‡Ÿé¤Šè³‡æ–™ (æ¯100g)';
   } else {
    per100gBtn.classList.remove('active');
    perServingBtn.classList.add('active');
    servingWeightLabel.innerHTML = 'æ¯ä»½é‡é‡ (g) <span style="color: var(--accent);">*å¿…å¡«</span>';
    servingWeightInput.placeholder = 'ä¾‹å¦‚ï¼š31';
    nutritionTitle.textContent = 'ç‡Ÿé¤Šè³‡æ–™ (æ¯é£Ÿç”¨ä»½é‡)';
   }
  }
  function setAIInputMode(mode) {
   aiImportInputMode = mode;
   const per100gBtn = document.getElementById('aiInputModePer100g');
   const perServingBtn = document.getElementById('aiInputModePerServing');
   if (mode === 'per100g') {
    per100gBtn.classList.add('active');
    perServingBtn.classList.remove('active');
   } else {
    per100gBtn.classList.remove('active');
    perServingBtn.classList.add('active');
   }
  }
  function toggleNewCategoryInput() {
   const select = document.getElementById('foodCategory');
   const newCategoryGroup = document.getElementById('newCategoryGroup');
   if (select.value === '__new__') {
    newCategoryGroup.style.display = 'block';
    document.getElementById('newCategoryName').focus();
   } else {
    newCategoryGroup.style.display = 'none';
    document.getElementById('newCategoryName').value = '';
    document.getElementById('newCategoryEmoji').value = '';
   }
  }
  function openAddModal() {
   document.getElementById('modalTitle').textContent = 'æ–°å¢é£Ÿç‰©';
   document.getElementById('submitBtn').textContent = 'å„²å­˜';
   document.getElementById('foodForm').reset();
   document.getElementById('editId').value = '';
   document.getElementById('foodSource').value = 'ç‡Ÿé¤Šæ¨™ç±¤';
   setInputMode('per100g');
   clearScanPreview();
   document.getElementById('newCategoryGroup').style.display = 'none';
   document.getElementById('newCategoryName').value = '';
   document.getElementById('newCategoryEmoji').value = '';
   document.getElementById('addModal').classList.add('active');
  }
  function closeModal() {
   document.getElementById('addModal').classList.remove('active');
   clearScanPreview();
   document.getElementById('newCategoryGroup').style.display = 'none';
   document.getElementById('newCategoryName').value = '';
   document.getElementById('newCategoryEmoji').value = '';
  }
  let currentImageFile = null;
  function handleLabelImage(event) {
   const file = event.target.files[0];
   if (!file) return;
   currentImageFile = file;
   const reader = new FileReader();
   reader.onload = (e) => {
    document.getElementById('scanPreviewImg').src = e.target.result;
    document.getElementById('scanPreview').classList.add('show');
   };
   reader.readAsDataURL(file);
   scanNutritionLabel(file);
   event.target.value = '';
  }
  function clearScanPreview() {
   document.getElementById('scanPreview').classList.remove('show');
   document.getElementById('scanPreviewImg').src = '';
   document.getElementById('scanStatus').classList.remove('show', 'success', 'error');
   document.getElementById('scanStatus').textContent = '';
   document.getElementById('scanLabelBtn').classList.remove('scanning');
   document.getElementById('scanLabelBtn').querySelector('span').textContent = 'æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤';
   currentImageFile = null;
  }
  function setScanStatus(message, type = '') {
   const status = document.getElementById('scanStatus');
   status.textContent = message;
   status.classList.remove('success', 'error');
   if (type) status.classList.add(type);
   status.classList.add('show');
  }
  let nutritionScanHandlerRegistered = false;
  function registerNutritionScanHandler() {
   if (nutritionScanHandlerRegistered) return;
   if (!window.Poe || !window.Poe.registerHandler) return;
   nutritionScanHandlerRegistered = true;
   window.Poe.registerHandler('nutrition-scan-handler', (result) => {
    const btn = document.getElementById('scanLabelBtn');
    if (!btn) return;
    const msg = result.responses[0];
    console.log('Nutrition scan response:', JSON.stringify(msg.status), msg.content ? msg.content.substring(0, 200) : 'no content');
    if (msg.status === 'error') {
     btn.classList.remove('scanning');
     btn.querySelector('i').className = 'fas fa-camera';
     btn.querySelector('span').textContent = 'æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤';
     setScanStatus('è­˜åˆ¥å¤±æ•—ï¼š' + (msg.statusText || 'è«‹é‡è©¦'), 'error');
     return;
    }
    if (msg.status === 'incomplete') {
     setScanStatus('æ­£åœ¨åˆ†æä¸­...');
     return;
    }
    if (msg.status === 'complete') {
     btn.classList.remove('scanning');
     btn.querySelector('i').className = 'fas fa-camera';
     btn.querySelector('span').textContent = 'æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤';
     try {
      const content = msg.content;
            const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
       const data = JSON.parse(jsonMatch[0]);
       fillFormWithScannedData(data);
       setScanStatus('âœ“ å·²è‡ªå‹•å¡«å…¥è­˜åˆ¥åˆ°çš„ç‡Ÿé¤Šè³‡æ–™', 'success');
      } else {
       setScanStatus('ç„¡æ³•è§£æç‡Ÿé¤Šè³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥', 'error');
      }
     } catch (err) {
            setScanStatus('è§£æå¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥', 'error');
     }
    }
   });
  }
  async function scanNutritionLabel(file) {
   const btn = document.getElementById('scanLabelBtn');
   btn.classList.add('scanning');
   btn.querySelector('i').className = 'fas fa-spinner';
   btn.querySelector('span').textContent = 'è­˜åˆ¥ä¸­...';
   if (!window.Poe || !window.Poe.sendUserMessage) {
    await scanWithOCR(file, btn);
    return;
   }
   setScanStatus('æ­£åœ¨åˆ†æç‡Ÿé¤Šæ¨™ç±¤...');
   registerNutritionScanHandler();
   try {
    const prompt = `@GPT-5.2 è«‹åˆ†æé€™å¼µç‡Ÿé¤Šæ¨™ç±¤åœ–ç‰‡ï¼Œæå–ä»¥ä¸‹è³‡è¨Šä¸¦ä»¥ç´” JSON æ ¼å¼å›è¦†ï¼ˆä¸è¦ markdownï¼‰ï¼š
{
 "name": "é£Ÿç‰©åç¨±ï¼ˆç¹é«”ä¸­æ–‡ï¼‰",
 "nameEn": "é£Ÿç‰©åç¨±ï¼ˆè‹±æ–‡ï¼Œå¦‚æœçœ‹åˆ°çš„è©±ï¼‰",
 "mode": "per100g æˆ– perServingï¼ˆæ ¹æ“šæ¨™ç±¤ä¸Šçš„æ•¸æ“šåŸºæº–ï¼‰",
 "servingWeight": æ¯ä»½é‡é‡æ•¸å­—ï¼ˆå¦‚æœæ˜¯æ¯ä»½çš„è©±ï¼Œå–®ä½å…‹ï¼‰,
 "calories": ç†±é‡æ•¸å­—ï¼ˆkcalï¼‰,
 "protein": è›‹ç™½è³ªæ•¸å­—ï¼ˆgï¼‰,
 "fat": è„‚è‚ªæ•¸å­—ï¼ˆgï¼‰,
 "carbs": ç¢³æ°´åŒ–åˆç‰©æ•¸å­—ï¼ˆgï¼‰,
 "sodium": éˆ‰æ•¸å­—ï¼ˆmgï¼Œå¦‚ç„¡å‰‡ nullï¼‰,
 "calcium": éˆ£æ•¸å­—ï¼ˆmgï¼Œå¦‚ç„¡å‰‡ nullï¼‰
}
æ³¨æ„ï¼š
- åªå›è¦† JSONï¼Œä¸è¦å…¶ä»–æ–‡å­—
- é£Ÿç‰©åç¨± (name) å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼š
 - å¦‚æœæ¨™ç±¤ä¸Šæ˜¯ç°¡é«”ä¸­æ–‡ï¼Œè«‹ç¿»è­¯æˆç¹é«”ä¸­æ–‡
 - å¦‚æœæ¨™ç±¤ä¸Šåªæœ‰è‹±æ–‡ï¼Œè«‹ç¿»è­¯æˆç¹é«”ä¸­æ–‡
 - ä¾‹å¦‚ï¼šã€Œé¸¡è‚‰ã€â†’ã€Œé›è‚‰ã€ï¼Œã€ŒChicken Breastã€â†’ã€Œé›èƒ¸è‚‰ã€
- å¦‚æœæ˜¯ã€Œæ¯100å…‹ã€æˆ–ã€Œper 100gã€å‰‡ mode ç‚º "per100g"
- å¦‚æœæ˜¯ã€Œæ¯ä»½ã€æˆ–ã€Œper servingã€å‰‡ mode ç‚º "perServing"
- æ•¸å­—ä¸è¦å¸¶å–®ä½ï¼Œåªè¦ç´”æ•¸å­—
- å¦‚æœæ‰¾ä¸åˆ°æŸé …è³‡æ–™ï¼Œå¡« null`;
    await window.Poe.sendUserMessage(prompt, {
     attachments: [file],
     handler: 'nutrition-scan-handler',
     stream: false,
     openChat: false
    });
   } catch (err) {
    btn.classList.remove('scanning');
    btn.querySelector('i').className = 'fas fa-camera';
    btn.querySelector('span').textContent = 'æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤';
    setScanStatus('ç™¼é€å¤±æ•—ï¼š' + err.message, 'error');
   }
  }
  let tesseractLoadPromise = null;
  async function loadTesseract() {
   if (typeof Tesseract !== 'undefined') return true;
   if (tesseractLoadPromise) {
    return tesseractLoadPromise;
   }
   tesseractLoadPromise = new Promise((resolve) => {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
    script.onload = () => resolve(true);
    script.onerror = () => resolve(false);
    document.head.appendChild(script);
   });
   return tesseractLoadPromise;
  }
  async function scanWithOCR(file, btn) {
   setScanStatus('æ­£åœ¨è¼‰å…¥ OCR å¼•æ“...');
   const loaded = await loadTesseract();
   if (!loaded || typeof Tesseract === 'undefined') {
    btn.classList.remove('scanning');
    btn.querySelector('i').className = 'fas fa-camera';
    btn.querySelector('span').textContent = 'æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤';
    setScanStatus('OCR åŠŸèƒ½ç„¡æ³•è¼‰å…¥ã€‚æ­¤åŠŸèƒ½éœ€è¦ç¶²çµ¡é€£æ¥ï¼Œæˆ–è«‹åœ¨ Poe å…§ä½¿ç”¨ AI æ¨¡å¼ã€‚', 'error');
    return;
   }
   setScanStatus('æ­£åœ¨é è™•ç†åœ–ç‰‡...');
   try {
    let processedBlob = null;
    try {
     const img = new Image();
     const imgUrl = URL.createObjectURL(file);
     await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = imgUrl;
     });
     URL.revokeObjectURL(imgUrl);
     processedBlob = await preprocessImageForOCR(img);
    } catch (prepErr) {
         }
    const ocrTarget = processedBlob ? URL.createObjectURL(processedBlob) : URL.createObjectURL(file);
    setScanStatus('æ­£åœ¨è­˜åˆ¥æ–‡å­—ï¼ˆå¢å¼·æ¨¡å¼ï¼‰...');
    const result = await Tesseract.recognize(ocrTarget, 'eng+chi_tra+chi_sim', {
     logger: m => {
      if (m.status === 'recognizing text') {
       const progress = Math.round(m.progress * 100);
       setScanStatus(`OCR è­˜åˆ¥ä¸­... ${progress}%`);
      }
     }
    });
    URL.revokeObjectURL(ocrTarget);
    let text = result.data.text;
        if (processedBlob) {
     try {
      const origUrl = URL.createObjectURL(file);
      const result2 = await Tesseract.recognize(origUrl, 'eng+chi_tra+chi_sim');
      URL.revokeObjectURL(origUrl);
      const data1 = parseNutritionFromOCR(text);
      const data2 = parseNutritionFromOCR(result2.data.text);
      const count1 = data1 ? [data1.calories, data1.protein, data1.fat, data1.carbs].filter(v => v !== null).length : 0;
      const count2 = data2 ? [data2.calories, data2.protein, data2.fat, data2.carbs].filter(v => v !== null).length : 0;
      if (count2 > count1) text = result2.data.text;
     } catch (e2) {
           }
    }
    const nutritionData = parseNutritionFromOCR(text);
    btn.classList.remove('scanning');
    btn.querySelector('i').className = 'fas fa-camera';
    btn.querySelector('span').textContent = 'æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤';
    if (nutritionData) {
     fillFormWithScannedData(nutritionData);
     setScanStatus('âœ“ å·²è­˜åˆ¥ç‡Ÿé¤Šè³‡æ–™ï¼ˆå¢å¼· OCR æ¨¡å¼ï¼‰', 'success');
    } else {
     setScanStatus('ç„¡æ³•å¾åœ–ç‰‡ä¸­è­˜åˆ¥ç‡Ÿé¤Šè³‡æ–™ï¼Œè«‹æ‰‹å‹•è¼¸å…¥', 'error');
    }
   } catch (err) {
    console.error('OCR Error:', err);
    btn.classList.remove('scanning');
    btn.querySelector('i').className = 'fas fa-camera';
    btn.querySelector('span').textContent = 'æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤';
    setScanStatus('OCR è­˜åˆ¥å¤±æ•—ï¼š' + err.message, 'error');
   }
  }
  function parseNutritionFromOCR(text) {
   const data = {
    name: null,
    nameEn: null,
    mode: 'per100g',
    servingWeight: null,
    calories: null,
    protein: null,
    fat: null,
    carbs: null,
    sodium: null,
    calcium: null
   };
   let cleanText = text
    .replace(/[oO](?=\d)/g, '0')
    .replace(/[lI](?=\d)/g, '1')
    .replace(/ï¼Œ/g, ',')
    .replace(/ã€‚/g, '.')
    .replace(/ï¼š/g, ':')
    .replace(/ï¼ˆ/g, '(')
    .replace(/ï¼‰/g, ')')
    .replace(/\s+/g, ' ');
   const normalizedText = cleanText.toLowerCase();
   if (/per\s*serv|æ¯ä»½|æ¯é£Ÿç”¨ä»½é‡|serving\s*size/i.test(normalizedText)) {
    data.mode = 'perServing';
   }
   const servingPatterns = [
    /(?:serving\s*size|æ¯ä»½|ä»½é‡|æ¯é£Ÿç”¨ä»½é‡)[:\s]*[ç´„]?(\d+(?:\.\d+)?)\s*(?:g|å…‹|å…¬å…‹|ml|æ¯«å‡)/i,
    /(\d+(?:\.\d+)?)\s*(?:g|å…‹|å…¬å…‹|ml|æ¯«å‡)\s*(?:\/|per)\s*(?:serving|ä»½)/i,
    /æ¯ä»½[ç´„]?(\d+(?:\.\d+)?)\s*(?:g|å…‹)/i
   ];
   for (const pattern of servingPatterns) {
    const match = cleanText.match(pattern);
    if (match) {
     data.servingWeight = parseFloat(match[1]);
     break;
    }
   }
   const kjPatterns = [
    /(?:ç†±é‡|èƒ½é‡|calories|energy)[:\s\/|]*(\d+(?:[.,]\d+)?)\s*(?:kj|åƒç„¦|åƒç„¦è€³)/i,
    /(\d+(?:[.,]\d+)?)\s*(?:kj|åƒç„¦|åƒç„¦è€³)/i
   ];
   for (const pattern of kjPatterns) {
    const match = cleanText.match(pattern);
    if (match) {
     const kj = parseFloat(match[1].replace(',', '.'));
     data.calories = Math.round(kj / 4.184);
     break;
    }
   }
   if (data.calories === null) {
    const caloriesPatterns = [
     /(?:ç†±é‡|èƒ½é‡|calories|energy|cal)[:\s\/|]*(\d+(?:[.,]\d+)?)\s*(?:kcal|åƒå¡|å¤§å¡|å¡è·¯é‡Œ|å¡)/i,
     /(\d+(?:[.,]\d+)?)\s*(?:kcal|åƒå¡|å¤§å¡)/i,
     /(?:ç†±é‡|èƒ½é‡|energy)[:\s|\/]*(\d+(?:[.,]\d+)?)/i,
     /(\d{2,4})\s*(?:kcal|åƒå¡)/i
    ];
    for (const pattern of caloriesPatterns) {
     const match = cleanText.match(pattern);
     if (match) {
      data.calories = parseFloat(match[1].replace(',', '.'));
      break;
     }
    }
   }
   const proteinPatterns = [
    /(?:è›‹ç™½è³ª|è›‹ç™½|protein)[:\s\/|]*(\d+(?:[.,]\d+)?)\s*(?:g|å…‹|å…¬å…‹)/i,
    /(?:è›‹ç™½è³ª|è›‹ç™½|protein)[:\s|\/]*(\d+(?:[.,]\d+)?)/i,
    /protein[:\s]*(\d+(?:[.,]\d+)?)\s*g/i
   ];
   for (const pattern of proteinPatterns) {
    const match = cleanText.match(pattern);
    if (match) {
     data.protein = parseFloat(match[1].replace(',', '.'));
     break;
    }
   }
   const fatPatterns = [
    /(?:ç¸½è„‚è‚ª|è„‚è‚ªç¸½é‡|è„‚è‚ª|total\s*fat|fat,?\s*total|fat)[:\s\/|]*(\d+(?:[.,]\d+)?)\s*(?:g|å…‹|å…¬å…‹)/i,
    /(?:ç¸½è„‚è‚ª|è„‚è‚ª|fat)[:\s|\/]*(\d+(?:[.,]\d+)?)/i,
    /fat[:\s]*(\d+(?:[.,]\d+)?)\s*g/i
   ];
   for (const pattern of fatPatterns) {
    const match = cleanText.match(pattern);
    if (match) {
     data.fat = parseFloat(match[1].replace(',', '.'));
     break;
    }
   }
   const carbsPatterns = [
    /(?:ç¸½ç¢³æ°´åŒ–åˆç‰©|ç¢³æ°´åŒ–åˆç‰©ç¸½é‡|ç¢³æ°´åŒ–åˆç‰©|total\s*carb|carbohydrate(?:s)?)[:\s\/|]*(\d+(?:[.,]\d+)?)\s*(?:g|å…‹|å…¬å…‹)/i,
    /(?:ç¢³æ°´åŒ–åˆç‰©|carb(?:s|ohydrate)?)[:\s|\/]*(\d+(?:[.,]\d+)?)/i,
    /carb(?:s|ohydrate)?[:\s]*(\d+(?:[.,]\d+)?)\s*g/i
   ];
   for (const pattern of carbsPatterns) {
    const match = cleanText.match(pattern);
    if (match) {
     data.carbs = parseFloat(match[1].replace(',', '.'));
     break;
    }
   }
   const sodiumPatterns = [
    /(?:éˆ‰|sodium|na)[:\s\/|]*(\d+(?:[.,]\d+)?)\s*(?:mg|æ¯«å…‹)/i,
    /(?:éˆ‰|sodium)[:\s|\/]*(\d+(?:[.,]\d+)?)/i,
    /sodium[:\s]*(\d+(?:[.,]\d+)?)\s*mg/i
   ];
   for (const pattern of sodiumPatterns) {
    const match = cleanText.match(pattern);
    if (match) {
     data.sodium = parseFloat(match[1].replace(',', '.'));
     break;
    }
   }
   const calciumPatterns = [
    /(?:éˆ£|calcium|ca)[:\s\/|]*(\d+(?:[.,]\d+)?)\s*(?:mg|æ¯«å…‹)/i,
    /(?:éˆ£|calcium)[:\s|\/]*(\d+(?:[.,]\d+)?)/i,
    /calcium[:\s]*(\d+(?:[.,]\d+)?)\s*mg/i
   ];
   for (const pattern of calciumPatterns) {
    const match = cleanText.match(pattern);
    if (match) {
     data.calcium = parseFloat(match[1].replace(',', '.'));
     break;
    }
   }
   if (data.calories === null || data.protein === null || data.fat === null || data.carbs === null) {
    const lines = cleanText.split(/[\n\r]+/);
    for (let i = 0; i < lines.length; i++) {
     const line = lines[i];
     const nextLine = lines[i + 1] || '';
     const combined = line + ' ' + nextLine;
     if (data.calories === null && /ç†±é‡|èƒ½é‡|energy|calories/i.test(line)) {
      const kjMatch = combined.match(/(\d+(?:[.,]\d+)?)\s*(?:kj|åƒç„¦|åƒç„¦è€³)/i);
      if (kjMatch) {
       const kj = parseFloat(kjMatch[1].replace(',', '.'));
       data.calories = Math.round(kj / 4.184);
      } else {
       const numMatch = combined.match(/(\d+(?:[.,]\d+)?)/);
       if (numMatch) data.calories = parseFloat(numMatch[1].replace(',', '.'));
      }
     }
     if (data.protein === null && /è›‹ç™½è³ª|è›‹ç™½|protein/i.test(line)) {
      const numMatch = combined.match(/(\d+(?:[.,]\d+)?)/);
      if (numMatch) data.protein = parseFloat(numMatch[1].replace(',', '.'));
     }
     if (data.fat === null && /è„‚è‚ª|fat/i.test(line) && !/é£½å’Œ|trans|saturated/i.test(line)) {
      const numMatch = combined.match(/(\d+(?:[.,]\d+)?)/);
      if (numMatch) data.fat = parseFloat(numMatch[1].replace(',', '.'));
     }
     if (data.carbs === null && /ç¢³æ°´|carb/i.test(line)) {
      const numMatch = combined.match(/(\d+(?:[.,]\d+)?)/);
      if (numMatch) data.carbs = parseFloat(numMatch[1].replace(',', '.'));
     }
     if (data.sodium === null && /éˆ‰|sodium/i.test(line)) {
      const numMatch = combined.match(/(\d+(?:[.,]\d+)?)/);
      if (numMatch) data.sodium = parseFloat(numMatch[1].replace(',', '.'));
     }
     if (data.calcium === null && /éˆ£|calcium/i.test(line)) {
      const numMatch = combined.match(/(\d+(?:[.,]\d+)?)/);
      if (numMatch) data.calcium = parseFloat(numMatch[1].replace(',', '.'));
     }
    }
   }
   if (data.calories !== null && data.calories > 900) {
    data.calories = Math.round(data.calories / 4.184);
   }
   const hasData = data.calories !== null || data.protein !== null ||
           data.fat !== null || data.carbs !== null;
   return hasData ? data : null;
  }
  function fillFormWithScannedData(data) {
   if (data.name) {
    document.getElementById('foodName').value = data.name;
   }
   if (data.nameEn) {
    document.getElementById('foodNameEn').value = data.nameEn;
   }
   if (data.mode === 'perServing' && data.servingWeight) {
    setInputMode('perServing');
    document.getElementById('servingWeight').value = data.servingWeight;
   } else {
    setInputMode('per100g');
   }
   if (data.calories !== null && data.calories !== undefined) {
    document.getElementById('caloriesServing').value = data.calories;
   }
   if (data.protein !== null && data.protein !== undefined) {
    document.getElementById('proteinServing').value = data.protein;
   }
   if (data.fat !== null && data.fat !== undefined) {
    document.getElementById('fatServing').value = data.fat;
   }
   if (data.carbs !== null && data.carbs !== undefined) {
    document.getElementById('carbsServing').value = data.carbs;
   }
   if (data.sodium !== null && data.sodium !== undefined) {
    document.getElementById('sodiumServing').value = data.sodium;
   }
   if (data.calcium !== null && data.calcium !== undefined) {
    document.getElementById('calciumServing').value = data.calcium;
   }
  }
  function editFood(id) {
   const food = foods.find(f => f.id === id);
   if (!food) return;
   document.getElementById('modalTitle').textContent = 'ç·¨è¼¯é£Ÿç‰©';
   document.getElementById('submitBtn').textContent = 'æ›´æ–°';
   document.getElementById('editId').value = id;
   document.getElementById('foodName').value = food.name;
   document.getElementById('foodNameEn').value = food.nameEn || '';
   document.getElementById('foodBrand').value = food.brand || '';
   document.getElementById('foodCategory').value = food.category;
   document.getElementById('foodSource').value = food.source || 'ç‡Ÿé¤Šæ¨™ç±¤';
   const displayVal = (val) => val !== null && val !== undefined ? val : '';
   const p = food.per100g || {};
   const ps = food.perServing;
   setInputMode('per100g');
   document.getElementById('caloriesServing').value = displayVal(p.calories);
   document.getElementById('proteinServing').value = displayVal(p.protein);
   document.getElementById('fatServing').value = displayVal(p.fat);
   document.getElementById('carbsServing').value = displayVal(p.carbs);
   document.getElementById('sodiumServing').value = displayVal(p.sodium);
   document.getElementById('calciumServing').value = displayVal(p.calcium);
   if (ps && ps.weight) {
    document.getElementById('servingWeight').value = ps.weight;
   } else {
    document.getElementById('servingWeight').value = '';
   }
   document.getElementById('addModal').classList.add('active');
  }
  function generateNextId() {
   const maxId = Math.max(...foods.map(f => parseInt(f.id) || 0), 0);
   return (maxId + 1).toString();
  }
  async function handleFormSubmit(e) {
   e.preventDefault();
   const editId = document.getElementById('editId').value;
   const servingWeight = parseFloat(document.getElementById('servingWeight').value) || null;
   let selectedCategory = document.getElementById('foodCategory').value;
   if (selectedCategory === '__new__') {
    const newCatName = document.getElementById('newCategoryName').value.trim();
    const newCatEmoji = document.getElementById('newCategoryEmoji').value.trim();
    if (!newCatName) {
     showToast('è«‹è¼¸å…¥æ–°åˆ†é¡åç¨±');
     document.getElementById('newCategoryName').focus();
     return;
    }
    if (categories.includes(newCatName)) {
     showToast('æ­¤åˆ†é¡å·²å­˜åœ¨');
     return;
    }
    categories.push(newCatName);
    if (newCatEmoji) {
     categoryEmojis[newCatName] = newCatEmoji;
    }
    selectedCategory = newCatName;
    renderCategories();
    renderCategoryPills();
   }
   if (formInputMode === 'perServing' && !servingWeight) {
    showToast('è«‹è¼¸å…¥æ¯ä»½é‡é‡');
    document.getElementById('servingWeight').focus();
    return;
   }
   const selectedSource = document.getElementById('foodSource').value;
   const selectedBrand = document.getElementById('foodBrand').value.trim() || null;
   const parseNutritionValue = (id) => {
    const value = document.getElementById(id).value.trim();
    if (value === '') return null;
    const num = parseFloat(value);
    return isNaN(num) ? null : num;
   };
   const nutritionData = {
    calories: parseNutritionValue('caloriesServing'),
    protein: parseNutritionValue('proteinServing'),
    fat: parseNutritionValue('fatServing'),
    carbs: parseNutritionValue('carbsServing'),
    sodium: parseNutritionValue('sodiumServing'),
    calcium: parseNutritionValue('calciumServing')
   };
   let foodData;
   if (formInputMode === 'per100g') {
    let perServingData = null;
    if (servingWeight) {
     const toPerServing = (val, decimals = 1) => {
      if (val === null) return null;
      const result = val * servingWeight / 100;
      return Math.round(result * Math.pow(10, decimals)) / Math.pow(10, decimals);
     };
     perServingData = {
      weight: servingWeight,
      calories: toPerServing(nutritionData.calories, 0),
      protein: toPerServing(nutritionData.protein),
      fat: toPerServing(nutritionData.fat),
      carbs: toPerServing(nutritionData.carbs),
      sodium: toPerServing(nutritionData.sodium, 0),
      calcium: toPerServing(nutritionData.calcium, 0)
     };
    }
    const newId = editId || generateNextId();
    foodData = {
     id: newId,
     name: document.getElementById('foodName').value.trim(),
     nameEn: document.getElementById('foodNameEn').value.trim() || null,
     brand: selectedBrand,
     category: selectedCategory,
     source: selectedSource,
     per100g: nutritionData,
     perServing: perServingData
    };
   } else {
    const toPer100g = (val, decimals = 0) => {
     if (val === null) return null;
     const result = val / servingWeight * 100;
     return decimals > 0 ? Math.round(result * Math.pow(10, decimals)) / Math.pow(10, decimals) : Math.round(result);
    };
    const newId = editId || generateNextId();
    foodData = {
     id: newId,
     name: document.getElementById('foodName').value.trim(),
     nameEn: document.getElementById('foodNameEn').value.trim() || null,
     brand: selectedBrand,
     category: selectedCategory,
     source: selectedSource,
     per100g: {
      calories: toPer100g(nutritionData.calories),
      protein: toPer100g(nutritionData.protein, 1),
      fat: toPer100g(nutritionData.fat, 1),
      carbs: toPer100g(nutritionData.carbs, 1),
      sodium: toPer100g(nutritionData.sodium),
      calcium: toPer100g(nutritionData.calcium)
     },
     perServing: {
      weight: servingWeight,
      ...nutritionData
     }
    };
   }
   if (editId) {
    const index = foods.findIndex(f => f.id === editId);
    if (index > -1) foods[index] = foodData;
    showToast('å·²æ›´æ–°è³‡æ–™');
   } else {
    foods.push(foodData);
    showToast('å·²æ–°å¢é£Ÿç‰©');
   }
   closeModal();
   renderFoodList();
   renderCategories();
   updateStats();
   saveToIndexedDB(); // Auto-save to IndexedDB
   doAutoSync();
  }
  async function doAutoSync() {
   let url = memorySettings.appsScriptUrl;
   if (!url && db) {
    try {
     const tx = db.transaction(['settings'], 'readonly');
     const store = tx.objectStore('settings');
     const result = await new Promise(resolve => {
      const req = store.get('appsScriptUrl');
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => resolve(null);
     });
     url = result ? result.value : '';
     if (url) memorySettings.appsScriptUrl = url;
    } catch (e) { }
   }
   if (!url) return;
   showToast('æ­£åœ¨åŒæ­¥...');
   try {
    await fetch(url, {
     method: 'POST',
     mode: 'no-cors',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
      foods: foods,
      categories: categories,
      categoryEmojis: categoryEmojis,
      lastUpdated: new Date().toISOString()
     })
    });
    showToast('å·²åŒæ­¥ âœ“');
   } catch (e) {
    showToast('åŒæ­¥å¤±æ•—');
   }
  }
  function confirmDeleteFood(id) {
   const food = foods.find(f => f.id === id);
   showConfirmModal(
    'ç¢ºèªåˆªé™¤ï¼Ÿ',
    `ç¢ºå®šè¦åˆªé™¤ã€Œ${food.name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`,
    () => deleteFood(id)
   );
  }
  function deleteFood(id) {
   foods = foods.filter(f => f.id !== id);
   closeConfirmModal();
   renderFoodList();
   renderCategories();
   updateStats();
   saveToIndexedDB(); // Auto-save to IndexedDB
   doAutoSync(); // Auto-sync to cloud
   showToast('å·²åˆªé™¤');
  }
  function updateStats() {
   document.getElementById('totalItems').textContent = foods.length;
   document.getElementById('totalCategories').textContent = categories.length;
  }
  function showConfirmModal(title, message, onConfirm) {
   document.getElementById('confirmTitle').textContent = title;
   document.getElementById('confirmMessage').textContent = message;
   document.getElementById('confirmAction').onclick = onConfirm;
   document.getElementById('confirmModal').classList.add('active');
  }
  function closeConfirmModal() {
   document.getElementById('confirmModal').classList.remove('active');
  }
  function showToast(message, duration) {
   const toast = document.getElementById('toast');
   toast.textContent = message;
   toast.classList.add('show');
   setTimeout(() => toast.classList.remove('show'), duration || 2000);
  }
  function exportData() {
   const data = { foods, categories, exportDate: new Date().toISOString() };
   const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = `nutrition-data-${new Date().toISOString().split('T')[0]}.json`;
   document.body.appendChild(a);
   a.click();
   document.body.removeChild(a);
   URL.revokeObjectURL(url);
   showToast('å·²åŒ¯å‡ºè³‡æ–™');
  }
  function importData(event) {
   const file = event.target.files[0];
   if (!file) return;
   const reader = new FileReader();
   reader.onload = (e) => {
    try {
     const data = JSON.parse(e.target.result);
     if (data.foods && Array.isArray(data.foods)) {
      foods = data.foods;
     }
     if (data.categories && Array.isArray(data.categories)) {
      categories = data.categories;
     }
     if (data.categoryEmojis) {
      Object.keys(categoryEmojis).forEach(k => delete categoryEmojis[k]);
      Object.assign(categoryEmojis, data.categoryEmojis);
     }
     renderCategories();
     renderCategoryPills();
     renderFoodList();
     updateStats();
     saveToIndexedDB(); // Auto-save to IndexedDB
     showToast('å·²åŒ¯å…¥è³‡æ–™');
    } catch (err) {
     showToast('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤');
    }
   };
   reader.readAsText(file);
   event.target.value = '';
  }
  function confirmClearData() {
   document.getElementById('dropdownMenu').classList.remove('show');
   showConfirmModal(
    'æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ',
    'æ­¤æ“ä½œæœƒåˆªé™¤æ‰€æœ‰é£Ÿç‰©è³‡æ–™ï¼Œç„¡æ³•å¾©åŸã€‚å»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚',
    () => {
     foods = [];
     categories = ['é»å¿ƒ', 'å…¶ä»–'];
     currentFilter = 'å…¨éƒ¨';
     renderCategories();
     renderCategoryPills();
     renderFoodList();
     updateStats();
     saveToIndexedDB(); // Auto-save to IndexedDB
     closeConfirmModal();
     showToast('å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™');
    }
   );
  }
  let aiImportImageFile = null;
  let aiImportResults = [];
  function showAIImport() {
   document.getElementById('dropdownMenu').classList.remove('show');
   const select = document.getElementById('aiImportCategory');
   select.innerHTML = '<option value="">-- é¸æ“‡ç¾æœ‰åˆ†é¡ --</option>' +
    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
   document.getElementById('aiNewCategory').value = '';
   document.getElementById('aiNewCategoryEmoji').value = '';
   setAIInputMode('per100g');
   clearAIImportPreview();
   clearFileImport();
   document.getElementById('aiImportStatus').style.display = 'none';
   document.getElementById('aiImportResults').style.display = 'none';
   document.getElementById('aiAnalyzeBtn').disabled = true;
   document.getElementById('aiConfirmBtn').style.display = 'none';
   textImportMode = false;
   const textArea = document.getElementById('textImportArea');
   if (textArea) textArea.style.display = 'none';
   const textInput = document.getElementById('textImportInput');
   if (textInput) textInput.value = '';
   aiImportResults = [];
   document.getElementById('aiImportModal').classList.add('active');
  }
  function closeAIImportModal() {
   document.getElementById('aiImportModal').classList.remove('active');
   aiImportImageFile = null;
   aiImportResults = [];
   excelImportData = null;
   textImportMode = false;
  }
  let excelImportData = null;
  let xlsxLoadPromise = null;
  async function loadXLSX() {
   if (typeof XLSX !== 'undefined') return true;
   if (xlsxLoadPromise) return xlsxLoadPromise;
   xlsxLoadPromise = new Promise((resolve) => {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
    script.onload = () => resolve(true);
    script.onerror = () => resolve(false);
    document.head.appendChild(script);
   });
   return xlsxLoadPromise;
  }
  async function handleExcelImport(event) {
   const file = event.target.files[0];
   if (!file) return;
   clearAIImportPreview();
   clearPdfImport();
   const fileIcon = document.getElementById('aiImportFileIcon');
   fileIcon.className = 'fas fa-file-excel';
   fileIcon.style.color = '#22c55e';
   document.getElementById('aiImportFileName').textContent = file.name;
   document.getElementById('aiImportFileSize').textContent = formatFileSize(file.size);
   document.getElementById('aiImportFileInfo').style.display = 'block';
   updateAIStatus('æ­£åœ¨è¼‰å…¥ Excel è§£æå™¨...');
   const loaded = await loadXLSX();
   if (!loaded || typeof XLSX === 'undefined') {
    updateAIStatus('ç„¡æ³•è¼‰å…¥ Excel è§£æå™¨ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥', 'error');
    return;
   }
   updateAIStatus('æ­£åœ¨è§£ææª”æ¡ˆ...');
   try {
    const data = await readExcelFile(file);
    excelImportData = data;
    if (data && data.length > 0) {
     const parsedFoods = parseExcelToFoods(data);
     if (parsedFoods.length > 0) {
      aiImportResults = parsedFoods;
      displayAIResults(parsedFoods);
      updateAIStatus(`æˆåŠŸè§£æ ${parsedFoods.length} æ¬¾é£Ÿç‰©`, 'success');
      document.getElementById('aiConfirmBtn').style.display = 'block';
      document.getElementById('aiAnalyzeBtn').disabled = true;
     } else {
      updateAIStatus('ç„¡æ³•è­˜åˆ¥è¡¨æ ¼æ ¼å¼ã€‚è«‹ç¢ºä¿è¡¨æ ¼åŒ…å«ã€Œé£Ÿç‰©åç¨±ã€å’Œã€Œå¡è·¯é‡Œ/ç†±é‡ã€æ¬„ä½ã€‚', 'error');
     }
    } else {
     updateAIStatus('æª”æ¡ˆä¸­æ²’æœ‰æ•¸æ“š', 'error');
    }
   } catch (err) {
    console.error('Excel parse error:', err);
    updateAIStatus('è§£ææª”æ¡ˆå¤±æ•—: ' + err.message, 'error');
   }
  }
  function formatFileSize(bytes) {
   if (bytes < 1024) return bytes + ' B';
   if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
   return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }
  function readExcelFile(file) {
   return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
     try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      resolve(jsonData);
     } catch (err) {
      reject(err);
     }
    };
    reader.onerror = () => reject(new Error('ç„¡æ³•è®€å–æª”æ¡ˆ'));
    reader.readAsArrayBuffer(file);
   });
  }
  function parseExcelToFoods(data) {
   if (!data || data.length < 2) return [];
   const foods = [];
   let headerRowIndex = 0;
   for (let i = 0; i < data.length; i++) {
    if (data[i] && data[i].some(cell => cell !== null && cell !== undefined && String(cell).trim())) {
     headerRowIndex = i;
     break;
    }
   }
   const headers = data[headerRowIndex].map(h => String(h || '').toLowerCase().trim());
   const colMap = {
    name: findColumnIndex(headers, ['é£Ÿç‰©', 'åç¨±', 'åå­—', 'å“å', 'name', 'food', 'item', 'å“é …', 'èœå', 'ç”¢å“']),
    nameEn: findColumnIndex(headers, ['è‹±æ–‡', 'english', 'eng', 'name_en']),
    calories: findColumnIndex(headers, ['å¡è·¯é‡Œ', 'ç†±é‡', 'èƒ½é‡', 'calories', 'kcal', 'cal', 'energy', 'åƒå¡', 'å¤§å¡']),
    protein: findColumnIndex(headers, ['è›‹ç™½', 'protein', 'è›‹ç™½è³ª']),
    fat: findColumnIndex(headers, ['è„‚è‚ª', 'fat', 'ç¸½è„‚è‚ª']),
    carbs: findColumnIndex(headers, ['ç¢³æ°´', 'carb', 'é†£', 'ç³–', 'ç¢³æ°´åŒ–åˆç‰©', 'carbohydrate']),
    sodium: findColumnIndex(headers, ['éˆ‰', 'sodium', 'na']),
    calcium: findColumnIndex(headers, ['éˆ£', 'calcium', 'ca']),
    servingWeight: findColumnIndex(headers, ['æ¯ä»½é‡é‡', 'ä»½é‡', 'serving', 'weight', 'é‡é‡', 'å…‹'])
   };
   if (colMap.name === -1) {
    colMap.name = 0;
   }
   if (colMap.calories === -1) {
    for (let i = 1; i < headers.length; i++) {
     if (i !== colMap.name) {
      const hasNumbers = data.slice(headerRowIndex + 1).some(row =>
       row[i] !== undefined && !isNaN(parseFloat(row[i]))
      );
      if (hasNumbers) {
       colMap.calories = i;
       break;
      }
     }
    }
   }
   for (let i = headerRowIndex + 1; i < data.length; i++) {
    const row = data[i];
    if (!row || !row[colMap.name]) continue;
    const name = String(row[colMap.name]).trim();
    if (!name || name.length < 1) continue;
    const parseNum = (val) => {
     if (val === null || val === undefined || val === '' || val === '-') return null;
     const num = parseFloat(String(val).replace(/[,ï¼Œ]/g, ''));
     return isNaN(num) ? null : num;
    };
    let calories = parseNum(row[colMap.calories]);
    if (calories !== null && calories > 900) {
     calories = Math.round(calories / 4.184);
    }
    const servingWeight = parseNum(row[colMap.servingWeight]);
    const nutritionData = {
     calories: calories,
     protein: parseNum(row[colMap.protein]),
     fat: parseNum(row[colMap.fat]),
     carbs: parseNum(row[colMap.carbs]),
     sodium: parseNum(row[colMap.sodium]),
     calcium: parseNum(row[colMap.calcium])
    };
    let food = {
     name: name,
     nameEn: colMap.nameEn !== -1 ? (row[colMap.nameEn] ? String(row[colMap.nameEn]).trim() : null) : null,
     per100g: null,
     perServing: null
    };

    if (aiImportInputMode === 'per100g') {
     food.per100g = nutritionData;
     if (servingWeight && servingWeight > 0) {
      const toPerServing = (val) => val !== null ? Math.round(val * servingWeight / 100 * 10) / 10 : null;
      food.perServing = {
       weight: servingWeight,
       calories: toPerServing(nutritionData.calories),
       protein: toPerServing(nutritionData.protein),
       fat: toPerServing(nutritionData.fat),
       carbs: toPerServing(nutritionData.carbs),
       sodium: toPerServing(nutritionData.sodium),
       calcium: toPerServing(nutritionData.calcium)
      };
     }
    } else {
     if (!servingWeight || servingWeight <= 0) {
      food.perServing = {
       weight: null,
       ...nutritionData
      };
      food.per100g = {
       calories: null,
       protein: null,
       fat: null,
       carbs: null,
       sodium: null,
       calcium: null
      };
     } else {
      food.perServing = {
       weight: servingWeight,
       ...nutritionData
      };
      const toPer100g = (val) => val !== null ? Math.round(val / servingWeight * 100 * 10) / 10 : null;
      food.per100g = {
       calories: toPer100g(nutritionData.calories),
       protein: toPer100g(nutritionData.protein),
       fat: toPer100g(nutritionData.fat),
       carbs: toPer100g(nutritionData.carbs),
       sodium: toPer100g(nutritionData.sodium),
       calcium: toPer100g(nutritionData.calcium)
      };
     }
    }
    foods.push(food);
   }
   return foods;
  }
  function findColumnIndex(headers, keywords) {
   for (let i = 0; i < headers.length; i++) {
    const header = headers[i];
    for (const keyword of keywords) {
     if (header.includes(keyword.toLowerCase())) {
      return i;
     }
    }
   }
   return -1;
  }
  let textImportMode = false;
  function toggleTextImport() {
   textImportMode = !textImportMode;
   const area = document.getElementById('textImportArea');
   area.style.display = textImportMode ? 'block' : 'none';
   if (textImportMode) {
    clearAIImportPreview();
    clearFileImport();
    document.getElementById('aiAnalyzeBtn').disabled = false;
    document.getElementById('aiImportStatus').style.display = 'none';
    document.getElementById('aiImportResults').style.display = 'none';
    document.getElementById('aiConfirmBtn').style.display = 'none';
   } else {
    document.getElementById('aiAnalyzeBtn').disabled = true;
   }
  }
  function startAnalysis() {
   if (textImportMode) {
    analyzeTextInput();
   } else {
    analyzeWithAI();
   }
  }
  function analyzeTextInput() {
   const text = document.getElementById('textImportInput').value.trim();
   if (!text) {
    updateAIStatus('è«‹å…ˆè²¼ä¸Šæ–‡å­—', 'error');
    return;
   }
   updateAIStatus('æ­£åœ¨è§£ææ–‡å­—...');
   const parsedFoods = parseTextToFoods(text);
   if (parsedFoods.length > 0) {
    aiImportResults = parsedFoods;
    displayAIResults(parsedFoods);
    updateAIStatus(`æˆåŠŸè§£æ ${parsedFoods.length} æ¬¾é£Ÿç‰©`, 'success');
    document.getElementById('aiConfirmBtn').style.display = 'block';
   } else {
    updateAIStatus('ç„¡æ³•è­˜åˆ¥æ–‡å­—å…§å®¹ã€‚è«‹ç¢ºä¿æ¯è¡ŒåŒ…å«ã€Œé£Ÿç‰©åç¨±ã€å’Œã€Œæ•¸å­—ã€ã€‚', 'error');
   }
  }
  function parseTextToFoods(text) {
   const foods = [];
   const lines = text.split('\n').filter(l => l.trim());
   const detectSeparator = (line) => {
    if (line.includes('\t')) return /\t+/;
    if (line.includes('|') || line.includes('ï½œ')) return /[|ï½œ]+/;
    return /\s{2,}/;
   };
   let headerIndex = -1;
   let colMap = {};
   for (let i = 0; i < Math.min(3, lines.length); i++) {
    const line = lines[i].trim().toLowerCase();
    if (line.match(/é£Ÿç‰©|åç¨±|name|å“å|å¡è·¯é‡Œ|ç†±é‡|calories|è›‹ç™½|protein|è„‚è‚ª|fat/)) {
     headerIndex = i;
     const sep = detectSeparator(lines[i]);
     const cols = lines[i].split(sep).map(c => c.trim().toLowerCase());
     colMap = {
      name: findColIdx(cols, ['é£Ÿç‰©', 'åç¨±', 'å“å', 'name', 'food', 'èœå', 'ç”¢å“', 'é …ç›®']),
      calories: findColIdx(cols, ['å¡è·¯é‡Œ', 'ç†±é‡', 'èƒ½é‡', 'calories', 'kcal', 'cal', 'åƒå¡']),
      protein: findColIdx(cols, ['è›‹ç™½', 'protein']),
      fat: findColIdx(cols, ['è„‚è‚ª', 'fat']),
      carbs: findColIdx(cols, ['ç¢³æ°´', 'carb', 'é†£', 'ç³–']),
      sodium: findColIdx(cols, ['éˆ‰', 'sodium']),
      calcium: findColIdx(cols, ['éˆ£', 'calcium'])
     };
     break;
    }
   }
   const startRow = headerIndex + 1;
   for (let i = startRow; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    const sep = detectSeparator(line);
    const parts = line.split(sep).map(p => p.trim()).filter(p => p);
    if (headerIndex >= 0 && Object.values(colMap).some(v => v >= 0)) {
     const nameIdx = colMap.name >= 0 ? colMap.name : 0;
     const name = parts[nameIdx];
     if (!name || name.length < 1) continue;
     const getNum = (idx) => {
      if (idx < 0 || idx >= parts.length) return null;
      const val = parseFloat(parts[idx].replace(/[,ï¼Œ]/g, ''));
      return isNaN(val) ? null : val;
     };
     let cal = getNum(colMap.calories);
     if (cal !== null && cal > 900) cal = Math.round(cal / 4.184);
     const nutritionData = {
      calories: cal,
      protein: getNum(colMap.protein),
      fat: getNum(colMap.fat),
      carbs: getNum(colMap.carbs),
      sodium: getNum(colMap.sodium),
      calcium: getNum(colMap.calcium)
     };
     let food = { name: name, nameEn: null, per100g: null, perServing: null };
     if (aiImportInputMode === 'per100g') {
      food.per100g = nutritionData;
     } else {
      food.perServing = { weight: null, ...nutritionData };
      food.per100g = {
       calories: null,
       protein: null,
       fat: null,
       carbs: null,
       sodium: null,
       calcium: null
      };
     }
     foods.push(food);
    } else {
     const nameMatch = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)/);
     if (nameMatch) {
      let foodName = nameMatch[1].trim().replace(/[|ï½œ:ï¼š,ï¼Œ\s]+$/, '');
      if (foodName.length < 1) continue;
      if (foodName.match(/^(é£Ÿç‰©|åç¨±|å“å|calories|kcal|ç†±é‡|å¡è·¯é‡Œ)/i)) continue;
      const nums = line.match(/\d+(?:\.\d+)?/g);
      if (!nums || nums.length < 1) continue;
      let cal = parseFloat(nums[0]);
      if (cal > 900) cal = Math.round(cal / 4.184);
      const nutritionData = {
       calories: cal,
       protein: nums[1] ? parseFloat(nums[1]) : null,
       fat: nums[2] ? parseFloat(nums[2]) : null,
       carbs: nums[3] ? parseFloat(nums[3]) : null,
       sodium: nums[4] ? parseFloat(nums[4]) : null,
       calcium: nums[5] ? parseFloat(nums[5]) : null
      };
      let food = { name: foodName, nameEn: null, per100g: null, perServing: null };
      if (aiImportInputMode === 'per100g') {
       food.per100g = nutritionData;
      } else {
       food.perServing = { weight: null, ...nutritionData };
       food.per100g = {
        calories: null,
        protein: null,
        fat: null,
        carbs: null,
        sodium: null,
        calcium: null
       };
      }
      foods.push(food);
     }
    }
   }
   return foods;
  }
  function findColIdx(cols, keywords) {
   for (let i = 0; i < cols.length; i++) {
    for (const kw of keywords) {
     if (cols[i].includes(kw)) return i;
    }
   }
   return -1;
  }
  function preprocessImageForOCR(imageElement) {
   return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const scale = 2;
    canvas.width = imageElement.naturalWidth * scale;
    canvas.height = imageElement.naturalHeight * scale;
    ctx.imageSmoothingEnabled = true;
    ctx.drawImage(imageElement, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    for (let i = 0; i < data.length; i += 4) {
     const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
     data[i] = gray;
     data[i + 1] = gray;
     data[i + 2] = gray;
    }
    let minVal = 255, maxVal = 0;
    for (let i = 0; i < data.length; i += 4) {
     if (data[i] < minVal) minVal = data[i];
     if (data[i] > maxVal) maxVal = data[i];
    }
    const range = maxVal - minVal || 1;
    for (let i = 0; i < data.length; i += 4) {
     const val = Math.round((data[i] - minVal) / range * 255);
     data[i] = val;
     data[i + 1] = val;
     data[i + 2] = val;
    }
    const tempData = new Uint8ClampedArray(data);
    const w = canvas.width;
    const h = canvas.height;
    const sharpenAmount = 0.5;
    for (let y = 1; y < h - 1; y++) {
     for (let x = 1; x < w - 1; x++) {
      const idx = (y * w + x) * 4;
      const neighbors =
       tempData[((y - 1) * w + x) * 4] +
       tempData[((y + 1) * w + x) * 4] +
       tempData[(y * w + x - 1) * 4] +
       tempData[(y * w + x + 1) * 4];
      const laplacian = tempData[idx] * 4 - neighbors;
      const val = Math.min(255, Math.max(0, tempData[idx] + laplacian * sharpenAmount));
      data[idx] = val;
      data[idx + 1] = val;
      data[idx + 2] = val;
     }
    }
    const histogram = new Array(256).fill(0);
    for (let i = 0; i < data.length; i += 4) {
     histogram[data[i]]++;
    }
    const totalPixels = data.length / 4;
    let sum = 0;
    for (let i = 0; i < 256; i++) sum += i * histogram[i];
    let sumB = 0, wB = 0, wF = 0;
    let maxVariance = 0, threshold = 128;
    for (let t = 0; t < 256; t++) {
     wB += histogram[t];
     if (wB === 0) continue;
     wF = totalPixels - wB;
     if (wF === 0) break;
     sumB += t * histogram[t];
     const mB = sumB / wB;
     const mF = (sum - sumB) / wF;
     const variance = wB * wF * (mB - mF) * (mB - mF);
     if (variance > maxVariance) {
      maxVariance = variance;
      threshold = t;
     }
    }
    for (let i = 0; i < data.length; i += 4) {
     const val = data[i] > threshold ? 255 : 0;
     data[i] = val;
     data[i + 1] = val;
     data[i + 2] = val;
    }
    let blackCount = 0;
    for (let i = 0; i < data.length; i += 4) {
     if (data[i] === 0) blackCount++;
    }
    if (blackCount > totalPixels / 2) {
     for (let i = 0; i < data.length; i += 4) {
      data[i] = 255 - data[i];
      data[i + 1] = 255 - data[i + 1];
      data[i + 2] = 255 - data[i + 2];
     }
    }
    ctx.putImageData(imageData, 0, 0);
    canvas.toBlob(resolve, 'image/png');
   });
  }
  function clearExcelImport() {
   document.getElementById('aiImportFileInfo').style.display = 'none';
   document.getElementById('aiImportExcelInput').value = '';
   excelImportData = null;
  }
  function clearPdfImport() {
   document.getElementById('aiImportFileInfo').style.display = 'none';
   document.getElementById('aiImportPdfInput').value = '';
  }
  function clearFileImport() {
   clearExcelImport();
   clearPdfImport();
  }
  let pdfJsLoadPromise = null;
  async function loadPdfJs() {
   if (typeof pdfjsLib !== 'undefined') return true;
   if (pdfJsLoadPromise) return pdfJsLoadPromise;
   pdfJsLoadPromise = new Promise((resolve) => {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
    script.onload = () => {
     pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
     resolve(true);
    };
    script.onerror = () => resolve(false);
    document.head.appendChild(script);
   });
   return pdfJsLoadPromise;
  }
  async function handlePdfImport(event) {
   const file = event.target.files[0];
   if (!file) return;
   clearAIImportPreview();
   clearExcelImport();
   const fileIcon = document.getElementById('aiImportFileIcon');
   fileIcon.className = 'fas fa-file-pdf';
   fileIcon.style.color = '#ef4444';
   document.getElementById('aiImportFileName').textContent = file.name;
   document.getElementById('aiImportFileSize').textContent = formatFileSize(file.size);
   document.getElementById('aiImportFileInfo').style.display = 'block';
   updateAIStatus('æ­£åœ¨è¼‰å…¥ PDF è§£æå™¨...');
   const loaded = await loadPdfJs();
   if (!loaded || typeof pdfjsLib === 'undefined') {
    updateAIStatus('ç„¡æ³•è¼‰å…¥ PDF è§£æå™¨ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥', 'error');
    return;
   }
   updateAIStatus('æ­£åœ¨è§£æ PDF...');
   try {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let fullText = '';
    const totalPages = pdf.numPages;
    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
     updateAIStatus(`æ­£åœ¨è®€å–ç¬¬ ${pageNum}/${totalPages} é ...`);
     const page = await pdf.getPage(pageNum);
     const textContent = await page.getTextContent();
     const pageText = textContent.items.map(item => item.str).join(' ');
     fullText += pageText + '\n';
    }
        const parsedFoods = parsePdfText(fullText);
    if (parsedFoods.length > 0) {
     aiImportResults = parsedFoods;
     displayAIResults(parsedFoods);
     updateAIStatus(`æˆåŠŸå¾ PDF è§£æ ${parsedFoods.length} æ¬¾é£Ÿç‰©`, 'success');
     document.getElementById('aiConfirmBtn').style.display = 'block';
     document.getElementById('aiAnalyzeBtn').disabled = true;
    } else {
     updateAIStatus('ç„¡æ³•å¾ PDF è­˜åˆ¥åˆ°ç‡Ÿé¤Šæ•¸æ“šã€‚è«‹ç¢ºä¿ PDF åŒ…å«æ¸…æ™°çš„è¡¨æ ¼æ ¼å¼ã€‚', 'error');
    }
   } catch (err) {
    console.error('PDF parse error:', err);
    updateAIStatus('è§£æ PDF å¤±æ•—: ' + err.message, 'error');
   }
  }
  function parsePdfText(text) {
   const foods = [];
   const lines = text.split('\n').filter(line => line.trim());
   for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed) continue;
    const match = trimmed.match(/^(.+?)\s+(\d+(?:\.\d+)?)\s*(?:kcal|åƒå¡|å¤§å¡|å¡)?(?:\s+(\d+(?:\.\d+)?))?(?:\s+(\d+(?:\.\d+)?))?(?:\s+(\d+(?:\.\d+)?))?(?:\s+(\d+(?:\.\d+)?))?/i);
    if (match) {
     let foodName = match[1].trim();
     foodName = foodName.replace(/[|ï½œ:ï¼š,ï¼Œ\s]+$/, '').trim();
     if (foodName.match(/^(é£Ÿç‰©|åç¨±|å“å|é …ç›®|calories|kcal|è›‹ç™½|è„‚è‚ª|ç¢³æ°´|ç†±é‡)/i)) continue;
     if (foodName.length < 2) continue;
     let calories = parseFloat(match[2]);
     if (calories > 900) {
      calories = Math.round(calories / 4.184);
     }
     const food = {
      name: foodName,
      nameEn: null,
      per100g: {
       calories: calories,
       protein: match[3] ? parseFloat(match[3]) : null,
       fat: match[4] ? parseFloat(match[4]) : null,
       carbs: match[5] ? parseFloat(match[5]) : null,
       sodium: match[6] ? parseFloat(match[6]) : null,
       calcium: null
      },
      perServing: null
     };
     foods.push(food);
    }
   }
   if (foods.length === 0) {
    for (const line of lines) {
     const trimmed = line.trim();
     const simpleMatch = trimmed.match(/^(.+?)\s+(\d+)\s*$/);
     if (simpleMatch) {
      let foodName = simpleMatch[1].trim();
      foodName = foodName.replace(/[|ï½œ:ï¼š,ï¼Œ\s]+$/, '').trim();
      if (foodName.match(/^(é£Ÿç‰©|åç¨±|å“å|é …ç›®|calories|kcal|ç†±é‡|å¡è·¯é‡Œ)/i)) continue;
      if (foodName.length < 2) continue;
      let calories = parseInt(simpleMatch[2]);
      if (calories > 900) {
       calories = Math.round(calories / 4.184);
      }
      foods.push({
       name: foodName,
       nameEn: null,
       per100g: {
        calories: calories,
        protein: null,
        fat: null,
        carbs: null,
        sodium: null,
        calcium: null
       },
       perServing: null
      });
     }
    }
   }
   return foods;
  }
  function handleAIImportImage(event) {
   const file = event.target.files[0];
   if (!file) return;
   clearFileImport();
   aiImportImageFile = file;
   const reader = new FileReader();
   reader.onload = (e) => {
    document.getElementById('aiImportPreviewImg').src = e.target.result;
    document.getElementById('aiImportPreview').style.display = 'block';
    document.getElementById('aiAnalyzeBtn').disabled = false;
    document.getElementById('aiImportStatus').style.display = 'none';
    document.getElementById('aiImportResults').style.display = 'none';
    document.getElementById('aiConfirmBtn').style.display = 'none';
   };
   reader.readAsDataURL(file);
  }
  function clearAIImportPreview() {
   document.getElementById('aiImportPreview').style.display = 'none';
   document.getElementById('aiImportPreviewImg').src = '';
   document.getElementById('aiImportImageInput').value = '';
   document.getElementById('aiAnalyzeBtn').disabled = true;
   aiImportImageFile = null;
  }
  function updateAIStatus(message, type = 'info') {
   const status = document.getElementById('aiImportStatus');
   status.style.display = 'block';
   status.style.background = type === 'error' ? 'rgba(239, 68, 68, 0.1)' :
                type === 'success' ? 'rgba(34, 197, 94, 0.1)' :
                'rgba(99, 102, 241, 0.1)';
   status.style.color = type === 'error' ? '#ef4444' :
             type === 'success' ? '#22c55e' :
             'var(--accent)';
   status.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'spinner fa-spin'}"></i> ${message}`;
  }
  if (window.Poe && window.Poe.registerHandler) {
   window.Poe.registerHandler('ai-import-handler', (result) => {
   const msg = result.responses[0];
   if (msg.status === 'error') {
    updateAIStatus('AIè­˜åˆ¥å¤±æ•—: ' + (msg.statusText || 'æœªçŸ¥éŒ¯èª¤'), 'error');
    document.getElementById('aiAnalyzeBtn').disabled = false;
    return;
   }
   if (msg.status === 'complete') {
    try {
     let jsonStr = msg.content;
     const jsonMatch = jsonStr.match(/\[[\s\S]*\]/);
     if (jsonMatch) {
      jsonStr = jsonMatch[0];
     }
     const parsedData = JSON.parse(jsonStr);
     if (Array.isArray(parsedData) && parsedData.length > 0) {
      aiImportResults = parsedData;
      displayAIResults(parsedData);
      updateAIStatus(`æˆåŠŸè­˜åˆ¥ ${parsedData.length} æ¬¾é£Ÿç‰©`, 'success');
      document.getElementById('aiConfirmBtn').style.display = 'block';
     } else {
      updateAIStatus('æœªèƒ½è­˜åˆ¥åˆ°æœ‰æ•ˆçš„ç‡Ÿé¤Šæ•¸æ“š', 'error');
     }
    } catch (e) {
     console.log('Parse error:', e, 'Content:', msg.content);
     updateAIStatus('è§£æAIå›æ‡‰æ™‚å‡ºéŒ¯ï¼Œè«‹é‡è©¦', 'error');
    }
    document.getElementById('aiAnalyzeBtn').disabled = false;
   }
  });
  }
  function displayAIResults(data) {
   const container = document.getElementById('aiImportResultsList');
   const formatVal = (val, unit = '') => val !== null && val !== undefined ? val + unit : '-';
   container.innerHTML = data.map((item, idx) => {
    const p = item.per100g || {};
    const s = item.perServing;
    const fv = (val, unit = '') => val !== null && val !== undefined ? val + unit : '--';
    const per100gStr = `${fv(p.calories, 'kcal')} | è›‹ç™½è³ª${fv(p.protein, 'g')} | è„‚è‚ª${fv(p.fat, 'g')} | ç¢³æ°´${fv(p.carbs, 'g')} | éˆ‰${fv(p.sodium, 'mg')} | éˆ£${fv(p.calcium, 'mg')}`;
    let perServingStr = '';
    if (s) {
     perServingStr = `${fv(s.calories, 'kcal')} | è›‹ç™½è³ª${fv(s.protein, 'g')} | è„‚è‚ª${fv(s.fat, 'g')} | ç¢³æ°´${fv(s.carbs, 'g')} | éˆ‰${fv(s.sodium, 'mg')} | éˆ£${fv(s.calcium, 'mg')}`;
    }
    return `
    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 10px; margin-bottom: 8px;">
     <div style="font-weight: 600; margin-bottom: 4px;">${item.name} ${item.nameEn ? `<span style="color: var(--text-secondary); font-weight: 400; font-size: 12px;">${item.nameEn}</span>` : ''}</div>
     <div style="font-size: 12px; color: var(--text-secondary);">
      æ¯100g: ${per100gStr}
     </div>
     ${s ? `
     <div style="font-size: 12px; color: var(--text-secondary);">
      æ¯ä»½(${s.weight || '?'}g): ${perServingStr}
     </div>
     ` : ''}
    </div>
   `}).join('');
   document.getElementById('aiImportResults').style.display = 'block';
  }
  async function analyzeWithAI() {
   if (!aiImportImageFile) {
    showToast('è«‹å…ˆé¸æ“‡åœ–ç‰‡');
    return;
   }
   document.getElementById('aiAnalyzeBtn').disabled = true;
   document.getElementById('aiConfirmBtn').style.display = 'none';
   document.getElementById('aiImportResults').style.display = 'none';
   if (!window.Poe || !window.Poe.sendUserMessage) {
    await analyzeWithOCR();
    return;
   }
   updateAIStatus('æ­£åœ¨åˆ†æåœ–ç‰‡ï¼Œè«‹ç¨å€™...');
   const prompt = `è«‹åˆ†æé€™å¼µç‡Ÿé¤Šè¡¨æ ¼åœ–ç‰‡ï¼Œæå–æ¯ç¨®é£Ÿç‰©çš„ç‡Ÿé¤Šæ•¸æ“šã€‚
è¦æ±‚ï¼š
1. å¦‚æœåŒä¸€ç¨®é£Ÿç‰©æœ‰å¤šå€‹æ¨£æœ¬ï¼ˆä¾†è‡ªä¸åŒé¤å»³ï¼‰ï¼Œè«‹è¨ˆç®—æ‰€æœ‰æ¨£æœ¬çš„å¹³å‡å€¼
2. æå–æ‰€æœ‰å¯ç”¨çš„ç‡Ÿé¤Šæ•¸æ“šï¼š
 - é£Ÿç‰©åç¨±(name)ã€è‹±æ–‡å(nameEn)
 - æ¯100g: èƒ½é‡calories(kcal)ã€è›‹ç™½è³ªprotein(g)ã€è„‚è‚ªfat(g)ã€ç¢³æ°´åŒ–åˆç‰©carbs(g)ã€éˆ‰sodium(mg)ã€éˆ£calcium(mg)
 - æ¯ä»½: é‡é‡weight(g)ã€èƒ½é‡caloriesã€è›‹ç™½è³ªproteinã€è„‚è‚ªfatã€ç¢³æ°´åŒ–åˆç‰©carbsã€éˆ‰sodiumã€éˆ£calcium
3. åªè¼¸å‡ºJSONæ•¸çµ„ï¼Œä¸è¦å…¶ä»–æ–‡å­—èªªæ˜
è¼¸å‡ºæ ¼å¼ï¼š
[
 {
  "name": "ä¸­æ–‡å",
  "nameEn": "English Name",
  "per100g": { "calories": æ•¸å­—, "protein": æ•¸å­—, "fat": æ•¸å­—, "carbs": æ•¸å­—, "sodium": æ•¸å­—, "calcium": æ•¸å­— },
  "perServing": { "weight": æ•¸å­—, "calories": æ•¸å­—, "protein": æ•¸å­—, "fat": æ•¸å­—, "carbs": æ•¸å­—, "sodium": æ•¸å­—, "calcium": æ•¸å­— }
 }
]
é‡è¦ï¼šå¦‚æœè¡¨æ ¼ä¸­æ²’æœ‰æä¾›æŸé …ç‡Ÿé¤Šæ•¸æ“šï¼Œè©²é …è¨­ç‚ºnullã€‚å¦‚æœæ²’æœ‰æ¯ä»½æ•¸æ“šï¼ŒperServingæ•´å€‹è¨­ç‚ºnullã€‚æ•¸å€¼è«‹å››æ¨äº”å…¥åˆ°åˆç†ç²¾åº¦ã€‚`;
   try {
    await window.Poe.sendUserMessage('@Claude-Sonnet-4.5 ' + prompt, {
     attachments: [aiImportImageFile],
     handler: 'ai-import-handler',
     stream: false,
     openChat: false
    });
   } catch (err) {
    updateAIStatus('ç™¼é€è«‹æ±‚å¤±æ•—: ' + err.message, 'error');
    document.getElementById('aiAnalyzeBtn').disabled = false;
   }
  }
  async function analyzeWithOCR() {
   updateAIStatus('æ­£åœ¨è¼‰å…¥ OCR å¼•æ“...');
   const loaded = await loadTesseract();
   if (!loaded || typeof Tesseract === 'undefined') {
    updateAIStatus('OCR åŠŸèƒ½ç„¡æ³•è¼‰å…¥ã€‚æ­¤åŠŸèƒ½éœ€è¦ç¶²çµ¡é€£æ¥ï¼Œæˆ–è«‹åœ¨ Poe å…§ä½¿ç”¨ AI æ¨¡å¼ã€‚', 'error');
    document.getElementById('aiAnalyzeBtn').disabled = false;
    return;
   }
   updateAIStatus('æ­£åœ¨é è™•ç†åœ–ç‰‡...');
   try {
    let processedBlob = null;
    try {
     const img = new Image();
     img.crossOrigin = 'anonymous';
     const imgUrl = URL.createObjectURL(aiImportImageFile);
     await new Promise((resolve, reject) => {
      img.onload = resolve;
      img.onerror = reject;
      img.src = imgUrl;
     });
     URL.revokeObjectURL(imgUrl);
     processedBlob = await preprocessImageForOCR(img);
    } catch (prepErr) {
         }
    const ocrTarget = processedBlob ? URL.createObjectURL(processedBlob) : URL.createObjectURL(aiImportImageFile);
    updateAIStatus('æ­£åœ¨è­˜åˆ¥æ–‡å­—ï¼ˆå¢å¼·æ¨¡å¼ï¼‰...');
    const result = await Tesseract.recognize(ocrTarget, 'eng+chi_tra+chi_sim', {
     logger: m => {
      if (m.status === 'recognizing text') {
       const progress = Math.round(m.progress * 100);
       updateAIStatus(`OCR è­˜åˆ¥ä¸­... ${progress}%`);
      }
     }
    });
    URL.revokeObjectURL(ocrTarget);
    const text = result.data.text;
        let combinedText = text;
    if (processedBlob) {
     try {
      updateAIStatus('æ­£åœ¨é€²è¡ŒäºŒæ¬¡è­˜åˆ¥...');
      const origUrl = URL.createObjectURL(aiImportImageFile);
      const result2 = await Tesseract.recognize(origUrl, 'eng+chi_tra+chi_sim', {
       logger: m => {
        if (m.status === 'recognizing text') {
         const progress = Math.round(m.progress * 100);
         updateAIStatus(`äºŒæ¬¡è­˜åˆ¥ä¸­... ${progress}%`);
        }
       }
      });
      URL.revokeObjectURL(origUrl);
      console.log('OCR Result (original):', result2.data.text);
      const parsed1 = parseMultipleFoodsFromOCR(text);
      const parsed2 = parseMultipleFoodsFromOCR(result2.data.text);
      if (parsed2.length > parsed1.length) {
       combinedText = result2.data.text;
      }
     } catch (e2) {
           }
    }
    const parsedData = parseMultipleFoodsFromOCR(combinedText);
    document.getElementById('aiAnalyzeBtn').disabled = false;
    if (parsedData && parsedData.length > 0) {
     aiImportResults = parsedData;
     displayAIResults(parsedData);
     updateAIStatus(`æˆåŠŸè­˜åˆ¥ ${parsedData.length} æ¬¾é£Ÿç‰©ï¼ˆå¢å¼· OCR æ¨¡å¼ï¼‰`, 'success');
     document.getElementById('aiConfirmBtn').style.display = 'block';
    } else {
     updateAIStatus('æœªèƒ½å¾åœ–ç‰‡è­˜åˆ¥åˆ°ç‡Ÿé¤Šæ•¸æ“šã€‚å»ºè­°ä½¿ç”¨ã€Œè²¼ä¸Šæ–‡å­—ã€åŠŸèƒ½â€”â€”ç”¨æ‰‹æ©Ÿç›¸æ©Ÿçš„æ–‡å­—è¾¨è­˜è¤‡è£½æ–‡å­—å†è²¼ä¸Šã€‚', 'error');
    }
   } catch (err) {
    console.error('OCR Error:', err);
    updateAIStatus('OCR è­˜åˆ¥å¤±æ•—: ' + err.message, 'error');
    document.getElementById('aiAnalyzeBtn').disabled = false;
   }
  }
  function parseMultipleFoodsFromOCR(text) {
   const foods = [];
   const lines = text.split('\n').filter(line => line.trim());
   let currentFood = null;
   for (const line of lines) {
    const trimmedLine = line.trim();
    if (!trimmedLine) continue;
    const caloriesMatch = trimmedLine.match(/(\d+(?:\.\d+)?)\s*(?:kcal|åƒå¡|å¤§å¡)/i);
    const proteinMatch = trimmedLine.match(/(?:è›‹ç™½è³ª|protein)[:\s]*(\d+(?:\.\d+)?)/i) ||
              trimmedLine.match(/(\d+(?:\.\d+)?)\s*g.*(?:è›‹ç™½|protein)/i);
    const numbersInLine = trimmedLine.match(/\d+(?:\.\d+)?/g);
    if (numbersInLine && numbersInLine.length >= 3) {
     const nameMatch = trimmedLine.match(/^([^\d]+)/);
     let foodName = nameMatch ? nameMatch[1].trim() : null;
     if (foodName) {
      foodName = foodName.replace(/[|ï½œ:ï¼š,ï¼Œ]/g, '').trim();
      if (foodName.length < 2) foodName = null;
     }
     const numbers = numbersInLine.map(n => parseFloat(n));
     if (numbers.length >= 4) {
      const food = {
       name: foodName || `é£Ÿç‰© ${foods.length + 1}`,
       nameEn: null,
       per100g: {
        calories: numbers[0] > 10 ? numbers[0] : null, // calories usually > 10
        protein: numbers[1] < 100 ? numbers[1] : null,
        fat: numbers[2] < 100 ? numbers[2] : null,
        carbs: numbers[3] < 200 ? numbers[3] : null,
        sodium: numbers[4] || null,
        calcium: numbers[5] || null
       },
       perServing: null
      };
      foods.push(food);
     }
    }
   }
   if (foods.length === 0) {
    const singleFood = parseNutritionFromOCR(text);
    if (singleFood && (singleFood.calories || singleFood.protein || singleFood.fat || singleFood.carbs)) {
     foods.push({
      name: singleFood.name || 'æœªå‘½åé£Ÿç‰©',
      nameEn: singleFood.nameEn,
      per100g: {
       calories: singleFood.calories,
       protein: singleFood.protein,
       fat: singleFood.fat,
       carbs: singleFood.carbs,
       sodium: singleFood.sodium,
       calcium: singleFood.calcium
      },
      perServing: singleFood.mode === 'perServing' && singleFood.servingWeight ? {
       weight: singleFood.servingWeight,
       calories: singleFood.calories,
       protein: singleFood.protein,
       fat: singleFood.fat,
       carbs: singleFood.carbs,
       sodium: singleFood.sodium,
       calcium: singleFood.calcium
      } : null
     });
    }
   }
   return foods;
  }
  function confirmAIImport() {
   if (aiImportResults.length === 0) {
    showToast('æ²’æœ‰å¯åŒ¯å…¥çš„æ•¸æ“š');
    return;
   }
   let targetCategory = document.getElementById('aiImportCategory').value;
   const newCategory = document.getElementById('aiNewCategory').value.trim();
   const newEmoji = document.getElementById('aiNewCategoryEmoji').value.trim() || '';
   if (newCategory) {
    targetCategory = newCategory;
    if (!categories.includes(newCategory)) {
     categories.splice(categories.length - 1, 0, newCategory); // Insert before 'å…¶ä»–'
     categoryEmojis[newCategory] = newEmoji;
    }
   }
   if (!targetCategory) {
    showToast('è«‹é¸æ“‡æˆ–è¼¸å…¥åˆ†é¡');
    return;
   }
   let maxId = Math.max(...foods.map(f => parseInt(f.id) || 0), 0);
   let addedCount = 0;
   aiImportResults.forEach(item => {
    maxId++;
    const p = item.per100g || {};
    const s = item.perServing;
    const foodData = {
     id: maxId.toString(),
     name: item.name,
     nameEn: item.nameEn || null,
     category: targetCategory,
     per100g: {
      calories: p.calories ?? null,
      protein: p.protein ?? null,
      fat: p.fat ?? null,
      carbs: p.carbs ?? null,
      sodium: p.sodium ?? null,
      calcium: p.calcium ?? null
     },
     perServing: s ? {
      weight: s.weight ?? null,
      calories: s.calories ?? null,
      protein: s.protein ?? null,
      fat: s.fat ?? null,
      carbs: s.carbs ?? null,
      sodium: s.sodium ?? null,
      calcium: s.calcium ?? null
     } : null
    };
    foods.push(foodData);
    addedCount++;
   });
   saveToIndexedDB();
   renderCategories();
   renderCategoryPills();
   renderFoodList();
   updateStats();
   closeAIImportModal();
   showToast(`æˆåŠŸåŒ¯å…¥ ${addedCount} æ¬¾é£Ÿç‰©åˆ°ã€Œ${targetCategory}ã€`);
  }
  async function loadCloudUrl() {
   if (!db) return;
   try {
    const tx = db.transaction(['settings'], 'readonly');
    const store = tx.objectStore('settings');
    const result = await new Promise((resolve, reject) => {
     const req = store.get('cloudSyncUrl');
     req.onsuccess = () => resolve(req.result);
     req.onerror = reject;
    });
    if (result && result.value) {
     cloudSyncUrl = result.value;
     document.getElementById('cloudUrl').value = cloudSyncUrl;
    }
   } catch (err) {
       }
  }
  async function saveCloudUrl() {
   cloudSyncUrl = document.getElementById('cloudUrl').value.trim();
   if (!db) {
    showToast('å„²å­˜å¤±æ•—');
    return;
   }
   try {
    const tx = db.transaction(['settings'], 'readwrite');
    const store = tx.objectStore('settings');
    await new Promise((resolve, reject) => {
     const req = store.put({ key: 'cloudSyncUrl', value: cloudSyncUrl });
     req.onsuccess = resolve;
     req.onerror = reject;
    });
    showToast('å·²å„²å­˜ç¶²å€è¨­å®š');
   } catch (err) {
    showToast('å„²å­˜å¤±æ•—');
    console.error(err);
   }
  }
  function setCloudStatus(message, type) {
   const status = document.getElementById('cloudStatus');
   status.textContent = message;
   status.className = 'cloud-status';
   if (type) {
    status.classList.add(type);
   }
   status.style.display = message ? 'block' : 'none';
  }
  async function uploadToCloud() {
   const url = document.getElementById('cloudUrl').value.trim();
   if (!url) {
    setCloudStatus('è«‹å…ˆè¼¸å…¥ Google Apps Script ç¶²å€', 'error');
    return;
   }
   const uploadBtn = document.getElementById('cloudUploadBtn');
   uploadBtn.disabled = true;
   uploadBtn.classList.add('loading');
   uploadBtn.innerHTML = '<i class="fas fa-spinner"></i> ä¸Šå‚³ä¸­...';
   setCloudStatus('æ­£åœ¨ä¸Šå‚³è³‡æ–™...', '');
   try {
    const data = {
     foods: foods,
     categories: categories,
     lastUpdated: new Date().toISOString()
    };
    const response = await fetch(url, {
     method: 'POST',
     mode: 'no-cors',
     headers: {
      'Content-Type': 'application/json',
     },
     body: JSON.stringify(data)
    });
    setCloudStatus('âœ… å·²ä¸Šå‚³åˆ°é›²ç«¯ï¼', 'success');
    showToast('å·²ä¸Šå‚³åˆ°é›²ç«¯');
   } catch (err) {
    setCloudStatus('ä¸Šå‚³å¤±æ•—ï¼š' + err.message, 'error');
    showToast('ä¸Šå‚³å¤±æ•—');
   } finally {
    uploadBtn.disabled = false;
    uploadBtn.classList.remove('loading');
    uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³åˆ°é›²ç«¯';
   }
  }
  async function downloadFromCloud() {
   const url = document.getElementById('cloudUrl').value.trim();
   if (!url) {
    setCloudStatus('è«‹å…ˆè¼¸å…¥ Google Apps Script ç¶²å€', 'error');
    return;
   }
   const downloadBtn = document.getElementById('cloudDownloadBtn');
   downloadBtn.disabled = true;
   downloadBtn.classList.add('loading');
   downloadBtn.innerHTML = '<i class="fas fa-spinner"></i> ä¸‹è¼‰ä¸­...';
   setCloudStatus('æ­£åœ¨å¾é›²ç«¯ä¸‹è¼‰è³‡æ–™...', '');
   try {
    const response = await fetch(url);
    if (!response.ok) {
     throw new Error('ç¶²çµ¡éŒ¯èª¤');
    }
    const data = await response.json();
    if (data.foods && Array.isArray(data.foods)) {
     foods = data.foods;
    }
    if (data.categories && Array.isArray(data.categories)) {
     categories = data.categories;
    }
    renderCategories();
    renderCategoryPills();
    renderFoodList();
    updateStats();
    saveToIndexedDB();
    const lastUpdated = data.lastUpdated ? new Date(data.lastUpdated).toLocaleString('zh-HK') : 'æœªçŸ¥';
    setCloudStatus(`âœ… å·²åŒæ­¥ï¼ä¸Šæ¬¡æ›´æ–°ï¼š${lastUpdated}`, 'success');
    showToast('å·²å¾é›²ç«¯ä¸‹è¼‰è³‡æ–™');
   } catch (err) {
    setCloudStatus('ä¸‹è¼‰å¤±æ•—ï¼š' + err.message, 'error');
    showToast('ä¸‹è¼‰å¤±æ•—');
   } finally {
    downloadBtn.disabled = false;
    downloadBtn.classList.remove('loading');
    downloadBtn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> å¾é›²ç«¯ä¸‹è¼‰';
   }
  }
  const defaultFoods = JSON.parse(JSON.stringify(foods));
  const defaultCategories = [...categories];
  const defaultCategoryEmojis = {...categoryEmojis};
  function setSheetSyncStatus(message, type) {
   const status = document.getElementById('sheetSyncStatus');
   if (!status) return;
   status.innerHTML = message;
   status.style.display = message ? 'block' : 'none';
   status.style.background = type === 'success' ? 'rgba(34, 197, 94, 0.1)' :
                type === 'error' ? 'rgba(239, 68, 68, 0.1)' :
                'rgba(99, 102, 241, 0.1)';
   status.style.color = type === 'success' ? '#22c55e' :
             type === 'error' ? '#ef4444' :
             'var(--text-secondary)';
  }
  async function loadGoogleSheetUrl() {
   if (!db) return '';
   try {
    const tx = db.transaction(['settings'], 'readonly');
    const store = tx.objectStore('settings');
    const result = await new Promise((resolve, reject) => {
     const req = store.get('googleSheetUrl');
     req.onsuccess = () => resolve(req.result);
     req.onerror = reject;
    });
    return result ? result.value : '';
   } catch (err) {
    return '';
   }
  }
  async function saveGoogleSheetUrl() {
   const url = document.getElementById('googleSheetUrl').value.trim();
   if (!url) {
    showToast('è«‹è¼¸å…¥ Google Sheets ç¶²å€');
    return;
   }
   setSheetSyncStatus('<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ¸¬è©¦é€£æ¥...', '');
   try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('ç„¡æ³•é€£æ¥åˆ° Google Sheets');
    const csvText = await response.text();
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) throw new Error('Google Sheet æ²’æœ‰è³‡æ–™');
    if (db) {
     const tx = db.transaction(['settings'], 'readwrite');
     const store = tx.objectStore('settings');
     await new Promise((resolve, reject) => {
      const req = store.put({ key: 'googleSheetUrl', value: url });
      req.onsuccess = resolve;
      req.onerror = reject;
     });
    }
    setSheetSyncStatus(`<i class="fas fa-check-circle"></i> é€£æ¥æˆåŠŸï¼æ‰¾åˆ° ${lines.length - 1} ç­†è³‡æ–™`, 'success');
    showToast('è¨­å®šå·²å„²å­˜ï¼Œé€£æ¥æˆåŠŸï¼');
   } catch (err) {
    setSheetSyncStatus('<i class="fas fa-exclamation-circle"></i> ' + err.message, 'error');
    showToast('é€£æ¥å¤±æ•—ï¼š' + err.message);
   }
  }
  async function loadLastSyncTime() {
   if (!db) return null;
   try {
    const tx = db.transaction(['settings'], 'readonly');
    const store = tx.objectStore('settings');
    const result = await new Promise((resolve, reject) => {
     const req = store.get('lastSyncTime');
     req.onsuccess = () => resolve(req.result);
     req.onerror = reject;
    });
    return result ? result.value : null;
   } catch (err) {
    return null;
   }
  }
  async function saveLastSyncTime() {
   if (!db) return;
   const now = new Date().toISOString();
   try {
    const tx = db.transaction(['settings'], 'readwrite');
    const store = tx.objectStore('settings');
    await new Promise((resolve, reject) => {
     const req = store.put({ key: 'lastSyncTime', value: now });
     req.onsuccess = resolve;
     req.onerror = reject;
    });
    updateLastSyncDisplay(now);
   } catch (err) {
       }
  }
  function updateLastSyncDisplay(isoTime) {
   const el = document.getElementById('lastSyncTime');
   if (el && isoTime) {
    const date = new Date(isoTime);
    el.textContent = date.toLocaleString('zh-HK');
   }
  }
  function parseCSVToFoods(csvText) {
   const lines = csvText.trim().split('\n');
   if (lines.length < 2) return [];
   const headers = parseCSVLine(lines[0]);
   const foodsData = [];
   for (let i = 1; i < lines.length; i++) {
    const values = parseCSVLine(lines[i]);
    if (values.length < 3) continue; // Skip invalid rows
    const row = {};
    headers.forEach((h, idx) => {
     row[h.trim()] = values[idx] ? values[idx].trim() : '';
    });
    const food = {
     id: row['id'] || String(i),
     name: row['name'] || row['åç¨±'] || '',
     nameEn: row['nameEn'] || row['è‹±æ–‡åç¨±'] || '',
     category: row['category'] || row['åˆ†é¡'] || 'å…¶ä»–',
     per100g: {
      calories: parseFloat(row['calories_100g'] || row['å¡è·¯é‡Œ_100g']) || null,
      protein: parseFloat(row['protein_100g'] || row['è›‹ç™½è³ª_100g']) || null,
      fat: parseFloat(row['fat_100g'] || row['è„‚è‚ª_100g']) || null,
      carbs: parseFloat(row['carbs_100g'] || row['ç¢³æ°´åŒ–åˆç‰©_100g']) || null,
      sodium: parseFloat(row['sodium_100g'] || row['éˆ‰_100g']) || null,
      calcium: parseFloat(row['calcium_100g'] || row['éˆ£_100g']) || null
     }
    };
    const servingWeight = parseFloat(row['serving_weight'] || row['æ¯ä»½é‡é‡']);
    if (servingWeight) {
     food.perServing = {
      weight: servingWeight,
      calories: parseFloat(row['calories_serving'] || row['å¡è·¯é‡Œ_æ¯ä»½']) || null,
      protein: parseFloat(row['protein_serving'] || row['è›‹ç™½è³ª_æ¯ä»½']) || null,
      fat: parseFloat(row['fat_serving'] || row['è„‚è‚ª_æ¯ä»½']) || null,
      carbs: parseFloat(row['carbs_serving'] || row['ç¢³æ°´åŒ–åˆç‰©_æ¯ä»½']) || null,
      sodium: parseFloat(row['sodium_serving'] || row['éˆ‰_æ¯ä»½']) || null,
      calcium: parseFloat(row['calcium_serving'] || row['éˆ£_æ¯ä»½']) || null
     };
    }
    if (food.name) {
     foodsData.push(food);
    }
   }
   return foodsData;
  }
  function parseCSVLine(line) {
   const result = [];
   let current = '';
   let inQuotes = false;
   for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
     inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
     result.push(current);
     current = '';
    } else {
     current += char;
    }
   }
   result.push(current);
   return result;
  }
  async function syncFromGoogleSheet() {
   const btn = document.getElementById('sheetSyncBtn');
   if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŒæ­¥ä¸­...';
   }
   setSheetSyncStatus('<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨å¾ Google Sheets ç²å–è³‡æ–™...', '');
   try {
    const sheetUrl = await loadGoogleSheetUrl();
    if (!sheetUrl) {
     setSheetSyncStatus('<i class="fas fa-info-circle"></i> å°šæœªè¨­å®š Google Sheets ç¶²å€', '');
     showToast('è«‹å…ˆè¨­å®š Google Sheets ç¶²å€');
     return;
    }
    const response = await fetch(sheetUrl);
    if (!response.ok) throw new Error('ç„¡æ³•é€£æ¥åˆ° Google Sheets');
    const csvText = await response.text();
    const newFoods = parseCSVToFoods(csvText);
    if (newFoods.length === 0) {
     throw new Error('æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é£Ÿç‰©è³‡æ–™');
    }
    foods = newFoods;
    const newCategories = [...new Set(newFoods.map(f => f.category))];
    categories = newCategories.filter(c => c);
    renderCategories();
    renderCategoryPills();
    renderFoodList();
    updateStats();
    saveToIndexedDB();
    await saveLastSyncTime();
    setSheetSyncStatus(`<i class="fas fa-check-circle"></i> åŒæ­¥æˆåŠŸï¼å·²è¼‰å…¥ ${newFoods.length} æ¬¾é£Ÿç‰©`, 'success');
    showToast(`å·²åŒæ­¥ ${newFoods.length} æ¬¾é£Ÿç‰©`);
   } catch (err) {
    console.error('Google Sheet sync error:', err);
    setSheetSyncStatus('<i class="fas fa-exclamation-circle"></i> åŒæ­¥å¤±æ•—ï¼š' + err.message, 'error');
    showToast('åŒæ­¥å¤±æ•—');
   } finally {
    if (btn) {
     btn.disabled = false;
     btn.innerHTML = '<i class="fas fa-sync"></i> ç«‹å³åŒæ­¥æœ€æ–°è³‡æ–™';
    }
   }
  }
  function showSheetTemplate() {
   const modal = document.createElement('div');
   modal.className = 'modal-overlay show';
   modal.innerHTML = `
    <div class="modal" style="max-width: 95vw; max-height: 85vh;">
     <div class="modal-header">
      <span class="modal-title">Google Sheets æ¨¡æ¿æ ¼å¼</span>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
       <i class="fas fa-times"></i>
      </button>
     </div>
     <div class="modal-body" style="overflow-x: auto;">
      <p style="margin-bottom: 12px; color: var(--text-secondary); font-size: 13px;">
       åœ¨ Google Sheets å»ºç«‹ä»¥ä¸‹æ¬„ä½ï¼ˆç¬¬ä¸€è¡Œç‚ºæ¨™é¡Œï¼‰ï¼š
      </p>
      <div style="overflow-x: auto; margin-bottom: 16px;">
       <table style="border-collapse: collapse; font-size: 11px; white-space: nowrap;">
        <tr style="background: var(--accent); color: white;">
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">id</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">name</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">nameEn</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">category</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">calories_100g</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">protein_100g</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">fat_100g</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">carbs_100g</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">sodium_100g</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">calcium_100g</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">serving_weight</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">calories_serving</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">protein_serving</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">fat_serving</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">carbs_serving</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">sodium_serving</th>
         <th style="padding: 6px 8px; border: 1px solid var(--divider);">calcium_serving</th>
        </tr>
        <tr>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">1</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">è¦é¤ƒ</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">Shrimp dumpling</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">é»å¿ƒ</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">140</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">7.8</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">3.3</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">19</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">370</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">34</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">71</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">100</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">5.6</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">2.4</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">14</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">260</td>
         <td style="padding: 6px 8px; border: 1px solid var(--divider);">24</td>
        </tr>
       </table>
      </div>
      <p style="margin-bottom: 12px; color: var(--text-secondary); font-size: 12px;">
       <strong>æç¤ºï¼š</strong><br>
       â€¢ ç¬¬ä¸€è¡Œå¿…é ˆæ˜¯æ¬„ä½æ¨™é¡Œ<br>
       â€¢ idã€nameã€category ç‚ºå¿…å¡«<br>
       â€¢ æ•¸å€¼æ¬„ä½ç•™ç©ºæœƒé¡¯ç¤ºç‚º "--"<br>
       â€¢ serving_weight é–‹å§‹çš„æ¬„ä½ç‚ºé¸å¡«
      </p>
      <button class="submit-btn" onclick="exportToCSV(); this.closest('.modal-overlay').remove();">
       <i class="fas fa-download"></i> åŒ¯å‡ºç›®å‰è³‡æ–™ç‚º CSVï¼ˆå¯ç›´æ¥åŒ¯å…¥ Google Sheetsï¼‰
      </button>
     </div>
    </div>
   `;
   document.body.appendChild(modal);
  }
  function exportToCSV() {
   const headers = ['id', 'name', 'nameEn', 'category', 'calories_100g', 'protein_100g', 'fat_100g', 'carbs_100g', 'sodium_100g', 'calcium_100g', 'serving_weight', 'calories_serving', 'protein_serving', 'fat_serving', 'carbs_serving', 'sodium_serving', 'calcium_serving'];
   let csv = headers.join(',') + '\n';
   foods.forEach(food => {
    const row = [
     food.id,
     `"${(food.name || '').replace(/"/g, '""')}"`,
     `"${(food.nameEn || '').replace(/"/g, '""')}"`,
     `"${(food.category || '').replace(/"/g, '""')}"`,
     food.per100g?.calories ?? '',
     food.per100g?.protein ?? '',
     food.per100g?.fat ?? '',
     food.per100g?.carbs ?? '',
     food.per100g?.sodium ?? '',
     food.per100g?.calcium ?? '',
     food.perServing?.weight ?? '',
     food.perServing?.calories ?? '',
     food.perServing?.protein ?? '',
     food.perServing?.fat ?? '',
     food.perServing?.carbs ?? '',
     food.perServing?.sodium ?? '',
     food.perServing?.calcium ?? ''
    ];
    csv += row.join(',') + '\n';
   });
   const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' }); // BOM for Excel
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = `nutrition-data-${new Date().toISOString().slice(0,10)}.csv`;
   a.click();
   URL.revokeObjectURL(url);
   showToast('å·²åŒ¯å‡º CSV æª”æ¡ˆ');
  }
  function resetToDefault() {
   const modal = document.createElement('div');
   modal.className = 'modal-overlay show';
   modal.innerHTML = `
    <div class="modal" style="max-width: 320px;">
     <div class="modal-header">
      <span class="modal-title">ç¢ºèªé‡ç½®</span>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
       <i class="fas fa-times"></i>
      </button>
     </div>
     <div class="modal-body">
      <p style="margin-bottom: 16px; color: var(--text-secondary);">
       ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­è³‡æ–™å—ï¼Ÿ<br>æ‚¨çš„æœ¬æ©Ÿä¿®æ”¹å°‡æœƒè¢«è¦†è“‹ã€‚
      </p>
      <div style="display: flex; gap: 8px;">
       <button class="submit-btn" style="flex: 1; background: var(--text-secondary);" onclick="this.closest('.modal-overlay').remove()">
        å–æ¶ˆ
       </button>
       <button class="submit-btn" style="flex: 1; background: #ef4444;" onclick="confirmReset(); this.closest('.modal-overlay').remove();">
        é‡ç½®
       </button>
      </div>
     </div>
    </div>
   `;
   document.body.appendChild(modal);
  }
  function confirmReset() {
   foods = JSON.parse(JSON.stringify(defaultFoods));
   categories = [...defaultCategories];
   Object.keys(categoryEmojis).forEach(k => delete categoryEmojis[k]);
   Object.assign(categoryEmojis, defaultCategoryEmojis);
   renderCategories();
   renderCategoryPills();
   renderFoodList();
   updateStats();
   saveToIndexedDB();
   showToast('å·²é‡ç½®ç‚ºé è¨­è³‡æ–™');
  }
  function exportLocalData() {
   const data = {
    foods: foods,
    categories: categories,
    categoryEmojis: categoryEmojis,
    exportedAt: new Date().toISOString()
   };
   const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
   const url = URL.createObjectURL(blob);
   const a = document.createElement('a');
   a.href = url;
   a.download = `nutrition-data-${new Date().toISOString().slice(0,10)}.json`;
   a.click();
   URL.revokeObjectURL(url);
   showToast('å·²åŒ¯å‡º JSON è³‡æ–™');
  }
  let autoSyncEnabled = false;
  let _syncLock = false;
  async function loadAppsScriptUrl() {
   if (memorySettings.appsScriptUrl) {
    return memorySettings.appsScriptUrl;
   }
   if (!db) {
    return '';
   }
   try {
    return await new Promise((resolve) => {
     const tx = db.transaction(['settings'], 'readonly');
     const store = tx.objectStore('settings');
     const req = store.get('appsScriptUrl');
     req.onsuccess = () => resolve(req.result ? req.result.value : '');
     req.onerror = () => resolve('');
    });
   } catch (err) {
        return '';
   }
  }
  async function saveAppsScriptUrl() {
   const url = document.getElementById('appsScriptUrl').value.trim();
   if (!url) {
    showToast('è«‹è¼¸å…¥ Google Apps Script ç¶²å€');
    return;
   }
   setSheetSyncStatus('<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ¸¬è©¦é€£æ¥...', '');
   try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('ç„¡æ³•é€£æ¥');
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'é€£æ¥å¤±æ•—');
    memorySettings.appsScriptUrl = url;
    if (db) {
     try {
      const tx = db.transaction(['settings'], 'readwrite');
      const store = tx.objectStore('settings');
      await new Promise((resolve, reject) => {
       const req = store.put({ key: 'appsScriptUrl', value: url });
       req.onsuccess = resolve;
       req.onerror = reject;
      });
     } catch (e) {
           }
    }
    const count = data.data?.foods?.length || 0;
    setSheetSyncStatus(`<i class="fas fa-check-circle"></i> é€£æ¥æˆåŠŸï¼é›²ç«¯æœ‰ ${count} æ¬¾é£Ÿç‰©`, 'success');
    showToast('è¨­å®šå·²å„²å­˜ï¼');
    updateSyncModeIndicator(true);
   } catch (err) {
    setSheetSyncStatus('<i class="fas fa-exclamation-circle"></i> ' + err.message, 'error');
    showToast('é€£æ¥å¤±æ•—');
   }
  }
  function updateSyncModeIndicator(connected) {
   const indicator = document.getElementById('syncModeIndicator');
   if (indicator) {
    if (connected) {
     indicator.innerHTML = '<i class="fas fa-check-circle" style="color: #22c55e;"></i><span style="color: #22c55e;">å·²é€£æ¥é›²ç«¯</span>';
    } else {
     indicator.innerHTML = '<i class="fas fa-info-circle"></i><span>å°šæœªè¨­å®šé›²ç«¯åŒæ­¥</span>';
    }
   }
  }
  async function toggleAutoSync() {
   autoSyncEnabled = document.getElementById('autoSyncCheckbox').checked;
      memorySettings.autoSyncEnabled = autoSyncEnabled;
   if (db) {
    try {
     const tx = db.transaction(['settings'], 'readwrite');
     const store = tx.objectStore('settings');
     await new Promise((resolve, reject) => {
      const req = store.put({ key: 'autoSyncEnabled', value: autoSyncEnabled });
      req.onsuccess = () => {
              resolve();
      };
      req.onerror = () => {
              reject();
      };
     });
    } catch (err) {
         }
   }
   showToast(autoSyncEnabled ? 'å·²å•Ÿç”¨è‡ªå‹•åŒæ­¥' : 'å·²åœç”¨è‡ªå‹•åŒæ­¥');
   if (autoSyncEnabled) {
        autoUploadIfEnabled();
   }
  }
  async function loadAutoSyncSetting() {
   if (memorySettings.autoSyncEnabled !== undefined) {
    return memorySettings.autoSyncEnabled;
   }
   if (!db) return false;
   try {
    return await new Promise((resolve) => {
     const tx = db.transaction(['settings'], 'readonly');
     const store = tx.objectStore('settings');
     const req = store.get('autoSyncEnabled');
     req.onsuccess = () => resolve(req.result ? req.result.value : false);
     req.onerror = () => resolve(false);
    });
   } catch (err) {
        return false;
   }
  }
  async function syncToCloud() {
   const url = await loadAppsScriptUrl();
   if (!url) {
    showToast('è«‹å…ˆè¨­å®š Google Apps Script ç¶²å€');
    return;
   }
   const btn = document.getElementById('cloudUploadBtn');
   if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';
   }
   setSheetSyncStatus('<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨ä¸Šå‚³åˆ°é›²ç«¯...', '');
   try {
    const dataToSend = {
     foods: foods,
     categories: categories,
     categoryEmojis: categoryEmojis,
     savedDocs: savedDocs,
     lastUpdated: new Date().toISOString()
    };
    await fetch(url, {
     method: 'POST',
     mode: 'no-cors',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify(dataToSend)
    });
    setSheetSyncStatus('<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨é©—è­‰ä¸Šå‚³...', '');
    await new Promise(function(r){setTimeout(r, 2000);});
    try {
     const vResp = await fetch(url);
     if (vResp.ok) {
      const vResult = await vResp.json();
      if (vResult.success && vResult.data && vResult.data.foods) {
       const cloudCount = vResult.data.foods.length;
       await saveLastSyncTime();
       if (cloudCount === foods.length) {
        setSheetSyncStatus('<i class="fas fa-check-circle"></i> ä¸Šå‚³æˆåŠŸï¼é›²ç«¯å…± ' + cloudCount + ' æ¬¾é£Ÿç‰©ï¼ˆå·²é©—è­‰ï¼‰', 'success');
        showToast('å·²ä¸Šå‚³åˆ°é›²ç«¯ âœ“ ' + cloudCount + ' æ¬¾é£Ÿç‰©');
       } else {
        setSheetSyncStatus('<i class="fas fa-exclamation-triangle"></i> ä¸Šå‚³å¯èƒ½æœªå®Œæˆï¼šé›²ç«¯ ' + cloudCount + ' æ¬¾ / æœ¬åœ° ' + foods.length + ' æ¬¾', 'error');
        showToast('âš ï¸ é›²ç«¯åªæœ‰ ' + cloudCount + ' æ¬¾ï¼Œè«‹é‡è©¦');
       }
      } else {
       setSheetSyncStatus('<i class="fas fa-exclamation-triangle"></i> å·²ä¸Šå‚³ä½†ç„¡æ³•é©—è­‰é›²ç«¯è³‡æ–™', 'error');
       showToast('ä¸Šå‚³å®Œæˆä½†é©—è­‰å¤±æ•—');
      }
     } else {
      await saveLastSyncTime();
      setSheetSyncStatus('<i class="fas fa-check-circle"></i> å·²ä¸Šå‚³ï¼ˆç„¡æ³•é©—è­‰ï¼Œå…±é€å‡º ' + foods.length + ' æ¬¾ï¼‰', 'success');
      showToast('å·²ä¸Šå‚³åˆ°é›²ç«¯');
     }
    } catch (verifyErr) {
     await saveLastSyncTime();
     setSheetSyncStatus('<i class="fas fa-check-circle"></i> å·²ä¸Šå‚³ï¼ˆç„¡æ³•é©—è­‰ï¼Œå…±é€å‡º ' + foods.length + ' æ¬¾ï¼‰', 'success');
     showToast('å·²ä¸Šå‚³åˆ°é›²ç«¯');
    }
   } catch (err) {
    console.error('Upload error:', err);
    setSheetSyncStatus('<i class="fas fa-exclamation-circle"></i> ä¸Šå‚³å¤±æ•—ï¼š' + err.message, 'error');
    showToast('ä¸Šå‚³å¤±æ•—');
   } finally {
    if (btn) {
     btn.disabled = false;
     btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³';
    }
   }
  }
  async function syncFromCloud() {
   const url = await loadAppsScriptUrl();
   if (!url) {
    showToast('è«‹å…ˆè¨­å®š Google Apps Script ç¶²å€');
    return;
   }
   const btn = document.getElementById('cloudDownloadBtn');
   if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸‹è¼‰ä¸­...';
   }
   setSheetSyncStatus('<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨å¾é›²ç«¯ä¸‹è¼‰...', '');
   try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('ç„¡æ³•é€£æ¥');
    const result = await response.json();
    if (!result.success) throw new Error(result.error || 'ä¸‹è¼‰å¤±æ•—');
    const data = result.data;
    const cloudFoodCount = (data.foods && Array.isArray(data.foods)) ? data.foods.length : 0;
    const localFoodCount = foods.length;
    if (cloudFoodCount > 0 && cloudFoodCount < localFoodCount * 0.5) {
     setSheetSyncStatus('<i class="fas fa-exclamation-triangle"></i> é›²ç«¯åªæœ‰ ' + cloudFoodCount + ' æ¬¾ï¼Œæœ¬åœ°æœ‰ ' + localFoodCount + ' æ¬¾ã€‚å·²é˜»æ­¢ä¸‹è¼‰ä»¥ä¿è­·æœ¬åœ°è³‡æ–™ã€‚è«‹å…ˆä¸Šå‚³æ¢å¾©é›²ç«¯ã€‚', 'error');
     showToast('âš ï¸ é›²ç«¯è³‡æ–™ç•°å¸¸ï¼ˆ' + cloudFoodCount + ' æ¬¾ï¼‰ï¼Œå·²é˜»æ­¢è¦†è“‹');
     if (data.savedDocs && Array.isArray(data.savedDocs)) {
      savedDocs = data.savedDocs;
      saveDocs();
     }
    } else if (cloudFoodCount > 0) {
     foods = data.foods;
     if (data.categories && Array.isArray(data.categories)) {
      categories = data.categories;
     }
     if (data.categoryEmojis) {
      Object.keys(categoryEmojis).forEach(k => delete categoryEmojis[k]);
      Object.assign(categoryEmojis, data.categoryEmojis);
     }
     if (data.savedDocs && Array.isArray(data.savedDocs)) {
      savedDocs = data.savedDocs;
      saveDocs();
     }
     renderCategories();
     renderCategoryPills();
     renderFoodList();
     updateStats();
     saveToIndexedDB();
     await saveLastSyncTime();
     setSheetSyncStatus('<i class="fas fa-check-circle"></i> ä¸‹è¼‰æˆåŠŸï¼é›²ç«¯å…± ' + cloudFoodCount + ' æ¬¾é£Ÿç‰©', 'success');
     showToast('å·²å¾é›²ç«¯ä¸‹è¼‰ ' + cloudFoodCount + ' æ¬¾é£Ÿç‰©');
    } else {
     setSheetSyncStatus('<i class="fas fa-exclamation-triangle"></i> é›²ç«¯æ²’æœ‰é£Ÿç‰©è³‡æ–™ï¼Œä¿ç•™æœ¬åœ° ' + localFoodCount + ' æ¬¾', 'error');
     showToast('âš ï¸ é›²ç«¯æ²’æœ‰é£Ÿç‰©è³‡æ–™');
    }
   } catch (err) {
    console.error('Download error:', err);
    setSheetSyncStatus('<i class="fas fa-exclamation-circle"></i> ' + err.message, 'error');
    showToast('ä¸‹è¼‰å¤±æ•—');
   } finally {
    if (btn) {
     btn.disabled = false;
     btn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> ä¸‹è¼‰';
    }
   }
  }
  async function autoUploadIfEnabled() {
   if (!autoSyncEnabled || _syncLock) return;
   if (foods.length < 10) {
    console.log('Auto-upload skipped: only ' + foods.length + ' items, too few to upload');
    return;
   }
   const url = await loadAppsScriptUrl();
   if (!url) return;
   try {
    const dataToSend = {
     foods: foods,
     categories: categories,
     categoryEmojis: categoryEmojis,
     savedDocs: savedDocs,
     lastUpdated: new Date().toISOString()
    };
    showToast('æ­£åœ¨è‡ªå‹•åŒæ­¥...', 1000);
    await fetch(url, {
     method: 'POST',
     mode: 'no-cors',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify(dataToSend)
    });
    showToast('å·²è‡ªå‹•åŒæ­¥åˆ°é›²ç«¯ âœ“ (' + foods.length + ' æ¬¾)', 1500);
   } catch (err) {
    console.log('Auto-sync failed:', err.message);
    showToast('è‡ªå‹•åŒæ­¥å¤±æ•—', 1500);
   }
  }
  function showAppsScriptSetup() {
   const scriptCode = "// Google Apps Script ä»£ç¢¼ - è¤‡è£½æ­¤ä»£ç¢¼åˆ° Google Apps Script\n\nconst SCRIPT_PROP = PropertiesService.getScriptProperties();\n\nfunction doGet(e) {\n  try {\n    const data = SCRIPT_PROP.getProperty('nutritionData');\n    return ContentService\n      .createTextOutput(JSON.stringify({\n        success: true,\n        data: data ? JSON.parse(data) : { foods: [], categories: [], categoryEmojis: {} }\n      }))\n      .setMimeType(ContentService.MimeType.JSON);\n  } catch (err) {\n    return ContentService\n      .createTextOutput(JSON.stringify({ success: false, error: err.message }))\n      .setMimeType(ContentService.MimeType.JSON);\n  }\n}\n\nfunction doPost(e) {\n  try {\n    const data = JSON.parse(e.postData.contents);\n    SCRIPT_PROP.setProperty('nutritionData', JSON.stringify(data));\n    return ContentService\n      .createTextOutput(JSON.stringify({ success: true }))\n      .setMimeType(ContentService.MimeType.JSON);\n  } catch (err) {\n    return ContentService\n      .createTextOutput(JSON.stringify({ success: false, error: err.message }))\n      .setMimeType(ContentService.MimeType.JSON);\n  }\n}";
   const modal = document.createElement('div');
   modal.className = 'modal-overlay show';
   modal.innerHTML = `
    <div class="modal" style="max-width: 95vw; max-height: 90vh;">
     <div class="modal-header">
      <span class="modal-title">Google Apps Script è¨­å®šæ•™å­¸</span>
      <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
       <i class="fas fa-times"></i>
      </button>
     </div>
     <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
      <div style="margin-bottom: 16px;">
       <strong>æ­¥é©Ÿ 1ï¼šå»ºç«‹ Apps Script</strong>
       <ol style="margin: 8px 0; padding-left: 20px; font-size: 13px; color: var(--text-secondary);">
        <li>å‰å¾€ <a href="https://script.google.com" target="_blank" style="color: var(--accent);">script.google.com</a></li>
        <li>é»æ“Šã€Œæ–°å°ˆæ¡ˆã€</li>
        <li>åˆªé™¤é è¨­ä»£ç¢¼ï¼Œè²¼ä¸Šä¸‹æ–¹ä»£ç¢¼</li>
       </ol>
      </div>
      <div style="margin-bottom: 16px;">
       <strong>æ­¥é©Ÿ 2ï¼šè¤‡è£½æ­¤ä»£ç¢¼</strong>
       <pre id="scriptCodePre" style="background: var(--bg-primary); padding: 12px; border-radius: 8px; font-size: 11px; overflow-x: auto; white-space: pre-wrap; margin-top: 8px;"></pre>
       <button class="submit-btn" style="margin-top: 8px;" onclick="copyScriptCode()">
        <i class="fas fa-copy"></i> è¤‡è£½ä»£ç¢¼
       </button>
      </div>
      <div style="margin-bottom: 16px;">
       <strong>æ­¥é©Ÿ 3ï¼šéƒ¨ç½²ç‚ºç¶²é æ‡‰ç”¨ç¨‹å¼</strong>
       <ol style="margin: 8px 0; padding-left: 20px; font-size: 13px; color: var(--text-secondary);">
        <li>é»æ“Šå³ä¸Šè§’ã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ã€</li>
        <li>é¡å‹é¸æ“‡ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€</li>
        <li>åŸ·è¡Œèº«åˆ†ï¼šã€Œæˆ‘ã€</li>
        <li>èª°å¯ä»¥å­˜å–ï¼šã€Œæ‰€æœ‰äººã€</li>
        <li>é»æ“Šã€Œéƒ¨ç½²ã€</li>
        <li>è¤‡è£½ç”¢ç”Ÿçš„ç¶²å€</li>
       </ol>
      </div>
      <div>
       <strong>æ­¥é©Ÿ 4ï¼šè²¼ä¸Šç¶²å€</strong>
       <p style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
        å°‡è¤‡è£½çš„ç¶²å€è²¼åˆ°ã€ŒGoogle Apps Script ç¶²å€ã€æ¬„ä½ï¼Œé»æ“Šã€Œå„²å­˜ä¸¦æ¸¬è©¦é€£æ¥ã€
       </p>
      </div>
     </div>
    </div>
   `;
   document.body.appendChild(modal);
   document.getElementById('scriptCodePre').textContent = scriptCode;
   window.currentScriptCode = scriptCode;
  }
  function copyScriptCode() {
   if (window.currentScriptCode) {
    navigator.clipboard.writeText(window.currentScriptCode);
    showToast('å·²è¤‡è£½ä»£ç¢¼');
   }
  }
  async function showCloudSettings() {
   document.getElementById('dropdownMenu').classList.remove('show');
   document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
   document.getElementById('cloudPage').classList.add('active');
   document.getElementById('fab').style.display = 'none';
   document.getElementById('homeBtn').style.display = 'flex';
   setSheetSyncStatus('', '');
   try {
    const url = await loadAppsScriptUrl();
    const input = document.getElementById('appsScriptUrl');
    if (input) input.value = url || '';
    updateSyncModeIndicator(!!url);
    const time = await loadLastSyncTime();
    updateLastSyncDisplay(time);
    const enabled = await loadAutoSyncSetting();
    autoSyncEnabled = enabled;
    const checkbox = document.getElementById('autoSyncCheckbox');
    if (checkbox) checkbox.checked = enabled;
   } catch (err) {
       }
  }
  async function autoSyncOnLoad() {
   _syncLock = true;
   try {
    const url = await loadAppsScriptUrl();
    if (url) {
     try {
      const response = await fetch(url);
      if (response.ok) {
       const result = await response.json();
       if (result.success && result.data?.foods?.length > 0) {
        var cloudCount = result.data.foods.length;
        var localCount = foods.length;
        if (cloudCount < localCount * 0.5) {
         console.log('Auto-sync skipped: cloud has ' + cloudCount + ' items vs local ' + localCount + ', keeping local data');
        } else {
         foods = result.data.foods;
         if (result.data.categories) categories = result.data.categories;
         if (result.data.categoryEmojis) {
          Object.keys(categoryEmojis).forEach(k => delete categoryEmojis[k]);
          Object.assign(categoryEmojis, result.data.categoryEmojis);
         }
         renderCategories();
         renderCategoryPills();
         renderFoodList();
         updateStats();
         await saveToIndexedDB();
         await saveLastSyncTime();
         console.log('Auto-synced from cloud:', foods.length, 'items');
        }
        if (result.data.savedDocs && Array.isArray(result.data.savedDocs)) {
         savedDocs = result.data.savedDocs;
         await saveDocs();
        }
       }
      }
     } catch (err) {
      console.log('Auto-sync skipped:', err.message);
     }
    }
    autoSyncEnabled = await loadAutoSyncSetting();
   } finally {
    _syncLock = false;
   }
  }
  const originalSaveToIndexedDB = saveToIndexedDB;
  saveToIndexedDB = async function() {
   await originalSaveToIndexedDB();
   clearTimeout(window.autoUploadTimeout);
   window.autoUploadTimeout = setTimeout(autoUploadIfEnabled, 2000);
  };

  /* ===== Document / Folder Feature ===== */
  let savedDocs = [];
  let docSelectedFoodIds = [];
  let docMode = 'per100g';
  let editingDocId = null;
  let viewingDocId = null;
  const NUT_META = {
   calories: {label:'å¡è·¯é‡Œ', unit:'kcal', color:'var(--cal-color)'},
   protein: {label:'è›‹ç™½è³ª', unit:'g', color:'var(--protein-color)'},
   fat: {label:'è„‚è‚ª', unit:'g', color:'var(--fat-color)'},
   carbs: {label:'ç¢³æ°´', unit:'g', color:'var(--carbs-color)'},
   sodium: {label:'éˆ‰', unit:'mg', color:'var(--sodium-color)'},
   calcium: {label:'éˆ£', unit:'mg', color:'var(--calcium-color)'}
  };

  async function loadDocs() {
   if (!db) { savedDocs = memorySettings.docs || []; return; }
   try {
    var tx = db.transaction(['settings'],'readonly');
    var r = await _P(tx.objectStore('settings').get('savedDocs')).catch(function(){return null;});
    if (r && r.value) savedDocs = r.value;
   } catch(e) { savedDocs = []; }
  }
  async function saveDocs() {
   if (!db) { memorySettings.docs = savedDocs; return; }
   try {
    var tx = db.transaction(['settings'],'readwrite');
    tx.objectStore('settings').put({key:'savedDocs', value:JSON.parse(JSON.stringify(savedDocs))});
   } catch(e) {}
   if (typeof autoUploadIfEnabled === 'function') {
    clearTimeout(window.autoUploadTimeout);
    window.autoUploadTimeout = setTimeout(autoUploadIfEnabled, 2000);
   }
  }

  function showDocumentsPage() {
   document.getElementById('dropdownMenu').classList.remove('show');
   document.querySelectorAll('.page').forEach(function(p){p.classList.remove('active');});
   document.getElementById('docsPage').classList.add('active');
   document.getElementById('fab').style.display = 'none';
   document.getElementById('homeBtn').style.display = 'flex';
   renderDocList();
  }
  function renderDocList() {
   var c = document.getElementById('docList');
   if (!savedDocs.length) {
    c.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><h3>æœªæœ‰æ–‡ä»¶</h3><p>å»ºç«‹æ¯”è¼ƒæ–‡ä»¶ï¼Œå°‡ä¸åŒé£Ÿç‰©çš„ç‡Ÿé¤Šä¸¦æ’æ¯”è¼ƒ</p></div>';
    return;
   }
   c.innerHTML = savedDocs.map(function(doc){
    var nutLabels = (doc.nutrients||[]).map(function(k){return NUT_META[k]?NUT_META[k].label:k;});
    var foodNames = (doc.foodIds||[]).map(function(id){var f=foods.find(function(x){return x.id===id;});return f?f.name:'?';});
    var dateStr = doc.createdAt ? new Date(doc.createdAt).toLocaleDateString('zh-HK') : '';
    return '<div class="doc-card" onclick="viewDocument(\''+doc.id+'\')">' +
     '<div class="doc-card-top"><div class="doc-card-title"><i class="fas fa-file-alt"></i>'+_esc(doc.name)+'</div></div>' +
     '<div class="doc-card-meta"><i class="fas fa-calendar"></i> '+dateStr+' Â· <i class="fas fa-utensils"></i> '+doc.foodIds.length+'é … Â· '+(doc.mode==='per100g'?'æ¯100g':'æ¯ä»½')+'</div>' +
     '<div class="doc-card-tags">' +
      foodNames.slice(0,4).map(function(n){return '<span class="doc-card-tag food">'+_esc(n)+'</span>';}).join('') +
      (foodNames.length>4?'<span class="doc-card-tag">+' + (foodNames.length-4) + '</span>':'') +
      nutLabels.map(function(n){return '<span class="doc-card-tag nut">'+n+'</span>';}).join('') +
     '</div>' +
     (doc.notes?'<div style="margin-top:6px;font-size:12px;color:var(--text-muted);">ğŸ“ '+_esc(doc.notes)+'</div>':'') +
    '</div>';
   }).join('');
  }
  function _esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML;}

  /* Create / Edit Document Modal */
  function openCreateDocModal() {
   editingDocId = null;
   docSelectedFoodIds = [];
   docMode = 'per100g';
   document.getElementById('docNameInput').value = '';
   document.getElementById('docNotesInput').value = '';
   document.getElementById('docFoodSearch').value = '';
   document.getElementById('docModePer100g').classList.add('active');
   document.getElementById('docModePerServing').classList.remove('active');
   // Reset nutrient checkboxes
   document.querySelectorAll('#nutPicker input').forEach(function(cb){
    var def = ['calories','protein','fat','carbs'].indexOf(cb.value) >= 0;
    cb.checked = def;
    cb.parentElement.classList.toggle('checked', def);
   });
   renderDocFoodPicker();
   renderDocSelectedChips();
   document.getElementById('createDocModal').classList.add('active');
  }
  function closeCreateDocModal() {
   document.getElementById('createDocModal').classList.remove('active');
  }
  function setDocMode(m) {
   docMode = m;
   document.getElementById('docModePer100g').classList.toggle('active', m==='per100g');
   document.getElementById('docModePerServing').classList.toggle('active', m==='perServing');
  }
  function toggleNutPick(cb) {
   cb.parentElement.classList.toggle('checked', cb.checked);
  }

  function renderDocFoodPicker() {
   var search = (document.getElementById('docFoodSearch').value || '').toLowerCase();
   var list = foods.filter(function(f){
    if (!search) return true;
    return f.name.toLowerCase().indexOf(search)>=0 || (f.nameEn||'').toLowerCase().indexOf(search)>=0;
   });
   var c = document.getElementById('docFoodPicker');
   c.innerHTML = list.slice(0, 100).map(function(f){
    var sel = docSelectedFoodIds.indexOf(f.id) >= 0;
    var emoji = categoryEmojis[f.category] || '';
    return '<div class="food-picker-item'+(sel?' selected':'')+'" onclick="toggleDocFood(\''+f.id+'\')">' +
     '<input type="checkbox" '+(sel?'checked':'')+' tabindex="-1">' +
     '<span class="food-picker-item-name">'+(emoji?emoji+' ':'')+_esc(f.name)+'</span>' +
     '<span class="food-picker-item-cat">'+_esc(f.category)+'</span>' +
    '</div>';
   }).join('');
   if (list.length > 100) c.innerHTML += '<div style="padding:10px;text-align:center;color:var(--text-muted);font-size:12px;">é¡¯ç¤ºå‰100é …ï¼Œè«‹ç”¨æœå°‹ç¸®çª„ç¯„åœ</div>';
  }
  function filterDocFoodList() { renderDocFoodPicker(); }
  function toggleDocFood(id) {
   var idx = docSelectedFoodIds.indexOf(id);
   if (idx >= 0) docSelectedFoodIds.splice(idx, 1);
   else docSelectedFoodIds.push(id);
   renderDocFoodPicker();
   renderDocSelectedChips();
  }
  function renderDocSelectedChips() {
   var c = document.getElementById('docSelectedFoods');
   if (!docSelectedFoodIds.length) { c.innerHTML = '<span style="color:var(--text-muted);font-size:13px;">å°šæœªé¸æ“‡é£Ÿç‰©</span>'; return; }
   c.innerHTML = docSelectedFoodIds.map(function(id){
    var f = foods.find(function(x){return x.id===id;});
    var name = f ? f.name : '?';
    return '<span class="doc-selected-chip">'+_esc(name)+' <button onclick="event.stopPropagation();toggleDocFood(\''+id+'\')">&times;</button></span>';
   }).join('');
  }

  function saveDocument() {
   var name = document.getElementById('docNameInput').value.trim();
   if (!name) { showToast('è«‹è¼¸å…¥æ–‡ä»¶åç¨±'); return; }
   if (!docSelectedFoodIds.length) { showToast('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é£Ÿç‰©'); return; }
   var nutrients = [];
   document.querySelectorAll('#nutPicker input:checked').forEach(function(cb){ nutrients.push(cb.value); });
   if (!nutrients.length) { showToast('è«‹è‡³å°‘é¸æ“‡ä¸€é …ç‡Ÿé¤Šç´ '); return; }
   var notes = document.getElementById('docNotesInput').value.trim();
   if (editingDocId) {
    var doc = savedDocs.find(function(d){return d.id===editingDocId;});
    if (doc) {
     doc.name = name;
     doc.foodIds = docSelectedFoodIds.slice();
     doc.nutrients = nutrients;
     doc.mode = docMode;
     doc.notes = notes;
     doc.updatedAt = Date.now();
    }
   } else {
    savedDocs.unshift({
     id: 'doc_' + Date.now(),
     name: name,
     foodIds: docSelectedFoodIds.slice(),
     nutrients: nutrients,
     mode: docMode,
     notes: notes,
     createdAt: Date.now()
    });
   }
   saveDocs();
   closeCreateDocModal();
   renderDocList();
   showToast(editingDocId ? 'æ–‡ä»¶å·²æ›´æ–°' : 'æ–‡ä»¶å·²å»ºç«‹');
  }

  /* View Document */
  function viewDocument(docId) {
   var doc = savedDocs.find(function(d){return d.id===docId;});
   if (!doc) return;
   viewingDocId = docId;
   document.getElementById('viewDocTitle').innerHTML = '<i class="fas fa-file-alt" style="color:#3b82f6;"></i> ' + _esc(doc.name);
   var dateStr = doc.createdAt ? new Date(doc.createdAt).toLocaleDateString('zh-HK',{year:'numeric',month:'long',day:'numeric'}) : '';
   var modeStr = doc.mode === 'per100g' ? 'æ¯ 100g' : 'æ¯é£Ÿç”¨ä»½é‡';
   document.getElementById('viewDocMeta').innerHTML =
    '<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;color:var(--text-secondary);font-size:13px;">' +
    (dateStr ? '<span><i class="fas fa-calendar"></i> ' + dateStr + '</span>' : '') +
    '<span><i class="fas fa-balance-scale"></i> ' + modeStr + '</span>' +
    '<span><i class="fas fa-utensils"></i> ' + doc.foodIds.length + ' é …é£Ÿç‰©</span>' +
    '</div>' +
    (doc.notes ? '<div style="margin-top:8px;font-size:13px;color:var(--text-muted);"><i class="fas fa-sticky-note"></i> ' + _esc(doc.notes) + '</div>' : '');

   // Build comparison table
   var nuts = doc.nutrients || [];
   var foodList = doc.foodIds.map(function(id){ return foods.find(function(x){return x.id===id;}); }).filter(Boolean);
   var html = '<table class="doc-view-table"><thead><tr><th>é£Ÿç‰©</th>';
   nuts.forEach(function(k){
    var m = NUT_META[k];
    html += '<th>' + (m?m.label:k) + '<br><span style="font-weight:400;font-size:10px;opacity:0.8;">(' + (m?m.unit:'') + ')</span></th>';
   });
   html += '</tr></thead><tbody>';
   var totals = {};
   nuts.forEach(function(k){ totals[k] = 0; });
   foodList.forEach(function(f){
    var data = doc.mode === 'per100g' ? (f.per100g||{}) : null;
    if (doc.mode === 'perServing') {
     var ps = f.perServing;
     var p100 = f.per100g;
     if (ps && ps.weight && p100) {
      data = {};
      var w = ps.weight;
      nuts.forEach(function(k){
       if (p100[k] !== null && p100[k] !== undefined) { data[k] = Math.round(p100[k]*w/100*10)/10; }
       else { data[k] = null; }
      });
      data._weight = w;
     } else if (ps) { data = ps; }
     else { data = p100 || {}; }
    }
    if (!data) data = {};
    var emoji = categoryEmojis[f.category] || '';
    html += '<tr><td>' + (emoji?emoji+' ':'') + _esc(f.name);
    if (doc.mode==='perServing' && data._weight) html += '<br><span style="font-size:10px;color:var(--text-muted);">' + data._weight + 'g</span>';
    html += '</td>';
    nuts.forEach(function(k){
     var v = data[k];
     var display = (v !== null && v !== undefined) ? (k==='calories'||k==='sodium'||k==='calcium'? Math.round(v) : Math.round(v*10)/10) : '--';
     if (typeof display === 'number') totals[k] += display;
     var m = NUT_META[k];
     html += '<td style="color:'+(m?m.color:'inherit')+';font-weight:600;">'+display+'</td>';
    });
    html += '</tr>';
   });
   // Total / average row
   if (foodList.length > 1) {
    html += '<tr class="doc-total-row"><td>åˆè¨ˆ</td>';
    nuts.forEach(function(k){
     var v = totals[k];
     var display = k==='calories'||k==='sodium'||k==='calcium' ? Math.round(v) : Math.round(v*10)/10;
     html += '<td>'+display+'</td>';
    });
    html += '</tr>';
    html += '<tr class="doc-total-row" style="opacity:0.7;"><td>å¹³å‡</td>';
    nuts.forEach(function(k){
     var v = totals[k] / foodList.length;
     var display = k==='calories'||k==='sodium'||k==='calcium' ? Math.round(v) : Math.round(v*10)/10;
     html += '<td>'+display+'</td>';
    });
    html += '</tr>';
   }
   html += '</tbody></table>';
   document.getElementById('viewDocTableWrap').innerHTML = html;
   document.getElementById('viewDocModal').classList.add('active');
  }
  function closeViewDocModal() {
   document.getElementById('viewDocModal').classList.remove('active');
   viewingDocId = null;
  }
  function editCurrentDoc() {
   var doc = savedDocs.find(function(d){return d.id===viewingDocId;});
   if (!doc) return;
   closeViewDocModal();
   editingDocId = doc.id;
   docSelectedFoodIds = doc.foodIds.slice();
   docMode = doc.mode || 'per100g';
   document.getElementById('docNameInput').value = doc.name;
   document.getElementById('docNotesInput').value = doc.notes || '';
   document.getElementById('docFoodSearch').value = '';
   document.getElementById('docModePer100g').classList.toggle('active', docMode==='per100g');
   document.getElementById('docModePerServing').classList.toggle('active', docMode==='perServing');
   document.querySelectorAll('#nutPicker input').forEach(function(cb){
    var on = (doc.nutrients||[]).indexOf(cb.value) >= 0;
    cb.checked = on;
    cb.parentElement.classList.toggle('checked', on);
   });
   renderDocFoodPicker();
   renderDocSelectedChips();
   document.getElementById('createDocModal').classList.add('active');
  }
  function deleteCurrentDoc() {
   var doc = savedDocs.find(function(d){return d.id===viewingDocId;});
   if (!doc) return;
   // Show confirm
   var overlay = document.getElementById('confirmModal');
   document.getElementById('confirmTitle').textContent = 'ç¢ºèªåˆªé™¤ï¼Ÿ';
   document.getElementById('confirmMessage').textContent = 'ç¢ºå®šè¦åˆªé™¤ã€Œ' + doc.name + 'ã€ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚';
   var btn = document.getElementById('confirmAction');
   btn.onclick = function(){
    savedDocs = savedDocs.filter(function(d){return d.id!==viewingDocId;});
    saveDocs();
    closeConfirmModal();
    closeViewDocModal();
    renderDocList();
    showToast('æ–‡ä»¶å·²åˆªé™¤');
   };
   overlay.classList.add('active');
  }

</script>
</body>
</html>