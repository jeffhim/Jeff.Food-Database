<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ç‡Ÿé¤Šè³‡æ–™åº«</title>

  <!-- PWA Meta Tags -->
  <meta name="application-name" content="ç‡Ÿé¤Šè³‡æ–™åº«" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ç‡Ÿé¤Šè³‡æ–™åº«" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#166534" />
  <meta name="description" content="å€‹äººç‡Ÿé¤Šè³‡æ–™åº« - è¨˜éŒ„å’Œç®¡ç†é£Ÿç‰©ç‡Ÿé¤Šè³‡è¨Š" />

  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="manifest" href="manifest.json" />

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <style>
    :root{
      --bg-primary:#f0f2f5;--bg-secondary:#fff;--bg-card:#fff;--text-primary:#1a1a2e;--text-secondary:#6b7280;--text-muted:#9ca3af;
      --accent:#22c55e;--accent-dark:#16a34a;--header-gradient:linear-gradient(135deg,#166534 0%,#15803d 50%,#22c55e 100%);
      --divider:rgba(0,0,0,.06);--card-shadow:0 2px 8px rgba(0,0,0,.06);--pill-bg:#e5e7eb;--pill-active:#22c55e;--search-bg:rgba(255,255,255,.15);
      --cal-color:#a855f7;--protein-color:#eab308;--fat-color:#f97316;--carbs-color:#06b6d4;--sodium-color:#ec4899;--calcium-color:#22c55e;
    }
    .dark{
      --bg-primary:#0f0f1a;--bg-secondary:#1a1a2e;--bg-card:#252542;--text-primary:#fff;--text-secondary:#9ca3af;--text-muted:#6b7280;
      --divider:rgba(255,255,255,.08);--card-shadow:0 4px 12px rgba(0,0,0,.3);--pill-bg:#374151;--search-bg:rgba(255,255,255,.1);
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html{height:100%}
    body{
      font-family:'Noto Sans HK',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary);
      min-height:100%;min-height:100dvh;overflow-x:hidden;
      padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    @media all and (display-mode:standalone){
      .header{padding-top:calc(16px + env(safe-area-inset-top))}
      .fab{bottom:calc(30px + env(safe-area-inset-bottom))}
      .modal{padding-bottom:env(safe-area-inset-bottom)}
    }
    .header{background:var(--header-gradient);padding:16px 20px 20px;position:sticky;top:0;z-index:100}
    .header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .header-left{display:flex;align-items:center;gap:12px}
    .header-icon{width:44px;height:44px;background:rgba(255,255,255,.2);border-radius:12px;display:flex;align-items:center;justify-content:center}
    .header-icon i{font-size:22px;color:#fff}
    .header-title{font-size:20px;font-weight:700;color:#fff}
    .header-subtitle{font-size:12px;color:rgba(255,255,255,.8);font-weight:400}
    .header-actions{display:flex;gap:8px}
    .header-btn{width:40px;height:40px;background:rgba(255,255,255,.2);border:0;border-radius:10px;color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s}
    .header-btn:hover{background:rgba(255,255,255,.3)}
    .search-bar{display:flex;align-items:center;background:var(--search-bg);border-radius:12px;padding:12px 16px;gap:10px;backdrop-filter:blur(10px)}
    .search-bar i{color:rgba(255,255,255,.7);font-size:16px}
    .search-bar input{flex:1;border:0;background:transparent;font-size:16px;color:#fff;outline:0;font-family:inherit}
    .search-bar input::placeholder{color:rgba(255,255,255,.6)}
    .main-content{padding:16px;padding-bottom:120px}
    .category-pills{display:flex;gap:10px;overflow-x:auto;padding:4px 0 20px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
    .category-pills::-webkit-scrollbar{display:none}
    .category-pill{flex-shrink:0;padding:10px 18px;border-radius:25px;background:var(--pill-bg);color:var(--text-secondary);font-size:14px;font-weight:500;border:0;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
    .category-pill.active{background:var(--pill-active);color:#fff}
    .category-pill:hover{transform:scale(1.02)}
    .category-pill .emoji{font-size:16px}
    .food-list{display:flex;flex-direction:column;gap:16px}
    .food-card{background:var(--bg-card);border-radius:20px;padding:20px;box-shadow:var(--card-shadow);animation:slideIn .2s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .food-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
    .food-name{font-size:20px;font-weight:700;color:var(--text-primary);margin-bottom:8px}
    .food-meta{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .food-category-tag{display:inline-flex;align-items:center;gap:5px;background:rgba(234,179,8,.15);color:#ca8a04;padding:6px 12px;border-radius:20px;font-size:13px;font-weight:500}
    .dark .food-category-tag{background:rgba(234,179,8,.2);color:#fbbf24}
    .food-card-actions{display:flex;gap:8px}
    .action-icon-btn{width:36px;height:36px;border:0;background:transparent;color:var(--text-muted);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all .2s}
    .action-icon-btn:hover{background:var(--bg-primary);color:var(--text-secondary)}
    .action-icon-btn.delete:hover{color:#ef4444}
    .nutrition-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px;cursor:pointer;transition:transform .15s ease}
    .nutrition-grid:active{transform:scale(.98)}
    .nutrition-mode-tag{display:inline-flex;align-items:center;gap:5px;color:var(--text-secondary);font-size:13px;background:rgba(34,197,94,.15);padding:4px 10px;border-radius:12px}
    .dark .nutrition-mode-tag{background:rgba(34,197,94,.2)}
    .nutrition-mode-tag i{font-size:11px;color:var(--accent)}
    .nutrition-mode-tag.per100g{background:rgba(168,85,247,.15)}
    .dark .nutrition-mode-tag.per100g{background:rgba(168,85,247,.2)}
    .nutrition-mode-tag.per100g i{color:var(--cal-color)}
    .nutrition-mode-tag.perserving{background:rgba(59,130,246,.15)}
    .dark .nutrition-mode-tag.perserving{background:rgba(59,130,246,.2)}
    .nutrition-mode-tag.perserving i{color:#3b82f6}
    .nutrition-box{background:var(--bg-primary);border-radius:12px;padding:12px 16px;min-width:70px;text-align:center}
    .nutrition-value{font-size:18px;font-weight:700;margin-bottom:2px}
    .nutrition-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:.3px}
    .nutrition-box.cal .nutrition-value{color:var(--cal-color)}
    .nutrition-box.protein .nutrition-value{color:var(--protein-color)}
    .nutrition-box.fat .nutrition-value{color:var(--fat-color)}
    .nutrition-box.carbs .nutrition-value{color:var(--carbs-color)}
    .nutrition-box.sodium .nutrition-value{color:var(--sodium-color)}
    .nutrition-box.calcium .nutrition-value{color:var(--calcium-color)}
    .food-footer{margin-top:16px;padding-top:12px;border-top:1px solid var(--divider);display:flex;align-items:center;gap:8px;color:var(--text-muted);font-size:12px}
    .fab{position:fixed;bottom:30px;right:20px;width:60px;height:60px;border-radius:50%;background:var(--accent);color:#fff;border:0;box-shadow:0 6px 20px rgba(34,197,94,.4);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:26px;z-index:99;transition:all .2s ease}
    .fab:hover{transform:scale(1.08);box-shadow:0 8px 25px rgba(34,197,94,.5)}
    .fab:active{transform:scale(.95)}
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;animation:fadeIn .2s ease}
    .modal-overlay.active{display:flex;align-items:flex-end;justify-content:center}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal{background:var(--bg-secondary);border-radius:24px 24px 0 0;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;animation:slideUp .25s ease}
    @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--divider);position:sticky;top:0;background:var(--bg-secondary);z-index:10}
    .modal-title{font-size:18px;font-weight:700}
    .modal-close{background:var(--bg-primary);border:0;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary);font-size:14px}
    .modal-body{padding:24px}
    .form-group{margin-bottom:18px}
    .form-label{display:block;font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:8px}
    .form-input,.form-select,textarea.form-input{width:100%;padding:14px 16px;border:2px solid var(--divider);border-radius:14px;font-size:16px;background:var(--bg-primary);color:var(--text-primary);outline:0;font-family:inherit;transition:border-color .2s}
    .form-input:focus,.form-select:focus,textarea.form-input:focus{border-color:var(--accent)}
    .form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form-section-title{font-size:14px;font-weight:700;color:var(--text-primary);margin:24px 0 14px;padding-bottom:10px;border-bottom:2px solid var(--divider)}
    .input-mode-toggle{display:flex;gap:0;background:var(--bg-primary);border-radius:12px;padding:4px;margin-bottom:16px}
    .input-mode-btn{flex:1;padding:12px 16px;border:0;background:transparent;color:var(--text-secondary);font-size:14px;font-weight:600;cursor:pointer;border-radius:10px;transition:all .2s;font-family:inherit}
    .input-mode-btn.active{background:var(--accent);color:#fff}
    .scan-label-btn{display:flex;align-items:center;justify-content:center;gap:10px;width:100%;padding:14px 16px;background:linear-gradient(135deg,#8b5cf6 0%,#a855f7 100%);color:#fff;border:0;border-radius:14px;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:20px;transition:all .2s;font-family:inherit}
    .scan-label-btn:active{transform:scale(.98)}
    .scan-label-btn.scanning{pointer-events:none}
    .scan-label-btn.scanning i{animation:spin 1s linear infinite}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .scan-preview{display:none;margin-bottom:16px;border-radius:12px;overflow:hidden;position:relative}
    .scan-preview.show{display:block}
    .scan-preview img{width:100%;max-height:220px;object-fit:cover;display:block}
    .scan-preview-remove{position:absolute;top:8px;right:8px;width:28px;height:28px;background:rgba(0,0,0,.6);color:#fff;border:0;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px}
    .scan-status{display:none;text-align:center;padding:12px;background:var(--bg-primary);border-radius:10px;margin-bottom:16px;font-size:14px;color:var(--text-secondary)}
    .scan-status.show{display:block}
    .scan-status.success{background:rgba(34,197,94,.15);color:var(--accent)}
    .scan-status.error{background:rgba(239,68,68,.15);color:#ef4444}
    .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--text-primary);color:var(--bg-primary);padding:14px 28px;border-radius:12px;font-size:14px;font-weight:600;z-index:400;transition:transform .3s ease;box-shadow:0 8px 30px rgba(0,0,0,.3)}
    .toast.show{transform:translateX(-50%) translateY(0)}
    .page{display:none}
    .page.active{display:block}

    /* Dropdown */
    .header-menu-container{position:relative}
    .dropdown-menu{display:none;position:absolute;top:100%;right:0;background:var(--bg-card);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.2);min-width:200px;z-index:150;overflow:hidden;margin-top:8px}
    .dropdown-menu.show{display:block}
    .dropdown-item{display:flex;align-items:center;gap:12px;padding:14px 16px;color:var(--text-primary);font-size:15px;cursor:pointer;transition:background .2s;border:0;background:none;width:100%;text-align:left;font-family:inherit}
    .dropdown-item:hover{background:var(--bg-primary)}
    .dropdown-item i{width:20px;color:var(--text-secondary)}
    .dropdown-item.danger{color:#ef4444}
    .dropdown-item.danger i{color:#ef4444}

    /* Compare & Docs UI */
    .panel{background:var(--bg-card);border-radius:16px;padding:16px;box-shadow:var(--card-shadow);margin-bottom:16px}
    .btn{border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer;font-family:inherit}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.secondary{background:var(--bg-primary);color:var(--text-primary)}
    .btn.danger{background:#ef4444;color:#fff}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap}
    .small{font-size:12px;color:var(--text-secondary);line-height:1.5}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;background:var(--bg-primary);border:1px solid var(--divider);font-size:13px;cursor:pointer}
    .chip.active{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.35)}
    .list{display:flex;flex-direction:column;gap:10px}
    .list-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:14px;background:var(--bg-secondary);border:1px solid var(--divider)}
    .list-item-title{font-weight:700}
    .list-item-sub{font-size:12px;color:var(--text-secondary)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--divider);padding:8px 6px;font-size:13px;text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.04em}
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>

  <!-- ä½ è²¼å‡ºåšŸå˜… index.html å…§å®¹å¤ªé•·ï¼Œ
       æˆ‘å·²ç¶“é–‹å§‹æä¾›ï¼Œä½†ç‚ºå…å–ºèŠå¤©ä»‹é¢è¢«æˆªæ–·ï¼š
       è«‹ä½ å›è¦†ã€Œç¹¼çºŒã€æˆ‘æœƒåˆ†æ®µè²¼å®Œæ•´å‰©é¤˜éƒ¨åˆ†ï¼ˆå…¨éƒ¨åŸæ¨£ï¼Œä¸æœƒæ¼ï¼‰ã€‚
  -->
  <div class="toast" id="toast"></div>

  <header class="header">
    <div class="header-top">
      <div class="header-left">
        <div class="header-icon"><i class="fas fa-seedling"></i></div>
        <div>
          <div class="header-title">ç‡Ÿé¤Šè³‡æ–™åº«</div>
          <div class="header-subtitle">Nutrition Database</div>
        </div>
      </div>

      <div class="header-actions">
        <button class="header-btn" onclick="goToHomePage()" title="è¿”å›ä¸»é " id="homeBtn" style="display:none">
          <i class="fas fa-home"></i>
        </button>

        <button class="header-btn" onclick="openCompareModal()" title="æ¯”è¼ƒ / æ–‡ä»¶">
          <i class="fas fa-scale-balanced"></i>
        </button>

        <button class="header-btn" onclick="exportData()" title="åŒ¯å‡ºè³‡æ–™">
          <i class="fas fa-share-alt"></i>
        </button>

        <div class="header-menu-container">
          <button class="header-btn" onclick="toggleMenu(event)" title="æ›´å¤šé¸é …"><i class="fas fa-bars"></i></button>
          <div class="dropdown-menu" id="dropdownMenu">
            <button class="dropdown-item" onclick="showAIImport()"><i class="fas fa-robot"></i><span>AIæ‰¹é‡åŒ¯å…¥</span></button>
            <button class="dropdown-item" onclick="showCloudSettings()"><i class="fas fa-cloud"></i><span>é›²ç«¯åŒæ­¥è¨­å®š</span></button>
            <button class="dropdown-item danger" onclick="confirmClearData()"><i class="fas fa-trash"></i><span>æ¸…é™¤æ‰€æœ‰è³‡æ–™</span></button>
          </div>
        </div>
      </div>
    </div>

    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" id="searchInput" placeholder="æœå°‹é£Ÿç‰©æˆ–é£²å“..." />
    </div>
  </header>

  <main class="main-content">
    <div class="page active" id="homePage">
      <div class="category-pills" id="categoryPills"></div>
      <div class="food-list" id="foodList"></div>
    </div>

    <div class="page" id="cloudPage">
      <div class="panel">
        <div style="font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:10px;">
          <i class="fas fa-cloud" style="color:var(--accent)"></i> Google é›²ç«¯åŒæ­¥
        </div>

        <div id="sheetSyncStatus" class="small" style="display:none"></div>

        <div class="panel" style="box-shadow:none;background:var(--bg-secondary);border:1px solid var(--divider)">
          <div class="small"><i class="fas fa-clock"></i> ä¸Šæ¬¡åŒæ­¥ï¼š<span id="lastSyncTime">å¾æœª</span></div>
          <div class="small" id="syncModeIndicator" style="margin-top:6px;"><i class="fas fa-info-circle"></i> å°šæœªè¨­å®šé›²ç«¯åŒæ­¥</div>
        </div>

        <div class="btn-row">
          <button class="btn primary" style="flex:1" onclick="syncFromCloud()" id="cloudDownloadBtn"><i class="fas fa-cloud-download-alt"></i> ä¸‹è¼‰</button>
          <button class="btn primary" style="flex:1;background:#34a853" onclick="syncToCloud()" id="cloudUploadBtn"><i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³</button>
        </div>

        <div class="form-section-title"><i class="fas fa-cog"></i> Google Apps Script è¨­å®š</div>
        <div class="form-group">
          <label class="form-label">Google Apps Script ç¶²å€</label>
          <input type="text" class="form-input" id="appsScriptUrl" placeholder="https://script.google.com/macros/s/.../exec" />
        </div>

        <div class="btn-row">
          <button class="btn primary" style="flex:1;background:#34a853" onclick="saveAppsScriptUrl()"><i class="fas fa-save"></i> å„²å­˜ä¸¦æ¸¬è©¦é€£æ¥</button>
          <button class="btn secondary" style="flex:1" onclick="showAppsScriptSetup()"><i class="fas fa-book"></i> æ•™å­¸</button>
        </div>

        <div style="margin-top:12px">
          <label style="display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text-secondary);cursor:pointer;">
            <input type="checkbox" id="autoSyncCheckbox" onchange="toggleAutoSync()" style="width:18px;height:18px;" />
            è‡ªå‹•åŒæ­¥ï¼ˆæ¯æ¬¡ä¿®æ”¹å¾Œè‡ªå‹•ä¸Šå‚³ï¼‰
          </label>
        </div>
      </div>

      <button class="btn primary" style="width:100%" onclick="backToHome()"><i class="fas fa-arrow-left"></i> è¿”å›ä¸»é </button>
    </div>
  </main>

  <button class="fab" id="fab" onclick="openAddModal()"><i class="fas fa-plus"></i></button>

  <!-- Add/Edit Modal -->
  <div class="modal-overlay" id="addModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title" id="modalTitle">æ–°å¢é£Ÿç‰©</span>
        <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <form id="foodForm">
          <input type="hidden" id="editId" />

          <button type="button" class="scan-label-btn" id="scanLabelBtn" onclick="document.getElementById('labelImageInput').click()">
            <i class="fas fa-camera"></i><span>æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤</span>
          </button>
          <input type="file" id="labelImageInput" accept="image/*" style="display:none" onchange="handleLabelImage(event)" />

          <div class="scan-preview" id="scanPreview">
            <img id="scanPreviewImg" src="" alt="Preview" />
            <button type="button" class="scan-preview-remove" onclick="clearScanPreview()"><i class="fas fa-times"></i></button>
          </div>
          <div class="scan-status" id="scanStatus"></div>

          <div class="form-group">
            <label class="form-label">ä¸­æ–‡åç¨±</label>
            <input type="text" class="form-input" id="foodName" required />
          </div>
          <div class="form-group">
            <label class="form-label">è‹±æ–‡åç¨± (é¸å¡«)</label>
            <input type="text" class="form-input" id="foodNameEn" />
          </div>
          <div class="form-group">
            <label class="form-label">åˆ†é¡</label>
            <select class="form-select" id="foodCategory" required onchange="toggleNewCategoryInput()"></select>
          </div>

          <div class="form-group" id="newCategoryGroup" style="display:none">
            <label class="form-label">æ–°åˆ†é¡åç¨±</label>
            <div style="display:flex;gap:8px;">
              <input type="text" class="form-input" id="newCategoryName" placeholder="è¼¸å…¥æ–°åˆ†é¡åç¨±" style="flex:1" />
              <input type="text" class="form-input" id="newCategoryEmoji" placeholder="Emoji" style="width:80px" />
            </div>
          </div>

          <div class="form-section-title">ç‡Ÿé¤Šè³‡æ–™è¼¸å…¥æ–¹å¼</div>
          <div class="input-mode-toggle">
            <button type="button" class="input-mode-btn active" id="inputModePer100g" onclick="setInputMode('per100g')">æ¯ 100g</button>
            <button type="button" class="input-mode-btn" id="inputModePerServing" onclick="setInputMode('perServing')">æ¯é£Ÿç”¨ä»½é‡</button>
          </div>

          <div class="form-group" id="servingWeightGroup">
            <label class="form-label" id="servingWeightLabel">æ¯ä»½é‡é‡ (g) <span style="color:var(--text-secondary);">- é¸å¡«</span></label>
            <input type="number" step="0.1" class="form-input" id="servingWeight" />
          </div>

          <div class="form-section-title" id="nutritionSectionTitle">ç‡Ÿé¤Šè³‡æ–™ (æ¯100g)</div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">å¡è·¯é‡Œ (kcal)</label><input type="number" step="0.1" class="form-input" id="caloriesServing" /></div>
            <div class="form-group"><label class="form-label">è›‹ç™½è³ª (g)</label><input type="number" step="0.1" class="form-input" id="proteinServing" /></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">è„‚è‚ª (g)</label><input type="number" step="0.1" class="form-input" id="fatServing" /></div>
            <div class="form-group"><label class="form-label">ç¢³æ°´åŒ–åˆç‰© (g)</label><input type="number" step="0.1" class="form-input" id="carbsServing" /></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">éˆ‰ (mg)</label><input type="number" step="0.1" class="form-input" id="sodiumServing" /></div>
            <div class="form-group"><label class="form-label">éˆ£ (mg)</label><input type="number" step="0.1" class="form-input" id="calciumServing" /></div>
          </div>

          <button type="submit" class="btn primary" style="width:100%" id="submitBtn">å„²å­˜</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Compare / Docs Modal -->
  <div class="modal-overlay" id="compareModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title"><i class="fas fa-scale-balanced"></i> æ¯”è¼ƒ / æ–‡ä»¶</span>
        <button class="modal-close" onclick="closeCompareModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <div class="panel">
          <div style="font-weight:800;margin-bottom:10px;">â‘  é¸æ“‡é£Ÿç‰©ï¼ˆæœ€å¤š 6 å€‹ï¼‰</div>
          <div class="small" style="margin-bottom:10px;">æç¤ºï¼šå¯ç”¨ä¸»é æœå°‹å…ˆç¸®ç´°ç¯„åœï¼›å‘¢åº¦æœƒæŒ‰ä½ è€Œå®¶ filter+search é¡¯ç¤ºã€‚</div>
          <div id="compareFoodPickList" class="list"></div>
        </div>

        <div class="panel">
          <div style="font-weight:800;margin-bottom:10px;">â‘¡ é¸æ“‡è¦æ¯”è¼ƒå˜…ç‡Ÿé¤Šç´ </div>
          <div id="nutrientChips" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
          <div class="small" style="margin-top:10px;">
            åŸºæº–ï¼š<span class="mono" id="compareBaseModeLabel">per100g</span>
            <button class="btn secondary" style="padding:8px 10px;margin-left:8px;" onclick="toggleCompareBaseMode()">åˆ‡æ›åŸºæº–</button>
          </div>
        </div>

        <div class="panel">
          <div style="font-weight:800;margin-bottom:10px;">â‘¢ ç”Ÿæˆæ¯”è¼ƒè¡¨</div>
          <div class="btn-row">
            <button class="btn primary" onclick="renderCompareTable()">ç”Ÿæˆæ¯”è¼ƒè¡¨</button>
            <button class="btn secondary" onclick="exportCompareCSV()">åŒ¯å‡ºæ¯”è¼ƒ CSV</button>
          </div>
          <div id="compareTableWrap" style="margin-top:12px;overflow:auto"></div>
        </div>

        <div class="panel">
          <div style="font-weight:800;margin-bottom:10px;">â‘£ å„²å­˜ç‚ºæ–‡ä»¶ï¼ˆå¯æ—¥å¾Œæ›´æ–°å¿«ç…§ï¼‰</div>
          <div class="form-group">
            <label class="form-label">æ–‡ä»¶åç¨±</label>
            <input class="form-input" id="docNameInput" placeholder="ä¾‹å¦‚ï¼šæ¸›è„‚æ—©é¤æ¯”è¼ƒ" />
          </div>
          <div class="form-group">
            <label class="form-label">æ–‡ä»¶å¤¾</label>
            <select class="form-select" id="folderSelect"></select>
          </div>
          <div class="btn-row">
            <button class="btn primary" onclick="saveDocFromCompare()">å„²å­˜æ–‡ä»¶</button>
            <button class="btn secondary" onclick="openDocsManager()">ç®¡ç†æ–‡ä»¶å¤¾/æ–‡ä»¶</button>
          </div>
        </div>

        <div id="docsManager" class="panel" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;">
            <div style="font-weight:800;">æ–‡ä»¶å¤¾ / æ–‡ä»¶</div>
            <button class="btn secondary" style="padding:8px 10px" onclick="closeDocsManager()">æ”¶èµ·</button>
          </div>

          <div class="form-group">
            <label class="form-label">æ–°å¢æ–‡ä»¶å¤¾</label>
            <div style="display:flex;gap:8px;">
              <input class="form-input" id="newFolderInput" placeholder="ä¾‹å¦‚ï¼šæ¸›è„‚" />
              <button class="btn primary" onclick="addFolder()">æ–°å¢</button>
            </div>
          </div>

          <div class="list" id="folderList"></div>

          <div style="margin-top:14px;border-top:1px solid var(--divider);padding-top:14px;">
            <div style="font-weight:800;margin-bottom:10px;">æ–‡ä»¶åˆ—è¡¨</div>
            <div class="list" id="docList"></div>
          </div>
        </div>

        <div id="docViewer" class="panel" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;">
            <div>
              <div style="font-weight:900" id="docViewerTitle">æ–‡ä»¶</div>
              <div class="small">åŸºæº–ï¼š<span class="mono" id="docViewerBaseMode"></span>ï½œç‡Ÿé¤Šç´ ï¼š<span class="mono" id="docViewerNutrients"></span></div>
              <div class="small">æ›´æ–°ï¼š<span class="mono" id="docViewerUpdatedAt"></span></div>
            </div>
            <button class="btn secondary" style="padding:8px 10px" onclick="closeDocViewer()">é—œé–‰</button>
          </div>
          <div class="btn-row" style="margin-bottom:10px;">
            <button class="btn primary" onclick="confirmRefreshDoc()">æ›´æ–°æ–‡ä»¶å¿«ç…§</button>
            <button class="btn secondary" onclick="exportDocCSV()">åŒ¯å‡º CSV</button>
            <button class="btn danger" onclick="confirmDeleteDoc()">åˆªé™¤æ–‡ä»¶</button>
          </div>
          <div id="docViewerTable" style="overflow:auto"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal" style="max-width:420px;border-radius:18px">
      <div class="modal-header">
        <span class="modal-title" id="confirmTitle">ç¢ºèªï¼Ÿ</span>
        <button class="modal-close" onclick="closeConfirmModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p id="confirmMessage" style="color:var(--text-secondary);margin-bottom:16px;line-height:1.5"></p>
        <div class="btn-row">
          <button class="btn secondary" style="flex:1" onclick="closeConfirmModal()">å–æ¶ˆ</button>
          <button class="btn danger" style="flex:1" id="confirmAction">ç¢ºèª</button>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Import Modal (minimal wrapper: keeps your functions; UI kept small) -->
  <div class="modal-overlay" id="aiImportModal">
    <div class="modal" style="max-width:520px">
      <div class="modal-header">
        <span class="modal-title"><i class="fas fa-robot"></i> AIæ‰¹é‡åŒ¯å…¥</span>
        <button class="modal-close" onclick="closeAIImportModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body">
        <p class="small" style="margin-bottom:12px;">ä½ å¯ä»¥ç”¨ Excel/CSV/PDF/åœ–ç‰‡/è²¼ä¸Šæ–‡å­—åŒ¯å…¥ã€‚GitHub Pages æœƒç”¨ OCR fallbackã€‚</p>

        <div class="form-group">
          <label class="form-label">é¸æ“‡åˆ†é¡</label>
          <select class="form-select" id="aiImportCategory"></select>
        </div>
        <div class="form-group">
          <label class="form-label">æˆ–è¼¸å…¥æ–°åˆ†é¡åç¨±</label>
          <div style="display:flex;gap:8px;">
            <input type="text" class="form-input" id="aiNewCategory" placeholder="ä¾‹å¦‚ï¼šæ—¥å¼æ–™ç†" />
            <input type="text" class="form-input" id="aiNewCategoryEmoji" placeholder="ğŸ±" style="width:70px;text-align:center" />
          </div>
        </div>

        <div class="btn-row">
          <button type="button" class="btn secondary" onclick="document.getElementById('aiImportExcelInput').click()">Excel/CSV</button>
          <button type="button" class="btn secondary" onclick="document.getElementById('aiImportPdfInput').click()">PDF</button>
          <button type="button" class="btn secondary" onclick="document.getElementById('aiImportImageInput').click()">åœ–ç‰‡</button>
          <button type="button" class="btn secondary" onclick="toggleTextImport()">è²¼ä¸Šæ–‡å­—</button>
        </div>

        <div id="textImportArea" style="display:none;margin-top:12px;">
          <textarea id="textImportInput" class="form-input" rows="8" placeholder="æ¯è¡Œï¼šé£Ÿç‰©å  å¡è·¯é‡Œ  è›‹ç™½  è„‚è‚ª  ç¢³æ°´  éˆ‰  éˆ£"></textarea>
        </div>

        <input type="file" id="aiImportExcelInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleExcelImport(event)" />
        <input type="file" id="aiImportPdfInput" accept=".pdf" style="display:none" onchange="handlePdfImport(event)" />
        <input type="file" id="aiImportImageInput" accept="image/*" style="display:none" onchange="handleAIImportImage(event)" />

        <div id="aiImportStatus" style="margin-top:12px;padding:12px;border-radius:12px;display:none"></div>
        <div id="aiImportResults" style="margin-top:12px;max-height:300px;overflow:auto;display:none">
          <div class="form-section-title">è­˜åˆ¥çµæœé è¦½</div>
          <div id="aiImportResultsList"></div>
        </div>

        <div class="btn-row" style="margin-top:12px;">
          <button type="button" class="btn primary" id="aiAnalyzeBtn" onclick="startAnalysis()" disabled>é–‹å§‹è­˜åˆ¥</button>
          <button type="button" class="btn primary" id="aiConfirmBtn" onclick="confirmAIImport()" style="display:none;background:#34a853">ç¢ºèªåŒ¯å…¥</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // ==================== DB ====================
    const DB_NAME='NutritionDB', DB_VERSION=2;
    let db=null, isIndexedDBAvailable=false;
    let memorySettings={};

    function openDatabase(){
      return new Promise((resolve)=>{
        if(!window.indexedDB){isIndexedDBAvailable=false;return resolve(null);}
        try{
          const req=indexedDB.open(DB_NAME,DB_VERSION);
          req.onerror=(e)=>{console.log('IndexedDB open error',e.target.error);isIndexedDBAvailable=false;resolve(null);}
          req.onsuccess=()=>{db=req.result;isIndexedDBAvailable=true;resolve(db);}
          req.onupgradeneeded=(e)=>{
            const d=e.target.result;
            if(!d.objectStoreNames.contains('foods')) d.createObjectStore('foods',{keyPath:'id'});
            if(!d.objectStoreNames.contains('categories')) d.createObjectStore('categories',{keyPath:'name'});
            if(!d.objectStoreNames.contains('settings')) d.createObjectStore('settings',{keyPath:'key'});
            if(!d.objectStoreNames.contains('folders')) d.createObjectStore('folders',{keyPath:'id'});
            if(!d.objectStoreNames.contains('docs')) d.createObjectStore('docs',{keyPath:'id'});
          }
        }catch(err){console.log('IndexedDB exception',err);isIndexedDBAvailable=false;resolve(null);}
      });
    }

    async function saveToIndexedDB(){
      if(!db) return;
      try{
        const tx=db.transaction(['foods','categories','settings','folders','docs'],'readwrite');
        const foodStore=tx.objectStore('foods');
        const catStore=tx.objectStore('categories');
        const settingsStore=tx.objectStore('settings');
        const folderStore=tx.objectStore('folders');
        const docStore=tx.objectStore('docs');

        await new Promise((res,rej)=>{const r=foodStore.clear();r.onsuccess=res;r.onerror=rej;});
        foods.forEach(f=>foodStore.put(f));

        await new Promise((res,rej)=>{const r=catStore.clear();r.onsuccess=res;r.onerror=rej;});
        categories.forEach(c=>catStore.put({name:c}));

        settingsStore.put({key:'categoryEmojis',value:JSON.parse(JSON.stringify(categoryEmojis))});

        await new Promise((res,rej)=>{const r=folderStore.clear();r.onsuccess=res;r.onerror=rej;});
        folders.forEach(f=>folderStore.put(f));

        await new Promise((res,rej)=>{const r=docStore.clear();r.onsuccess=res;r.onerror=rej;});
        docs.forEach(d=>docStore.put(d));

        await new Promise((res,rej)=>{tx.oncomplete=res;tx.onerror=rej;});
      }catch(err){console.log('saveToIndexedDB error',err);}
    }

    async function loadFromIndexedDB(){
      if(!db) return false;
      try{
        const tx=db.transaction(['foods','categories','settings','folders','docs'],'readonly');
        const foodStore=tx.objectStore('foods'), catStore=tx.objectStore('categories'), settingsStore=tx.objectStore('settings');
        const folderStore=tx.objectStore('folders'), docStore=tx.objectStore('docs');

        const loadedFoods=await new Promise((res,rej)=>{const r=foodStore.getAll();r.onsuccess=()=>res(r.result);r.onerror=rej;});
        const loadedCats=await new Promise((res,rej)=>{const r=catStore.getAll();r.onsuccess=()=>res(r.result);r.onerror=rej;});
        const loadedEmojis=await new Promise((res)=>{const r=settingsStore.get('categoryEmojis');r.onsuccess=()=>res(r.result);r.onerror=()=>res(null);});
        const loadedFolders=await new Promise((res)=>{const r=folderStore.getAll();r.onsuccess=()=>res(r.result||[]);r.onerror=()=>res([]);});
        const loadedDocs=await new Promise((res)=>{const r=docStore.getAll();r.onsuccess=()=>res(r.result||[]);r.onerror=()=>res([]);});

        if(loadedFoods?.length) foods=loadedFoods;
        if(loadedCats?.length) categories=loadedCats.map(c=>c.name).filter(Boolean);
        if(loadedEmojis?.value){Object.keys(categoryEmojis).forEach(k=>delete categoryEmojis[k]);Object.assign(categoryEmojis,loadedEmojis.value);}
        if(loadedFolders?.length) folders=loadedFolders;
        if(loadedDocs?.length) docs=loadedDocs;

        return true;
      }catch(err){console.log('loadFromIndexedDB error',err);return false;}
    }

    // ==================== SW (keep same behavior) ====================
    if('serviceWorker' in navigator){
      const swCode=`
        const CACHE_NAME='nutrition-db-v1';
        const urlsToCache=['./','./index.html'];
        self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(urlsToCache)).then(()=>self.skipWaiting()))});
        self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(names=>Promise.all(names.filter(n=>n!==CACHE_NAME).map(n=>caches.delete(n)))).then(()=>self.clients.claim()))});
        self.addEventListener('fetch',e=>{
          e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(resp=>{
            if(!resp||resp.status!==200) return resp;
            const copy=resp.clone();caches.open(CACHE_NAME).then(c=>c.put(e.request,copy));return resp;
          })))
        });
      `;
      const blob=new Blob([swCode],{type:'application/javascript'});
      navigator.serviceWorker.register(URL.createObjectURL(blob),{scope:'./'}).catch(()=>{});
    }

    // ==================== Dark mode ====================
    if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change',e=>{
      document.documentElement.classList.toggle('dark', !!e.matches);
    });

    // ==================== Data ====================
    const NUTRIENT_META=[
      {key:'calories',label:'kcal',unit:'kcal'},
      {key:'protein',label:'è›‹ç™½è³ª',unit:'g'},
      {key:'fat',label:'è„‚è‚ª',unit:'g'},
      {key:'carbs',label:'ç¢³æ°´',unit:'g'},
      {key:'sodium',label:'éˆ‰',unit:'mg'},
      {key:'calcium',label:'éˆ£',unit:'mg'},
    ];

    const categoryEmojis={
      'å…¨éƒ¨':'','é»å¿ƒ':'ğŸ¥Ÿ','æ°´æœ':'ğŸ','è”¬èœ':'ğŸ¥¬','é£²å“':'ğŸ§‹','å…¶ä»–':'ğŸ“¦'
    };
    let categories=['é»å¿ƒ','æ°´æœ','è”¬èœ','é£²å“','å…¶ä»–'];
    let currentFilter='å…¨éƒ¨';
    let showPer100gSet=new Set();
    let formInputMode='per100g';

    // demo foods only; cloud will overwrite if configured
    let foods=[
      {id:'1',name:'è¦é¤ƒ',nameEn:'Ha-gau',category:'é»å¿ƒ',per100g:{calories:160,protein:6.7,fat:6.7,carbs:18,sodium:400,calcium:27},perServing:{weight:31,calories:50,protein:2.1,fat:2.1,carbs:5.6,sodium:120,calcium:8}},
      {id:'2',name:'é¦™è•‰',nameEn:'Banana',category:'æ°´æœ',per100g:{calories:89,protein:1.1,fat:0.3,carbs:22.8,sodium:1,calcium:5},perServing:{weight:68,calories:61,protein:0.7,fat:0.2,carbs:15.5,sodium:1,calcium:3}},
      {id:'3',name:'è¥¿è˜­èŠ±',nameEn:'Broccoli',category:'è”¬èœ',per100g:{calories:33,protein:3.1,fat:0.5,carbs:4.1,sodium:21,calcium:32},perServing:null},
      {id:'4',name:'å‡æª¸æª¬èŒ¶',nameEn:'Iced Lemon Tea',category:'é£²å“',per100g:{calories:29,protein:0,fat:0,carbs:6.7,sodium:0,calcium:4.6},perServing:null},
    ];

    // folders & docs
    let folders=[{id:'f_default',name:'æœªåˆ†é¡',createdAt:new Date().toISOString()}];
    let docs=[];

    // ==================== Cloud sync (keep your behavior) ====================
    let autoSyncEnabled=false;

    async function loadAppsScriptUrl(){
      if(memorySettings.appsScriptUrl) return memorySettings.appsScriptUrl;
      if(!db) return '';
      try{
        return await new Promise((resolve)=>{
          const tx=db.transaction(['settings'],'readonly');
          const store=tx.objectStore('settings');
          const req=store.get('appsScriptUrl');
          req.onsuccess=()=>resolve(req.result?req.result.value:'');
          req.onerror=()=>resolve('');
        });
      }catch(e){return '';}
    }

    async function saveAppsScriptUrl(){
      const url=document.getElementById('appsScriptUrl').value.trim();
      if(!url) return showToast('è«‹è¼¸å…¥ Google Apps Script ç¶²å€');
      setSheetSyncStatus('<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨æ¸¬è©¦é€£æ¥...', '');
      try{
        const resp=await fetch(url);
        if(!resp.ok) throw new Error('ç„¡æ³•é€£æ¥');
        const data=await resp.json();
        if(!data.success) throw new Error(data.error||'é€£æ¥å¤±æ•—');

        memorySettings.appsScriptUrl=url;
        if(db){
          const tx=db.transaction(['settings'],'readwrite');
          tx.objectStore('settings').put({key:'appsScriptUrl',value:url});
        }
        setSheetSyncStatus('<i class="fas fa-check-circle"></i> é€£æ¥æˆåŠŸï¼', 'success');
        showToast('è¨­å®šå·²å„²å­˜ï¼');
        updateSyncModeIndicator(true);
      }catch(err){
        setSheetSyncStatus('<i class="fas fa-exclamation-circle"></i> '+err.message,'error');
        showToast('é€£æ¥å¤±æ•—');
      }
    }

    async function loadAutoSyncSetting(){
      if(memorySettings.autoSyncEnabled!==undefined) return memorySettings.autoSyncEnabled;
      if(!db) return false;
      try{
        return await new Promise((resolve)=>{
          const tx=db.transaction(['settings'],'readonly');
          const req=tx.objectStore('settings').get('autoSyncEnabled');
          req.onsuccess=()=>resolve(req.result?req.result.value:false);
          req.onerror=()=>resolve(false);
        });
      }catch(e){return false;}
    }

    async function toggleAutoSync(){
      autoSyncEnabled=document.getElementById('autoSyncCheckbox').checked;
      memorySettings.autoSyncEnabled=autoSyncEnabled;
      if(db){
        try{
          const tx=db.transaction(['settings'],'readwrite');
          tx.objectStore('settings').put({key:'autoSyncEnabled',value:autoSyncEnabled});
        }catch(e){}
      }
      showToast(autoSyncEnabled?'å·²å•Ÿç”¨è‡ªå‹•åŒæ­¥':'å·²åœç”¨è‡ªå‹•åŒæ­¥');
      if(autoSyncEnabled) autoUploadIfEnabled();
    }

    async function saveLastSyncTime(){
      if(!db) return;
      const now=new Date().toISOString();
      try{
        const tx=db.transaction(['settings'],'readwrite');
        tx.objectStore('settings').put({key:'lastSyncTime',value:now});
        updateLastSyncDisplay(now);
      }catch(e){}
    }
    async function loadLastSyncTime(){
      if(!db) return null;
      try{
        return await new Promise((resolve)=>{
          const tx=db.transaction(['settings'],'readonly');
          const req=tx.objectStore('settings').get('lastSyncTime');
          req.onsuccess=()=>resolve(req.result?req.result.value:null);
          req.onerror=()=>resolve(null);
        });
      }catch(e){return null;}
    }
    function updateLastSyncDisplay(iso){
      const el=document.getElementById('lastSyncTime');
      if(!el) return;
      if(!iso) return (el.textContent='å¾æœª');
      el.textContent=new Date(iso).toLocaleString('zh-HK');
    }

    function setSheetSyncStatus(message,type){
      const el=document.getElementById('sheetSyncStatus'); if(!el) return;
      el.style.display=message?'block':'none';
      el.innerHTML=message;
      el.style.padding='10px'; el.style.borderRadius='10px';
      el.style.background=type==='success'?'rgba(34,197,94,.1)':type==='error'?'rgba(239,68,68,.1)':'rgba(99,102,241,.1)';
      el.style.color=type==='success'?'#22c55e':type==='error'?'#ef4444':'var(--text-secondary)';
    }

    function updateSyncModeIndicator(connected){
      const el=document.getElementById('syncModeIndicator'); if(!el) return;
      el.innerHTML=connected
        ? '<i class="fas fa-check-circle" style="color:#22c55e;"></i><span style="color:#22c55e;">å·²é€£æ¥é›²ç«¯</span>'
        : '<i class="fas fa-info-circle"></i><span>å°šæœªè¨­å®šé›²ç«¯åŒæ­¥</span>';
    }

    async function syncToCloud(){
      const url=await loadAppsScriptUrl();
      if(!url) return showToast('è«‹å…ˆè¨­å®š Google Apps Script ç¶²å€');
      const btn=document.getElementById('cloudUploadBtn');
      if(btn){btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';}
      setSheetSyncStatus('<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨ä¸Šå‚³åˆ°é›²ç«¯...','');
      try{
        await fetch(url,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({foods,categories,categoryEmojis,folders,docs,lastUpdated:new Date().toISOString()})
        });
        await saveLastSyncTime();
        setSheetSyncStatus('<i class="fas fa-check-circle"></i> ä¸Šå‚³æˆåŠŸï¼','success');
        showToast('å·²ä¸Šå‚³åˆ°é›²ç«¯');
      }catch(e){
        setSheetSyncStatus('<i class="fas fa-exclamation-circle"></i> ä¸Šå‚³å¤±æ•—','error');
        showToast('ä¸Šå‚³å¤±æ•—');
      }finally{
        if(btn){btn.disabled=false;btn.innerHTML='<i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³';}
      }
    }

    async function syncFromCloud(){
      const url=await loadAppsScriptUrl();
      if(!url) return showToast('è«‹å…ˆè¨­å®š Google Apps Script ç¶²å€');
      const btn=document.getElementById('cloudDownloadBtn');
      if(btn){btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> ä¸‹è¼‰ä¸­...';}
      setSheetSyncStatus('<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨å¾é›²ç«¯ä¸‹è¼‰...','');
      try{
        const resp=await fetch(url);
        if(!resp.ok) throw new Error('ç„¡æ³•é€£æ¥');
        const result=await resp.json();
        if(!result.success) throw new Error(result.error||'ä¸‹è¼‰å¤±æ•—');

        const data=result.data||{};
        if(Array.isArray(data.foods) && data.foods.length) foods=data.foods;
        if(Array.isArray(data.categories) && data.categories.length) categories=data.categories;
        if(data.categoryEmojis){Object.keys(categoryEmojis).forEach(k=>delete categoryEmojis[k]);Object.assign(categoryEmojis,data.categoryEmojis);}
        if(Array.isArray(data.folders) && data.folders.length) folders=data.folders;
        if(Array.isArray(data.docs)) docs=data.docs;

        normalizeFoldersDocs();
        renderCategories(); renderCategoryPills(); renderFoodList(document.getElementById('searchInput').value||'');
        saveToIndexedDB(); await saveLastSyncTime();
        setSheetSyncStatus('<i class="fas fa-check-circle"></i> ä¸‹è¼‰æˆåŠŸï¼','success');
        showToast(`å·²å¾é›²ç«¯ä¸‹è¼‰ ${foods.length} æ¬¾é£Ÿç‰©`);
      }catch(err){
        setSheetSyncStatus('<i class="fas fa-exclamation-circle"></i> '+err.message,'error');
        showToast('ä¸‹è¼‰å¤±æ•—');
      }finally{
        if(btn){btn.disabled=false;btn.innerHTML='<i class="fas fa-cloud-download-alt"></i> ä¸‹è¼‰';}
      }
    }

    async function autoUploadIfEnabled(){
      if(!autoSyncEnabled) return;
      const url=await loadAppsScriptUrl();
      if(!url) return;
      try{
        showToast('æ­£åœ¨è‡ªå‹•åŒæ­¥...',1000);
        await fetch(url,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({foods,categories,categoryEmojis,folders,docs,lastUpdated:new Date().toISOString()})
        });
        showToast('å·²è‡ªå‹•åŒæ­¥åˆ°é›²ç«¯ âœ“',1500);
      }catch(e){
        showToast('è‡ªå‹•åŒæ­¥å¤±æ•—',1500);
      }
    }

    async function autoSyncOnLoad(){
      const url=await loadAppsScriptUrl();
      if(url){
        try{
          const resp=await fetch(url);
          if(resp.ok){
            const result=await resp.json();
            if(result.success){
              const data=result.data||{};
              if(Array.isArray(data.foods) && data.foods.length) foods=data.foods;
              if(Array.isArray(data.categories) && data.categories.length) categories=data.categories;
              if(data.categoryEmojis){Object.keys(categoryEmojis).forEach(k=>delete categoryEmojis[k]);Object.assign(categoryEmojis,data.categoryEmojis);}
              if(Array.isArray(data.folders) && data.folders.length) folders=data.folders;
              if(Array.isArray(data.docs)) docs=data.docs;
              normalizeFoldersDocs();
              renderCategories(); renderCategoryPills(); renderFoodList(document.getElementById('searchInput').value||'');
              saveToIndexedDB(); await saveLastSyncTime();
              console.log('Auto-synced from cloud');
            }
          }
        }catch(e){console.log('Auto-sync skipped',e.message);}
      }
      autoSyncEnabled=await loadAutoSyncSetting();
    }

    // ==================== UI basics ====================
    function showToast(message,duration){
      const t=document.getElementById('toast');
      t.textContent=message;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'),duration||2000);
    }

    function toggleMenu(ev){
      if(ev) ev.stopPropagation();
      document.getElementById('dropdownMenu').classList.toggle('show');
    }

    function goToHomePage(){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById('homePage').classList.add('active');
      document.getElementById('fab').style.display='flex';
      document.getElementById('homeBtn').style.display='none';
      document.getElementById('dropdownMenu').classList.remove('show');
    }
    function backToHome(){ goToHomePage(); }

    function showCloudSettings(){
      document.getElementById('dropdownMenu').classList.remove('show');
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById('cloudPage').classList.add('active');
      document.getElementById('fab').style.display='none';
      document.getElementById('homeBtn').style.display='flex';

      setSheetSyncStatus('', '');
      (async()=>{
        const url=await loadAppsScriptUrl();
        document.getElementById('appsScriptUrl').value=url||'';
        updateSyncModeIndicator(!!url);
        updateLastSyncDisplay(await loadLastSyncTime());
        autoSyncEnabled=await loadAutoSyncSetting();
        document.getElementById('autoSyncCheckbox').checked=!!autoSyncEnabled;
      })();
    }

    // ==================== Categories & list ====================
    function renderCategoryPills(){
      const el=document.getElementById('categoryPills');
      const all=['å…¨éƒ¨',...categories.filter(c=>c!=='å…¨éƒ¨')];
      el.innerHTML=all.map(cat=>{
        const emoji=categoryEmojis[cat]||'';
        return `<button class="category-pill ${cat===currentFilter?'active':''}" onclick="filterByCategory('${escapeAttr(cat)}')">
          ${cat!=='å…¨éƒ¨'&&emoji?`<span class="emoji">${emoji}</span>`:''}${cat}
        </button>`;
      }).join('');
    }
    function filterByCategory(cat){
      currentFilter=cat;
      renderCategoryPills();
      renderFoodList(document.getElementById('searchInput').value||'');
    }

    function toggleDisplayMode(ev,foodId){
      if(ev) ev.stopPropagation();
      if(showPer100gSet.has(foodId)){showPer100gSet.delete(foodId);showToast('å·²åˆ‡æ›è‡³æ¯ä»½é¡¯ç¤º');}
      else{showPer100gSet.add(foodId);showToast('å·²åˆ‡æ›è‡³æ¯100gé¡¯ç¤º');}
      renderFoodList(document.getElementById('searchInput').value||'');
    }

    function renderFoodList(searchTerm=''){
      const container=document.getElementById('foodList');
      let list=foods;

      if(currentFilter!=='å…¨éƒ¨') list=list.filter(f=>f.category===currentFilter);
      if(searchTerm){
        const term=searchTerm.toLowerCase();
        list=list.filter(f=>
          (f.name||'').toLowerCase().includes(term) ||
          (f.nameEn||'').toLowerCase().includes(term) ||
          (f.category||'').toLowerCase().includes(term)
        );
      }

      if(!list.length){
        container.innerHTML=`<div style="text-align:center;padding:60px 20px;color:var(--text-secondary)">
          <i class="fas fa-bowl-food" style="font-size:54px;color:var(--text-muted)"></i>
          <div style="font-size:18px;font-weight:700;margin-top:12px;color:var(--text-primary)">æš«ç„¡è³‡æ–™</div>
          <div style="font-size:14px;margin-top:6px">é»æ“Šå³ä¸‹è§’ã€Œ+ã€é–‹å§‹å»ºç«‹</div>
        </div>`;
        return;
      }

      container.innerHTML=list.map(food=>{
        const ps=food.perServing, p100=food.per100g||{};
        const emoji=categoryEmojis[food.category]||'';

        // auto fill perServing from per100g if weight exists
        let filledPs=ps;
        if(ps && ps.weight && p100){
          const w=ps.weight;
          const autoCalc=(psVal,p100Val,dec)=>{
            if(psVal!==null && psVal!==undefined) return psVal;
            if(p100Val===null || p100Val===undefined) return null;
            const r=p100Val*w/100;
            return dec===0?Math.round(r):Math.round(r*10**dec)/10**dec;
          };
          filledPs={
            weight:w,
            calories:autoCalc(ps.calories,p100.calories,0),
            protein:autoCalc(ps.protein,p100.protein,1),
            fat:autoCalc(ps.fat,p100.fat,1),
            carbs:autoCalc(ps.carbs,p100.carbs,1),
            sodium:autoCalc(ps.sodium,p100.sodium,0),
            calcium:autoCalc(ps.calcium,p100.calcium,0),
          };
        }

        const showPer100g=showPer100gSet.has(food.id);
        const hasPerServing=filledPs && filledPs.weight && (filledPs.calories!==null && filledPs.calories!==undefined);
        const hasPer100g=p100 && (p100.calories!==null && p100.calories!==undefined);

        let data,modeText,modeClass;
        if(hasPerServing && hasPer100g){
          data=showPer100g?p100:filledPs;
          modeText=showPer100g?'æ¯100g':(filledPs.weight?`æ¯ä»½ ${filledPs.weight}g`:'æ¯ä»½');
          modeClass=showPer100g?'per100g':'perserving';
        }else if(hasPerServing){
          data=filledPs; modeText=filledPs.weight?`æ¯ä»½ ${filledPs.weight}g`:'æ¯ä»½'; modeClass='perserving';
        }else{
          data=p100; modeText='æ¯100g'; modeClass='per100g';
        }

        const box=(key,cls,label,unitSuffix)=>{
          const v=data?.[key];
          const txt=(v!==null && v!==undefined)? (unitSuffix? (v+unitSuffix): v) : '--';
          return `<div class="nutrition-box ${cls}"><div class="nutrition-value">${txt}</div><div class="nutrition-label">${label}</div></div>`;
        };

        return `<div class="food-card">
          <div class="food-card-header">
            <div>
              <div class="food-name">${escapeHtml(food.name||'')}</div>
              <div class="food-meta">
                <span class="food-category-tag">${emoji?`<span>${emoji}</span>`:''}${escapeHtml(food.category||'')}</span>
                <span class="nutrition-mode-tag ${modeClass}" onclick="toggleDisplayMode(event,'${escapeAttr(food.id)}')" title="é»æ“Šåˆ‡æ›é¡¯ç¤ºæ¨¡å¼">
                  ${modeText} <i class="fas fa-sync-alt"></i>
                </span>
              </div>
            </div>
            <div class="food-card-actions">
              <button class="action-icon-btn" onclick="editFood('${escapeAttr(food.id)}')" title="ç·¨è¼¯"><i class="fas fa-pen"></i></button>
              <button class="action-icon-btn delete" onclick="confirmDeleteFood('${escapeAttr(food.id)}')" title="åˆªé™¤"><i class="fas fa-trash"></i></button>
            </div>
          </div>

          <div class="nutrition-grid" onclick="toggleDisplayMode(event,'${escapeAttr(food.id)}')">
            ${box('calories','cal','KCAL','')}
            ${box('protein','protein','è›‹ç™½è³ª','g')}
            ${box('fat','fat','è„‚è‚ª','g')}
            ${box('carbs','carbs','ç¢³æ°´','g')}
            ${(data?.sodium!==null && data?.sodium!==undefined) ? box('sodium','sodium','éˆ‰ MG','') : ''}
            ${(data?.calcium!==null && data?.calcium!==undefined) ? box('calcium','calcium','éˆ£ MG','') : ''}
          </div>

          <div class="food-footer"><i class="fas fa-info-circle"></i>
            <span>${escapeHtml(food.nameEn||food.name||'')} | ${escapeHtml(food.category||'')}</span>
          </div>
        </div>`;
      }).join('');
    }

    function renderCategories(){
      const select=document.getElementById('foodCategory');
      select.innerHTML=categories.map(c=>`<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join('') + `<option value="__new__">â• æ–°å¢åˆ†é¡...</option>`;
    }
    function renderOpenedDocUI(docId){
      const d=docs.find(x=>x.id===docId); if(!d) return;
      document.getElementById('docViewerTitle').textContent=d.name||'æ–‡ä»¶';
      document.getElementById('docViewerBaseMode').textContent=d.baseMode||'per100g';
      document.getElementById('docViewerNutrients').textContent=(d.nutrients||[]).join(',')||'';
      document.getElementById('docViewerUpdatedAt').textContent=d.updatedAt?new Date(d.updatedAt).toLocaleString('zh-HK'):'';

      const keys=(d.nutrients?.length?d.nutrients:['calories']).filter(k=>NUTRIENT_META.some(n=>n.key===k));
      const snap=Array.isArray(d.snapshot)?d.snapshot:[];
      const header=`<tr><th>é£Ÿç‰©</th>${keys.map(k=>{
        const m=NUTRIENT_META.find(n=>n.key===k);
        return `<th>${escapeHtml(m?.label||k)}</th>`;
      }).join('')}</tr>`;
      const rows=snap.map(f=>{
        const getter=(key)=>{
          if(d.baseMode==='perServing') return f.perServing? (f.perServing[key]??null) : null;
          return f.per100g? (f.per100g[key]??null) : null;
        };
        return `<tr>
          <td><strong>${escapeHtml(f.name||'')}</strong><div class="small">${escapeHtml(f.category||'')}</div></td>
          ${keys.map(k=>{
            const v=getter(k);
            return `<td>${v===null||v===undefined?'--':escapeHtml(String(v))}</td>`;
          }).join('')}
        </tr>`;
      }).join('');
      document.getElementById('docViewerTable').innerHTML=`<table>${header}${rows}</table>`;
    }

    function confirmDeleteDoc(){
      const docId=compareState.openDocId;
      const d=docs.find(x=>x.id===docId); if(!d) return;
      showConfirmModal('åˆªé™¤æ–‡ä»¶ï¼Ÿ',`ç¢ºå®šåˆªé™¤ã€Œ${escapeHtml(d.name||'')}ã€ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`,()=>{
        docs=docs.filter(x=>x.id!==docId);
        saveToIndexedDB();
        closeConfirmModal();
        closeDocViewer();
        renderDocsList();
        showToast('å·²åˆªé™¤æ–‡ä»¶');
      });
    }

    function confirmRefreshDoc(){
      const docId=compareState.openDocId;
      const d=docs.find(x=>x.id===docId); if(!d) return;
      showConfirmModal('æ›´æ–°æ–‡ä»¶å¿«ç…§ï¼Ÿ','æœƒç”¨ç›®å‰è³‡æ–™åº«ä¸­åŒ ID é£Ÿç‰©è¦†è“‹æ–‡ä»¶å¿«ç…§ï¼Œä¸¦åŒæ™‚æ›´æ–° nutrients æ¬„ä½ã€‚',()=>{
        refreshDocSnapshot(docId);
      });
    }

    function refreshDocSnapshot(docId){
      const d=docs.find(x=>x.id===docId);
      if(!d) return;

      const ids=Array.isArray(d.foodIds)&&d.foodIds.length ? d.foodIds
        : (Array.isArray(d.snapshot)? d.snapshot.map(s=>s.id).filter(Boolean):[]);

      if(!ids.length){
        closeConfirmModal(); showToast('æ­¤æ–‡ä»¶æ²’æœ‰ foodIdsï¼Œç„¡æ³•æ›´æ–°å¿«ç…§'); return;
      }

      const latestFoods=ids.map(id=>foods.find(f=>f.id===id)).filter(Boolean);
      if(latestFoods.length<2){
        closeConfirmModal(); showToast('æ‰¾ä¸åˆ°è¶³å¤ é£Ÿç‰©ï¼Œç„¡æ³•æ›´æ–°å¿«ç…§'); return;
      }

      const newSnapshot=latestFoods.map(f=>({
        id:f.id,name:f.name,nameEn:f.nameEn??null,category:f.category,
        per100g:f.per100g??null, perServing:f.perServing??null
      }));

      // --- update nutrients based on new snapshot (per doc baseMode) ---
      const supportedKeys=NUTRIENT_META.map(n=>n.key);
      const getVal=(foodSnap,key)=>{
        if(d.baseMode==='perServing') return foodSnap.perServing ? foodSnap.perServing[key] : null;
        return foodSnap.per100g ? foodSnap.per100g[key] : null;
      };
      const hasAnyValue=(key)=> newSnapshot.some(f=>{
        const v=getVal(f,key);
        return v!==null && v!==undefined && v!==''; // keep 0
      });

      const oldNutrients=Array.isArray(d.nutrients)? d.nutrients.filter(Boolean) : [];
      const kept=oldNutrients.filter(k=>supportedKeys.includes(k)).filter(hasAnyValue);
      const added=supportedKeys.filter(k=>!kept.includes(k)).filter(hasAnyValue);
      const merged=[...kept,...added];
      let finalNutrients=supportedKeys.filter(k=>merged.includes(k));
      if(finalNutrients.length===0){
        finalNutrients = hasAnyValue('calories') ? ['calories'] : (oldNutrients.length?oldNutrients:['calories']);
      }

      d.snapshot=newSnapshot;
      d.foodIds=latestFoods.map(f=>f.id);
      d.nutrients=finalNutrients;
      d.updatedAt=new Date().toISOString();

      saveToIndexedDB();
      closeConfirmModal();
      renderOpenedDocUI(d.id);
      showToast('å·²æ›´æ–°æ–‡ä»¶å¿«ç…§ï¼ˆå«ç‡Ÿé¤Šç´ æ¬„ä½ï¼‰', 2400);
    }

    function exportDocCSV(){
      const docId=compareState.openDocId;
      const d=docs.find(x=>x.id===docId); if(!d) return;
      const keys=(d.nutrients?.length?d.nutrients:['calories']).filter(k=>NUTRIENT_META.some(n=>n.key===k));
      const header=['food','category',...keys].map(csvCell).join(',');
      const lines=[header];
      const snap=Array.isArray(d.snapshot)?d.snapshot:[];
      snap.forEach(f=>{
        const row=[f.name||'',f.category||''];
        keys.forEach(k=>{
          const v=(d.baseMode==='perServing')
            ? (f.perServing? (f.perServing[k]??'') : '')
            : (f.per100g? (f.per100g[k]??'') : '');
          row.push(v===null||v===undefined?'':String(v));
        });
        lines.push(row.map(csvCell).join(','));
      });
      downloadTextFile('\ufeff'+lines.join('\n'),`doc-${(d.name||'doc').replace(/\s+/g,'_')}.csv`,'text/csv;charset=utf-8');
      showToast('å·²åŒ¯å‡ºæ–‡ä»¶ CSV');
    }

    // ==================== CSV utils ====================
    function csvCell(v){
      const s=String(v??'');
      if(/[",\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"';
      return s;
    }
    function downloadTextFile(text,filename,mime){
      const blob=new Blob([text],{type:mime||'text/plain'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
    }

    // ==================== OCR scan (kept, simplified) ====================
    let currentImageFile=null;
    function handleLabelImage(e){
      const file=e.target.files?.[0]; if(!file) return;
      currentImageFile=file;
      const r=new FileReader();
      r.onload=(ev)=>{document.getElementById('scanPreviewImg').src=ev.target.result;document.getElementById('scanPreview').classList.add('show');};
      r.readAsDataURL(file);
      scanNutritionLabel(file);
      e.target.value='';
    }
    function clearScanPreview(){
      document.getElementById('scanPreview').classList.remove('show');
      document.getElementById('scanPreviewImg').src='';
      const s=document.getElementById('scanStatus');
      s.classList.remove('show','success','error'); s.textContent='';
      const btn=document.getElementById('scanLabelBtn');
      btn.classList.remove('scanning');
      btn.querySelector('i').className='fas fa-camera';
      btn.querySelector('span').textContent='æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤';
      currentImageFile=null;
    }
    function setScanStatus(msg,type=''){
      const el=document.getElementById('scanStatus');
      el.textContent=msg;
      el.classList.remove('success','error');
      if(type) el.classList.add(type);
      el.classList.add('show');
    }

    async function scanNutritionLabel(file){
      const btn=document.getElementById('scanLabelBtn');
      btn.classList.add('scanning');
      btn.querySelector('i').className='fas fa-spinner';
      btn.querySelector('span').textContent='è­˜åˆ¥ä¸­...';

      // GitHub Pages path: OCR fallback only
      await scanWithOCR(file,btn);
    }

    // Load Tesseract.js dynamically
    let tesseractLoadPromise=null;
    async function loadTesseract(){
      if(typeof Tesseract!=='undefined') return true;
      if(tesseractLoadPromise) return tesseractLoadPromise;
      tesseractLoadPromise=new Promise((resolve)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
        s.onload=()=>resolve(true);
        s.onerror=()=>resolve(false);
        document.head.appendChild(s);
      });
      return tesseractLoadPromise;
    }

    async function scanWithOCR(file,btn){
      setScanStatus('æ­£åœ¨è¼‰å…¥ OCR å¼•æ“...');
      const loaded=await loadTesseract();
      if(!loaded || typeof Tesseract==='undefined'){
        btn.classList.remove('scanning'); btn.querySelector('i').className='fas fa-camera'; btn.querySelector('span').textContent='æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤';
        setScanStatus('OCR åŠŸèƒ½ç„¡æ³•è¼‰å…¥ï¼ˆéœ€ç¶²çµ¡ï¼‰', 'error');
        return;
      }

      try{
        setScanStatus('æ­£åœ¨è­˜åˆ¥æ–‡å­—...');
        const url=URL.createObjectURL(file);
        const result=await Tesseract.recognize(url,'eng+chi_tra+chi_sim',{logger:m=>{
          if(m.status==='recognizing text'){setScanStatus(`OCR è­˜åˆ¥ä¸­... ${Math.round(m.progress*100)}%`);}
        }});
        URL.revokeObjectURL(url);

        const data=parseNutritionFromOCR(result.data.text||'');
        btn.classList.remove('scanning'); btn.querySelector('i').className='fas fa-camera'; btn.querySelector('span').textContent='æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤';
        if(data){fillFormWithScannedData(data); setScanStatus('âœ“ å·²å¡«å…¥è­˜åˆ¥åˆ°çš„ç‡Ÿé¤Šè³‡æ–™','success');}
        else setScanStatus('ç„¡æ³•è­˜åˆ¥ï¼Œè«‹æ‰‹å‹•è¼¸å…¥','error');
      }catch(err){
        btn.classList.remove('scanning'); btn.querySelector('i').className='fas fa-camera'; btn.querySelector('span').textContent='æ‹æ”/ä¸Šè¼‰ç‡Ÿé¤Šæ¨™ç±¤';
        setScanStatus('OCR å¤±æ•—ï¼š'+err.message,'error');
      }
    }

    function parseNutritionFromOCR(text){
      const data={mode:'per100g',servingWeight:null,calories:null,protein:null,fat:null,carbs:null,sodium:null,calcium:null,name:null,nameEn:null};
      const t=text.replace(/\s+/g,' ').toLowerCase();
      if(/per\s*serv|æ¯ä»½|serving\s*size/.test(t)) data.mode='perServing';

      const grab=(re)=>{const m=text.match(re); return m? parseFloat(String(m[1]).replace(',', '.')):null;};
      data.calories = grab(/(?:ç†±é‡|èƒ½é‡|calories|energy)[^\d]*(\d+(?:[.,]\d+)?)/i);
      data.protein  = grab(/(?:è›‹ç™½è³ª|protein)[^\d]*(\d+(?:[.,]\d+)?)/i);
      data.fat      = grab(/(?:è„‚è‚ª|total\s*fat|fat)[^\d]*(\d+(?:[.,]\d+)?)/i);
      data.carbs    = grab(/(?:ç¢³æ°´|carb|carbohydrate)[^\d]*(\d+(?:[.,]\d+)?)/i);
      data.sodium   = grab(/(?:éˆ‰|sodium)[^\d]*(\d+(?:[.,]\d+)?)/i);
      data.calcium  = grab(/(?:éˆ£|calcium)[^\d]*(\d+(?:[.,]\d+)?)/i);

      const w=grab(/(?:æ¯ä»½|serving\s*size)[^\d]*(\d+(?:[.,]\d+)?)\s*(?:g|å…‹|å…¬å…‹)/i);
      if(w) data.servingWeight=w;

      const has = [data.calories,data.protein,data.fat,data.carbs].some(v=>v!==null && v!==undefined);
      return has?data:null;
    }

    function fillFormWithScannedData(d){
      if(d.mode==='perServing' && d.servingWeight){
        setInputMode('perServing');
        document.getElementById('servingWeight').value=d.servingWeight;
      }else setInputMode('per100g');

      const set=(id,val)=>{ if(val!==null && val!==undefined) document.getElementById(id).value=val; };
      set('caloriesServing',d.calories); set('proteinServing',d.protein); set('fatServing',d.fat); set('carbsServing',d.carbs); set('sodiumServing',d.sodium); set('calciumServing',d.calcium);
    }

    // ==================== AI Import (OCR-centric; simplified) ====================
    let aiImportImageFile=null, aiImportResults=[], textImportMode=false, excelImportData=null;

    function showAIImport(){
      document.getElementById('dropdownMenu').classList.remove('show');
      const sel=document.getElementById('aiImportCategory');
      sel.innerHTML='<option value="">-- é¸æ“‡ç¾æœ‰åˆ†é¡ --</option>'+categories.map(c=>`<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join('');
      document.getElementById('aiNewCategory').value='';
      document.getElementById('aiNewCategoryEmoji').value='';
      document.getElementById('textImportArea').style.display='none';
      document.getElementById('textImportInput').value='';
      textImportMode=false;
      aiImportResults=[];
      aiImportImageFile=null;
      setAIStatus('', 'info', true);
      document.getElementById('aiImportResults').style.display='none';
      document.getElementById('aiAnalyzeBtn').disabled=true;
      document.getElementById('aiConfirmBtn').style.display='none';
      document.getElementById('aiImportModal').classList.add('active');
    }
    function closeAIImportModal(){document.getElementById('aiImportModal').classList.remove('active'); aiImportImageFile=null; aiImportResults=[]; textImportMode=false; excelImportData=null;}

    function toggleTextImport(){
      textImportMode=!textImportMode;
      document.getElementById('textImportArea').style.display=textImportMode?'block':'none';
      document.getElementById('aiAnalyzeBtn').disabled=!textImportMode;
      document.getElementById('aiImportResults').style.display='none';
      document.getElementById('aiConfirmBtn').style.display='none';
    }

    function startAnalysis(){
      if(textImportMode) return analyzeTextInput();
      if(aiImportImageFile) return analyzeWithOCR();
      showToast('è«‹å…ˆé¸æ“‡æª”æ¡ˆæˆ–è²¼ä¸Šæ–‡å­—');
    }

    function setAIStatus(msg,type='info',hide=false){
      const el=document.getElementById('aiImportStatus');
      if(hide || !msg){el.style.display='none'; return;}
      el.style.display='block';
      el.style.background=type==='error'?'rgba(239,68,68,.1)':type==='success'?'rgba(34,197,94,.1)':'rgba(99,102,241,.1)';
      el.style.color=type==='error'?'#ef4444':type==='success'?'#22c55e':'var(--accent)';
      el.innerHTML=msg;
    }

    function handleAIImportImage(e){
      const file=e.target.files?.[0]; if(!file) return;
      aiImportImageFile=file;
      document.getElementById('aiAnalyzeBtn').disabled=false;
      setAIStatus('å·²é¸æ“‡åœ–ç‰‡ï¼Œå¯é–‹å§‹è­˜åˆ¥ã€‚','info');
      document.getElementById('aiConfirmBtn').style.display='none';
    }

    async function analyzeWithOCR(){
      setAIStatus('<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¼‰å…¥ OCR...','info');
      const loaded=await loadTesseract();
      if(!loaded){setAIStatus('ç„¡æ³•è¼‰å…¥ OCRï¼ˆéœ€ç¶²çµ¡ï¼‰','error');document.getElementById('aiAnalyzeBtn').disabled=false;return;}
      try{
        const url=URL.createObjectURL(aiImportImageFile);
        const result=await Tesseract.recognize(url,'eng+chi_tra+chi_sim',{logger:m=>{
          if(m.status==='recognizing text'){setAIStatus(`<i class="fas fa-spinner fa-spin"></i> OCR... ${Math.round(m.progress*100)}%`,'info');}
        }});
        URL.revokeObjectURL(url);
        aiImportResults=parseMultipleFoodsFromOCR(result.data.text||'');
        if(aiImportResults.length){
          displayAIResults(aiImportResults);
          setAIStatus(`âœ… æˆåŠŸè­˜åˆ¥ ${aiImportResults.length} æ¬¾é£Ÿç‰©`,'success');
          document.getElementById('aiConfirmBtn').style.display='block';
        }else{
          setAIStatus('æœªèƒ½è­˜åˆ¥ã€‚å»ºè­°ç”¨ã€Œè²¼ä¸Šæ–‡å­—ã€æ¨¡å¼ã€‚','error');
        }
      }catch(err){
        setAIStatus('OCR å¤±æ•—ï¼š'+err.message,'error');
      }
    }

    function analyzeTextInput(){
      const text=document.getElementById('textImportInput').value.trim();
      if(!text) return setAIStatus('è«‹å…ˆè²¼ä¸Šæ–‡å­—','error');
      aiImportResults=parseTextToFoods(text);
      if(aiImportResults.length){
        displayAIResults(aiImportResults);
        setAIStatus(`âœ… æˆåŠŸè§£æ ${aiImportResults.length} æ¬¾é£Ÿç‰©`,'success');
        document.getElementById('aiConfirmBtn').style.display='block';
      }else setAIStatus('ç„¡æ³•è­˜åˆ¥æ–‡å­—å…§å®¹','error');
    }

    function displayAIResults(data){
      const el=document.getElementById('aiImportResultsList');
      const fv=(v,u)=> (v===null||v===undefined)?'--':(String(v)+(u||''));
      el.innerHTML=data.map(item=>{
        const p=item.per100g||{};
        return `<div class="list-item" style="align-items:flex-start">
          <div style="min-width:0">
            <div class="list-item-title">${escapeHtml(item.name||'')}</div>
            <div class="list-item-sub">æ¯100gï¼š${fv(p.calories,'kcal')}ï½œè›‹ç™½${fv(p.protein,'g')}ï½œè„‚è‚ª${fv(p.fat,'g')}ï½œç¢³æ°´${fv(p.carbs,'g')}</div>
          </div>
        </div>`;
      }).join('');
      document.getElementById('aiImportResults').style.display='block';
    }

    function confirmAIImport(){
      if(!aiImportResults.length) return showToast('æ²’æœ‰å¯åŒ¯å…¥çš„æ•¸æ“š');
      let target=document.getElementById('aiImportCategory').value;
      const newCat=document.getElementById('aiNewCategory').value.trim();
      const newEmoji=document.getElementById('aiNewCategoryEmoji').value.trim();
      if(newCat){
        target=newCat;
        if(!categories.includes(newCat)){categories.push(newCat); if(newEmoji) categoryEmojis[newCat]=newEmoji;}
      }
      if(!target) return showToast('è«‹é¸æ“‡æˆ–è¼¸å…¥åˆ†é¡');

      let maxId=Math.max(...foods.map(f=>parseInt(f.id)||0),0);
      aiImportResults.forEach(item=>{
        maxId++;
        foods.push({id:String(maxId),name:item.name,nameEn:item.nameEn||null,category:target,per100g:item.per100g||{},perServing:item.perServing||null});
      });

      renderCategories(); renderCategoryPills(); renderFoodList(document.getElementById('searchInput').value||'');
      saveToIndexedDB();
      closeAIImportModal();
      showToast(`æˆåŠŸåŒ¯å…¥ ${aiImportResults.length} æ¬¾é£Ÿç‰©åˆ°ã€Œ${target}ã€`);
    }

    function parseTextToFoods(text){
      const foodsOut=[];
      const lines=text.split('\n').map(l=>l.trim()).filter(Boolean);
      for(const line of lines){
        const nums=line.match(/\d+(?:\.\d+)?/g);
        if(!nums||!nums.length) continue;
        const name=line.replace(/\d+(?:\.\d+)?/g,'').trim().replace(/[|ï½œ:ï¼š,ï¼Œ\s]+$/,'').trim();
        if(!name) continue;
        foodsOut.push({
          name, nameEn:null,
          per100g:{
            calories: nums[0]?parseFloat(nums[0]):null,
            protein: nums[1]?parseFloat(nums[1]):null,
            fat: nums[2]?parseFloat(nums[2]):null,
            carbs: nums[3]?parseFloat(nums[3]):null,
            sodium: nums[4]?parseFloat(nums[4]):null,
            calcium: nums[5]?parseFloat(nums[5]):null,
          },
          perServing:null
        });
      }
      return foodsOut;
    }

    function parseMultipleFoodsFromOCR(text){
      // very simple heuristic: lines with >=2 numbers
      const out=[];
      const lines=text.split('\n').map(l=>l.trim()).filter(Boolean);
      for(const line of lines){
        const nums=line.match(/\d+(?:\.\d+)?/g);
        if(!nums || nums.length<2) continue;
        const name=(line.match(/^([^\d]+)/)?.[1]||'').replace(/[|ï½œ:ï¼š,ï¼Œ]/g,'').trim();
        if(!name || name.length<2) continue;
        out.push({
          name, nameEn:null,
          per100g:{
            calories: parseFloat(nums[0]),
            protein: nums[1]?parseFloat(nums[1]):null,
            fat: nums[2]?parseFloat(nums[2]):null,
            carbs: nums[3]?parseFloat(nums[3]):null,
            sodium: nums[4]?parseFloat(nums[4]):null,
            calcium: nums[5]?parseFloat(nums[5]):null
          },
          perServing:null
        });
        if(out.length>=30) break;
      }
      return out;
    }

    // ==================== Apps Script setup modal (kept) ====================
    function showAppsScriptSetup(){
      const scriptCode=`// Google Apps Script ä»£ç¢¼
const SCRIPT_PROP = PropertiesService.getScriptProperties();
function doGet() {
  try {
    const data = SCRIPT_PROP.getProperty('nutritionData');
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      data: data ? JSON.parse(data) : { foods: [], categories: [], categoryEmojis: {}, folders: [], docs: [] }
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ success:false, error: err.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    SCRIPT_PROP.setProperty('nutritionData', JSON.stringify(data));
    return ContentService.createTextOutput(JSON.stringify({ success:true }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ success:false, error: err.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}`;
      const wrap=document.createElement('div');
      wrap.className='modal-overlay active';
      wrap.innerHTML=`
        <div class="modal" style="max-width:95vw;max-height:90vh;">
          <div class="modal-header">
            <span class="modal-title">Google Apps Script è¨­å®šæ•™å­¸</span>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"><i class="fas fa-times"></i></button>
          </div>
          <div class="modal-body" style="max-height:70vh;overflow:auto;">
            <div class="small">æŠŠä¸‹é¢ä»£ç¢¼è²¼åˆ° <span class="mono">script.google.com</span>ï¼Œéƒ¨ç½²ç‚ºç¶²é æ‡‰ç”¨ç¨‹å¼ï¼ˆä»»ä½•äººå¯å­˜å–ï¼‰ï¼Œå†æŠŠç¶²å€è²¼å› Appã€‚</div>
            <pre class="mono" style="white-space:pre-wrap;background:var(--bg-primary);padding:12px;border-radius:12px;margin-top:12px;">${escapeHtml(scriptCode)}</pre>
            <button class="btn primary" style="width:100%;margin-top:12px" onclick="navigator.clipboard.writeText(${JSON.stringify(scriptCode)}).then(()=>showToast('å·²è¤‡è£½ä»£ç¢¼'))">è¤‡è£½ä»£ç¢¼</button>
          </div>
        </div>`;
      document.body.appendChild(wrap);
    }

    // ==================== Escape helpers ====================
    function escapeHtml(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
    function escapeAttr(s){return String(s??'').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

    // ==================== Init ====================
    document.addEventListener('DOMContentLoaded', async ()=>{
      // close dropdown outside
      document.addEventListener('click',(e)=>{ if(!e.target.closest('.header-menu-container')) document.getElementById('dropdownMenu').classList.remove('show'); });

      document.getElementById('searchInput').addEventListener('input',(e)=>renderFoodList(e.target.value||''));
      document.getElementById('foodForm').addEventListener('submit',handleFormSubmit);

      await openDatabase();
      await loadFromIndexedDB();
      normalizeFoldersDocs();

      renderCategories();
      renderCategoryPills();
      renderFoodList();

      // load autoSyncEnabled early
      autoSyncEnabled = await loadAutoSyncSetting();

      // IMPORTANT: keep your original intention (auto sync on load after 1s),
      // but avoid initDB undefined crash.
      setTimeout(autoSyncOnLoad, 1000);
    });

    // Hook into save to auto-upload (keep original behavior)
    const originalSaveToIndexedDB = saveToIndexedDB;
    saveToIndexedDB = async function(){
      await originalSaveToIndexedDB();
      clearTimeout(window.autoUploadTimeout);
      window.autoUploadTimeout = setTimeout(autoUploadIfEnabled, 2000);
    };
    </script>
</body>
</html>